<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punk Voyage Adventures</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@sats-connect/core@latest/dist/bundles/sats-connect.js"></script>
    <style>
        :root {
            --body-bg-image-url: url('https://beige-managing-snail-510.mypinata.cloud/ipfs/bafybeigsu7ak3jbbia6w66slcz2rnk6b6ysundurmgz5etoq6xh23vsbpm');
            --border-color: #000000;
            --text-color: #000000;
            --label-color: #333333; 
            --header-text-color: #333333;
            --game-container-bg: rgba(255, 255, 255, 0.9); 
            --section-bg: rgba(255, 255, 255, 0.8);
            --adventure-block-bg: rgba(255, 255, 255, 0.75);
            --button-bg: #E0E0E0;
            --button-text-color: #000000;
            --button-border: #000000;
            --dropdown-bg: #FFFFFF;
            --twitter-feed-bg: rgba(255, 255, 255, 0.7);
            --highlight-color-pv: #00FF00; 
            --highlight-color-gold: #FFFF00;
            --highlight-color-diamond: #00BFFF; 
            --highlight-color-danger: #FF0000; 
            --highlight-color-connected: #4CAF50;
            --orange-label: #FFA500; 
            --base-font-size: 18px;
            --item-placeholder-boots: #8B4513; --item-placeholder-amulet: #FFD700; 
            --item-placeholder-rucksack: #A9A9A9; --item-placeholder-trinket: #ADD8E6;
            --item-placeholder-armour: #C0C0C0; --item-placeholder-helmet: #A9A9A9;
            --item-placeholder-ring: #B8860B; --item-placeholder-weapon: #778899;
            --item-placeholder-potion2: #90EE90; 
            --item-placeholder-potion3: #FFB6C1;
            --item-placeholder-misc: #DA70D6; 
            --item-placeholder-scroll: #F4A460; 
        }

        body {
            font-family: 'VT323', monospace;
            background-image: var(--body-bg-image-url); 
            background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: fixed; 
            color: var(--text-color); 
            margin: 0; font-size: var(--base-font-size); 
            display: flex; flex-direction: column; 
            align-items: center; min-height: 100vh; box-sizing: border-box; 
            transition: color 0.3s, background-color 0.3s;
        }

        body.dark-mode {
            --border-color: #777777; 
            --text-color: #FFFFFF;
            --label-color: var(--orange-label); 
            --header-text-color: var(--orange-label); 
            --game-container-bg: rgba(20, 20, 20, 0.9); 
            --section-bg: rgba(30, 30, 30, 0.85);
            --adventure-block-bg: rgba(40, 40, 40, 0.8);
            --button-bg: #444444;
            --button-text-color: #FFFFFF;
            --button-border: #666666;
            --dropdown-bg: #333333;
            --twitter-feed-bg: rgba(25, 25, 25, 0.7);
        }
        
        #welcomeScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: var(--body-bg-image-url); 
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat;
            display: flex; 
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 1000; text-align: center; padding: 20px; box-sizing: border-box;
            overflow-y: auto; 
        }
        #welcomeImageLarge {
            display: block;
            margin: 0 auto 20px auto; 
            max-width: 75%; 
            max-height: 55vh; 
            object-fit: contain; 
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        #welcomeMessageContainer { 
            background-color: var(--section-bg); 
            padding: 25px 35px; 
            border-radius: 10px;
            border: 2px solid var(--border-color); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: background-color 0.3s, border-color 0.3s;
            z-index: 1001; 
            width: 100%;
            max-width: 500px; 
        }
        #welcomeMessageContainer p {
            margin-bottom: 20px; font-size: 1.8em; 
            color: var(--label-color); 
            font-weight: bold;
            transition: color 0.3s;
        }
        body.dark-mode #welcomeMessageContainer p { 
             color: var(--orange-label);
        }
         #welcomeConnectWalletBtn { 
            font-family: 'VT323', monospace; font-size: 1.5em; padding: 12px 25px; cursor: pointer; 
            background-color: var(--highlight-color-connected); 
            color: #FFFFFF; 
            border: 2px solid #3c8c3c; 
            border-radius: 5px;
            transition: background-color 0.2s;
            width: auto; 
            margin-top: 10px;
        }
        #welcomeConnectWalletBtn:hover { background-color: #3e8e41; }


        .hidden { display: none !important; }

        #customPopupOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7); z-index: 2000; display: flex; 
            justify-content: center; align-items: center;
        }
        #customPopup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: var(--section-bg); border: 3px solid var(--border-color);
            padding: 25px; border-radius: 10px; z-index: 2001; text-align: center;
            min-width: 350px; max-width: 90%; width: auto; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.4); font-family: 'VT323', monospace;
            color: var(--text-color); box-sizing: border-box;
        }
        #customPopupTitle {
            font-size: 1.8em; margin-top: 0; margin-bottom: 15px;
            color: var(--label-color); 
        }
        #customPopupMessage {
            font-size: 1.1em; margin-bottom: 25px; line-height: 1.6;
            white-space: pre-wrap; text-align: left; 
        }
        #customPopupCloseBtn {
            font-size: 1.2em; padding: 10px 20px; min-width: 100px;
        }

        .game-container { 
            width: 98%; 
            max-width: none; 
            margin: 10px auto; 
            border: 3px solid var(--border-color); 
            padding: 15px; 
            background-color: var(--game-container-bg); 
            box-shadow: 0px 0px 15px rgba(0,0,0,0.5); 
            box-sizing: border-box; 
            display: flex; 
            flex-direction: column; 
            transition: background-color 0.3s, border-color 0.3s; 
        }
        header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 2px solid var(--border-color); margin-bottom: 15px; width: 100%; transition: border-color 0.3s; }
        header h1 { font-size: 2.5em; margin: 0; letter-spacing: 2px; color: var(--header-text-color); transition: color 0.3s; flex-shrink: 0; margin-right: auto; }
        .header-controls { display: flex; align-items: center; gap: 20px; }
        .player-info-wallet { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        .player-stats { text-align: right; font-size: 1em; } 
        .player-stats .pv { color: var(--highlight-color-pv); font-weight: bold; } 
        .player-stats .gold { color: var(--highlight-color-gold); font-weight: bold; } 
        .player-stats .diamond { color: var(--highlight-color-diamond); font-weight: bold; }
        .player-stats .wallet-address { font-size: 0.9em; color: var(--highlight-color-connected); word-break: break-all; }
        .wallet-connector { position: relative; }
        .connect-wallet-btn, .menu-button, .social-btn-link button, .adventure-send-btn, .action-button, .craft-button, .equip-btn, .unequip-btn, .swap-btn, .raffle-action-btn, #logoutButton { background-color: var(--button-bg); border: 2px solid var(--button-border); padding: 6px 12px; color: var(--button-text-color); cursor: pointer; font-family: 'VT323', monospace; font-size: 1em; text-align: center; transition: background-color 0.3s, border-color 0.3s, color 0.3s; }
        .connect-wallet-btn, .menu-button { min-width: 160px; }
        #logoutButton { background-color: var(--highlight-color-danger); color: white; }
        .header-controls .socials-nav { 
            padding: 0; 
            border: none; 
            background-color: transparent; 
            display: flex; 
            align-items: center;
            gap: 10px;
        }
        .header-controls .socials-nav .social-title {
            font-size: 1.1em; 
            margin-bottom: 0; 
        }
        .header-controls .socials-nav .social-buttons {
            gap: 10px; 
            display: flex; 
            align-items: center; 
        }
        .social-icon-link img {
            height: 30px; 
            width: auto;
            vertical-align: middle; 
            border: 1px solid var(--button-border); 
            padding: 3px;
            background-color: var(--button-bg);
            border-radius: 4px;
            transition: filter 0.2s;
        }
         .social-icon-link img:hover {
            filter: brightness(0.85);
         }


        body:not(.dark-mode) .connect-wallet-btn:hover, body:not(.dark-mode) .menu-button:hover, body:not(.dark-mode) .social-btn-link button:hover, body:not(.dark-mode) .adventure-send-btn:hover, body:not(.dark-mode) .action-button:hover, body:not(.dark-mode) .craft-button:hover, body:not(.dark-mode) .equip-btn:hover, body:not(.dark-mode) .unequip-btn:hover, body:not(.dark-mode) .swap-btn:hover, body:not(.dark-mode) .raffle-action-btn:hover, body:not(.dark-mode) #logoutButton:hover { background-color: #cccccc; }
        body.dark-mode .connect-wallet-btn:hover, body.dark-mode .menu-button:hover, body.dark-mode .social-btn-link button:hover, body.dark-mode .adventure-send-btn:hover, body.dark-mode .action-button:hover, body.dark-mode .craft-button:hover, body.dark-mode .equip-btn:hover, body.dark-mode .unequip-btn:hover, body.dark-mode .swap-btn:hover, body.dark-mode .raffle-action-btn:hover, body.dark-mode #logoutButton:hover { background-color: #555555;}
        body:not(.dark-mode) #logoutButton:hover { background-color: #FF3333; }
        body.dark-mode #logoutButton:hover { background-color: #CC0000; }

        .connect-wallet-btn.connected { background-color: var(--highlight-color-connected); color: white; border-color: var(--highlight-color-connected); }
        .wallet-dropdown { display: none; position: absolute; top: 100%; right: 0; background-color: var(--dropdown-bg); color: var(--text-color); border: 2px solid var(--border-color); list-style: none; padding: 0; margin: 5px 0 0 0; width: 100%; z-index: 10; box-shadow: 0px 3px 7px rgba(0,0,0,0.2); transition: background-color 0.3s, border-color 0.3s, color 0.3s; }
        .wallet-dropdown li { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid var(--border-color); text-align: center; transition: background-color 0.3s, border-color 0.3s; } .wallet-dropdown li:last-child { border-bottom: none; }
        body:not(.dark-mode) .wallet-dropdown li:hover { background-color: #f0f0f0; } body.dark-mode .wallet-dropdown li:hover { background-color: #4a4a4a; }
        .main-content { display: flex; gap: 20px; width: 100%; flex-grow: 1; }
        .left-sidebar { width: 300px; display: flex; flex-direction: column; gap: 20px; flex-shrink: 0; }
        .twitter-feed-container { border: 2px solid var(--border-color); padding: 10px; background-color: var(--twitter-feed-bg); height: auto; min-height: 250px; overflow-y: auto; display: flex; flex-direction: column; transition: background-color 0.3s, border-color 0.3s; margin-top: 20px; }
        .twitter-feed-container .twitter-timeline { width: 100% !important; }
        #availableAdventurersDisplay, .materials-display { 
            border: 2px solid var(--border-color); padding: 10px; background-color: var(--section-bg); transition: background-color 0.3s, border-color 0.3s;
        }
        #availableAdventurersDisplay { text-align:center; font-size: 1.2em; } 
        .socials-nav .social-title, .adventure-controls label, .page-title, .materials-display h4, .adventures-label, #activeAdventuresDisplay_page h3, 
        .equipment-slots-container h4, #inventory-page > h4, .shop-section-wrapper h3, .crafting-section-wrapper h3, .swap-section h3, #whitelist-page h3, #adminRafflePanel h3 { 
            color: var(--label-color); font-weight: bold; transition: color 0.3s; 
        }
        .materials-display h4 {font-size: 1.2em; margin-top:0; margin-bottom: 8px;} .materials-display ul { list-style: none; padding: 0; margin: 5px 0 0 0; font-size: 1em; } .materials-display li { margin-bottom: 3px; }
        .main-content-area { flex-grow: 1; display: flex; }
        .page-content { display: none; width: 100%; flex-direction: column; padding: 0 15px; box-sizing: border-box; overflow-y: auto; flex-grow: 1;} 
        .page-content.active { display: flex; }

        #adventures-page { flex-direction: row; align-items: flex-start; gap: 25px; padding:0; }
        .player-character-area { flex-shrink: 0; margin-top: 15px; } .player-character { width: 90px; height: 90px; background-image: url('https://beige-managing-snail-510.mypinata.cloud/ipfs/bafkreige4cba5c3bwwknrhupt3upkz5he7orgz2m7ygilbqmhmb2bsmd5q'); background-size: contain; background-position: center; background-repeat: no-repeat; }
        .adventure-section-wrapper { display: flex; flex-direction: column; flex-grow: 1; align-items: center; } .adventures-label { font-size: 2em; margin-bottom: 20px; text-align: center; width: 100%; }
        .adventure-locations { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .adventure { display: flex; align-items: center; gap: 20px; width: 100%; max-width: 800px; background-color: var(--adventure-block-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); box-sizing: border-box; transition: background-color 0.3s, border-color 0.3s; position: relative; }
        
        .adventure-lock-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(30, 30, 30, 0.85); 
            color: var(--highlight-color-danger);
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 1.1em; 
            font-weight: bold;
            padding: 15px;
            box-sizing: border-box;
            border-radius: 8px; 
            z-index: 5; 
            line-height: 1.4;
        }
        .adventure-lock-overlay.hidden {
            display: none;
        }
        .adventure.locked-by-progression .adventure-send-btn,
        .adventure.locked-by-progression .adventure-num-select {
            filter: grayscale(100%) opacity(0.7);
            cursor: not-allowed !important; 
        }


        .adventure-icon { width: 150px; height: 150px; border: 2px solid var(--border-color); background-size: cover; background-position: center; background-repeat: no-repeat; flex-shrink: 0; border-radius: 5px; transition: border-color 0.3s; }
        .adventure-icon.tree { background-image: url('https://beige-managing-snail-510.mypinata.cloud/ipfs/bafybeiblzgkncylseo57qr7kyhsxdgb3bq2aghcmj6gdf2ihhagpxp3uoy/adventure1.png'); } 
        .adventure-icon.mountain { background-image: url('https://beige-managing-snail-510.mypinata.cloud/ipfs/bafybeiblzgkncylseo57qr7kyhsxdgb3bq2aghcmj6gdf2ihhagpxp3uoy/adventure2.png'); } 
        .adventure-icon.fire-fields { background-image: url('https://beige-managing-snail-510.mypinata.cloud/ipfs/bafybeiblzgkncylseo57qr7kyhsxdgb3bq2aghcmj6gdf2ihhagpxp3uoy/adventure3.png'); }
        .adventure-icon.tomb { background-image: url('https://beige-managing-snail-510.mypinata.cloud/ipfs/bafybeignh3fvjn5cxire5d52foozgud23boulezgssmw6egepvoty5vk3q'); }
        .adventure-main-info { flex-grow: 1; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; } 
        .adventure-content { display: flex; flex-direction: column; gap: 10px; } 
        .adventure-details { font-size: 1.1em; line-height: 1.5; } 
        .adventure-details .prize { color: var(--highlight-color-pv); font-weight: bold; } 
        .adventure-details .chance-gold { color: var(--highlight-color-gold); font-weight: bold; } 
        .adventure-details .chance-diamond { color: var(--highlight-color-diamond); font-weight: bold; }
        .adventure-requirement { color: var(--highlight-color-danger); font-weight: bold; font-size: 0.9em; margin-top: 5px;}
        .adventure-controls { display: flex; align-items: center; gap: 12px; margin-top: 10px; } 
        .adventure-controls label { font-size: 1.1em; } 
        .adventure-num-select { font-family: 'VT323', monospace; font-size: 1em; padding: 4px; border: 2px solid var(--border-color); background-color: var(--dropdown-bg); color: var(--text-color); min-width: 40px; transition: background-color 0.3s, border-color 0.3s, color 0.3s; } 
        .adventure-send-btn { padding: 6px 10px; font-size: 1em; } 
        .adventure-send-btn.active-adv1 { background-color: var(--highlight-color-pv); color: black;} 
        .adventure-send-btn.active-adv2 { background-color: var(--highlight-color-gold); color: black;} 
        .adventure-send-btn.active-adv3, .adventure-send-btn.active-adv4 { background-color: var(--highlight-color-danger); color: white;}
        
        .adventure-drops-area { position: relative; align-self: flex-start; min-height: 100px; } 
        .adventure-drops-button { font-size: 1em; padding: 4px 10px; } 
        .drops-popover { 
            display: none; 
            position: absolute; 
            top: calc(100% + 5px); 
            left: 50%; 
            transform: translateX(-50%); 
            background-color: var(--section-bg); 
            border: 1px solid var(--border-color); 
            padding: 10px; 
            border-radius: 5px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
            z-index: 20; 
            width: 220px; 
            min-width: 180px;
            font-size: 1em; 
            text-align: left;
            transition: background-color 0.3s, border-color 0.3s; 
        } 
        .drops-popover h5 { margin: 0 0 5px 0; color: var(--label-color); transition: color 0.3s;} 
        .drops-popover ul { list-style: none; padding: 0; margin: 0; } 
        .drops-popover li { margin-bottom: 3px; }
        
        #active-adventures-page .active-adventures-container { margin-top: 0; width:100%; max-width:none; padding: 10px; border: none; background-color: transparent; box-shadow:none; }
        #active-adventures-page .active-adventures-container h3 { font-size: 1.6em; text-align:left; margin-bottom:10px;}
        #active-adventures-page .active-adventure-item { font-size:1em; padding:10px; background-color: var(--adventure-block-bg); border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 8px;}
        #active-adventures-page .active-adventure-item p { margin: 4px 0; font-size: 1.1em; line-height: 1.6; }
        
        .right-sidebar-menu { width: 300px; flex-shrink: 0; display: flex; flex-direction: column; gap: 0; border: 2px solid var(--border-color); background-color: var(--section-bg); padding: 10px; box-sizing: border-box; transition: background-color 0.3s, border-color 0.3s; }
        .right-sidebar-menu .menu-button-container-fixed { text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .right-sidebar-menu .menu-button { min-width: auto; width: 85%; padding: 10px 15px; font-size: 1.4em; }
        .sidebar-content-area { flex-grow: 1; overflow-y: auto; }
        .main-menu-nav-list { list-style: none; padding: 0; margin: 0; }
        .main-menu-nav-list li { padding: 12px 8px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: border-color 0.3s, background-color 0.3s; font-size: 1.25em; text-align: center; }
        .main-menu-nav-list li:last-child { border-bottom: none; } body:not(.dark-mode) .main-menu-nav-list li:hover { background-color: #f0f0f0; } body.dark-mode .main-menu-nav-list li:hover { background-color: #4a4a4a; }
        
        .sidebar-active-adventures-container { padding-top: 10px; } 
        .sidebar-active-adventures-container h3 { font-size: 1.3em; text-align: center; margin-bottom: 10px; color: var(--label-color); }
        .sidebar-active-adventures-container .active-adventure-item { font-size: 0.95em; padding: 8px; margin-bottom: 8px; background-color: var(--adventure-block-bg); border: 1px solid var(--border-color); border-radius: 4px; }
        .sidebar-active-adventures-container .active-adventure-item p { margin: 3px 0; }

        .active-potions-display { padding-top: 15px; margin-top: 15px; border-top: 1px solid var(--border-color); }
        .active-potions-display h4 { font-size: 1.3em; text-align: center; margin-bottom: 10px; color: var(--label-color); }
        .active-potions-display .potion-item { font-size: 0.95em; padding: 8px; margin-bottom: 8px; background-color: var(--adventure-block-bg); border: 1px solid var(--border-color); border-radius: 4px; }
        .active-potions-display .potion-item p { margin: 3px 0; }

        .dark-mode-switch { display: flex; align-items: center; gap: 8px; } .dark-mode-switch label { font-size: 1em; color: var(--text-color); cursor: pointer; transition: color 0.3s; } .switch { position: relative; display: inline-block; width: 50px; height: 24px; } .switch input { opacity: 0; width: 0; height: 0; } .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; } .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; } input:checked + .slider { background-color: var(--highlight-color-connected); } input:focus + .slider { box-shadow: 0 0 1px var(--highlight-color-connected); } input:checked + .slider:before { transform: translateX(26px); }
        .page-title { font-size: 2.2em; margin-bottom: 25px; text-align:center; width:100%; }
        
        #shop-page { align-items: center; } 
        .swap-section-container { 
            width: 100%; max-width: 800px; 
            margin-bottom: 30px; 
            padding: 20px; 
            border: 2px solid var(--border-color);
            background-color: var(--section-bg);
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15); 
        }
        .swap-section h3 { font-size: 1.8em; text-align: center; margin-bottom: 15px; }
        .shop-section-wrapper, .crafting-section-wrapper { width: 100%; max-width: 800px; margin-bottom:30px;} .shop-section-wrapper h3, .crafting-section-wrapper h3 { font-size: 1.8em; text-align: center; margin-bottom: 20px; }
        .quest-list, .shop-items, .crafting-items-container, .inventory-items-container { display: flex; flex-direction: column; gap: 18px; width:100%; max-width:800px; margin:0 auto; }
        .quest-item, .shop-item, .craftable-item-card, .inventory-item-card { background-color: var(--adventure-block-bg); border: 1px solid var(--border-color); padding: 18px; border-radius: 8px; display: flex; align-items: center; transition: background-color 0.3s, border-color 0.3s; gap: 15px; }
        .quest-item p, .shop-item p, .craftable-item-card p, .inventory-item-card p { font-size: 1.05em; margin:3px 0; }
        .quest-item .quest-reward, .shop-item .shop-price, .craftable-item-card .crafting-cost, .inventory-item-card .item-type { margin-left: auto; white-space: nowrap; text-align: right; }
        .shop-item .shop-price { color: var(--highlight-color-pv); } .action-button { padding: 6px 12px; font-size: 0.9em; } .help-content p { font-size: 1.05em; margin-bottom: 10px; line-height: 1.6; }
        .item-icon-placeholder { width: 45px; height: 45px; border: 1px solid var(--border-color); border-radius: 4px; margin-right: 10px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 0.7em; background-color: #555; color: white; }
        .craftable-item-card .item-info, .inventory-item-card .item-info { flex-grow: 1; }
        .crafting-cost small, .item-perk small { display: block; font-size: 0.9em; opacity: 0.8; }
        .equip-btn, .unequip-btn { font-size: 0.9em; padding: 4px 8px; margin-left: 5px; }
        .inventory-item-card .equipped-status { font-size: 0.9em; color: var(--highlight-color-connected); margin-left: 10px; }
        .inventory-item-card .use-btn { font-size: 0.9em; padding: 4px 8px; margin-left: 10px; background-color: var(--highlight-color-pv); color: black;}

        .equipment-slots-container { margin-bottom: 30px; padding: 15px; border: 1px dashed var(--border-color); border-radius: 5px; width: 100%; max-width: 800px; box-sizing: border-box; margin-left:auto; margin-right:auto; }
        .equipment-slots-container h4 { margin-top: 0; margin-bottom: 15px; text-align: center; color: var(--label-color); font-size: 1.8em; }
        .equipment-slots { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; } 
        .equipment-slot { border: 1px solid var(--border-color); background-color: var(--adventure-block-bg); padding: 10px; border-radius: 4px; text-align: center; min-height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: background-color 0.3s, border-color 0.3s; }
        .equipment-slot.locked { background-color: #555; opacity:0.6; cursor:not-allowed; }
        .equipment-slot.locked .slot-name::after { content: " (Locked)"; font-size: 0.8em; color: var(--highlight-color-danger); }
        .equipment-slot .slot-name { font-size: 1em; margin-bottom: 8px; color: var(--label-color); font-weight:normal; }
        .equipment-slot .item-icon-placeholder { margin-bottom: 5px; width: 40px; height: 40px; font-size: 0.7em; }
        .equipment-slot .equipped-item-name { font-size: 0.95em; font-weight: bold; margin-bottom: 5px; }
        .equipment-slot .empty-slot-text { font-size: 0.9em; opacity: 0.7; }
        #inventory-page > h4 { font-size: 1.8em; color: var(--label-color); margin-top: 25px; margin-bottom: 15px; text-align: center; width: 100%; max-width: 800px; margin-left:auto; margin-right:auto; }
        #daily-rewards-page .rewards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 20px; }
        #daily-rewards-page .reward-day { border: 1px solid var(--border-color); background-color: var(--adventure-block-bg); padding: 10px; border-radius: 5px; text-align: center; }
        #daily-rewards-page .reward-day h5 { margin: 0 0 5px 0; color: var(--label-color); }
        #daily-rewards-page .reward-day p { margin: 0; font-size: 0.9em; }
        #daily-rewards-page .reward-day button { margin-top: 8px; }

        .swap-section { margin-top:10px; text-align: center;} 
        .swap-section .swap-info { margin-bottom: 10px; font-size: 1.1em; }
        .swap-btn { padding: 8px 15px; font-size: 1.1em; }

        /* Whitelist Page Styles */
        #whitelist-page { align-items: center; } 
        #adminRafflePanel {
            background-color: var(--section-bg);
            padding: 20px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 30px;
            width: 100%;
            max-width: 700px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        }
        #adminRafflePanel h3 { text-align: center; margin-bottom: 15px; font-size: 1.6em; }
        .admin-form-group { margin-bottom: 12px; }
        .admin-form-group label { display: block; margin-bottom: 5px; font-size: 1.1em; color: var(--label-color); }
        .admin-form-group input[type="text"],
        .admin-form-group input[type="number"],
        .admin-form-group textarea {
            width: calc(100% - 20px);
            padding: 8px;
            font-family: 'VT323', monospace;
            font-size: 1em;
            border: 1px solid var(--border-color);
            background-color: var(--dropdown-bg);
            color: var(--text-color);
            border-radius: 4px;
        }
        .admin-form-group textarea { min-height: 60px; }

        #whitelistRafflesContainer {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 800px;
        }
        .raffle-card {
            background-color: var(--adventure-block-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        .raffle-card-image {
            width: 120px;
            height: 120px;
            background-size: cover;
            background-position: center;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            flex-shrink: 0;
        }
        .raffle-card-image.placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #555;
            color: white;
            font-size: 0.9em;
        }
        .raffle-card-content { flex-grow: 1; }
        .raffle-card-content h4 { margin: 0 0 10px 0; font-size: 1.5em; color: var(--label-color); }
        .raffle-card-content p { margin: 5px 0; font-size: 1em; line-height: 1.5; }
        .raffle-card-description { margin-bottom: 10px !important; }
        .raffle-card-socials a { margin-right: 10px; text-decoration: none; color: var(--highlight-color-connected); font-weight: bold; }
        .raffle-card-socials a:hover { text-decoration: underline; }
        .raffle-card-cost { margin-top: 10px; font-size: 0.95em; }
        .raffle-card-cost .pv { color: var(--highlight-color-pv); }
        .raffle-card-cost .gold { color: var(--highlight-color-gold); }
        .raffle-card-cost .diamond { color: var(--highlight-color-diamond); }
        .raffle-card-status { margin-top: 10px; font-weight: bold; }
        .raffle-card-winners ul { list-style: disc; padding-left: 20px; margin-top: 5px;}
        .raffle-admin-actions button { margin-right: 10px; margin-top:5px; }

    </style>
</head>
<body>
    <div id="welcomeScreen">
        <img id="welcomeImageLarge" src="https://beige-managing-snail-510.mypinata.cloud/ipfs/bafybeiblrc356d6jb72bgbxmo475c7si4ae5gmugw3nlb2citjiz4jzibm" alt="Punk Voyage Adventures Welcome">
        <div id="welcomeMessageContainer"> 
            <p>Connect Your Ordinals Wallet to Begin Your Voyage!</p>
            <button id="welcomeConnectWalletBtn">Connect Wallet & Enter</button> 
        </div>
    </div>
    <div class="game-container hidden" id="gameContainer">
        <header> 
            <h1>PUNK VOYAGE ADVENTURES</h1> 
            <div class="header-controls"> 
                <div class="player-info-wallet"> 
                    <div class="player-stats" id="playerStats"> PLAYER <span id="playerNicknameDisplay">Voyager</span>, WELCOME<br> <span class="pv">PV = <span id="pvCount">0</span></span> , <span class="gold">GOLD = <span id="goldCount">0</span></span>, <span class="diamond">DIAMOND = <span id="diamondCount">0</span></span> <div class="wallet-address" id="walletAddressDisplay"></div> 
                    </div> 
                    <div class="wallet-connector"><button class="connect-wallet-btn" id="connectWalletBtn">CONNECT WALLET</button><ul class="wallet-dropdown" id="walletDropdown"><li data-wallet="satsconnect_xverse">XVERSE</li><li data-wallet="unisat">UNISAT</li><li data-wallet="satsconnect_magiceden">MAGIC EDEN</li><li data-wallet="satsconnect_general">ANY BTC WALLET</li></ul>
                    </div> 
                </div> 
                <nav class="socials-nav" id="headerSocialsNav"> 
                    <div class="social-title">SOCIALS</div> 
                    <div class="social-buttons"> 
                        <a href="https://x.com/nvart_" target="_blank" class="social-icon-link">
                            <img src="https://beige-managing-snail-510.mypinata.cloud/ipfs/bafkreic6eqw6jyae55x3uhqtvrbt2woamgifhtck5vquluwlwvl2yhjj7q" alt="X/Twitter">
                        </a> 
                        <a href="https://discord.com/invite/4CEtXAFf3x" target="_blank" class="social-icon-link">
                            <img src="https://beige-managing-snail-510.mypinata.cloud/ipfs/bafkreidjwxzcb5qeb76qjgo4ft5ha3fuskaxkeho7ppv7umoc5ihm5ohwq" alt="Discord">
                        </a> 
                        <a href="https://magiceden.io/tr/ordinals/marketplace/punkvoyage" target="_blank" title="Punk Voyage on Magic Eden" class="social-icon-link">
                            <img src="https://beige-managing-snail-510.mypinata.cloud/ipfs/bafkreihixbhp2x6w7w5odpo5zyt2dbqdd54f3eepgvmt3zsfg7ax6jnftu" alt="Magic Eden">
                        </a>
                    </div> 
                </nav>
                <button id="logoutButton" class="hidden">Disconnect</button>
                <div class="dark-mode-switch"> 
                    <label for="darkModeToggle">Dark Mode</label> 
                    <label class="switch"> <input type="checkbox" id="darkModeToggle"> <span class="slider"></span> </label> 
                </div> 
            </div> 
        </header>
        <main class="main-content">
            <aside class="left-sidebar"> 
                <div id="availableAdventurersDisplay"> Available Adventurers: <span id="availableAdventurersCount">5</span> </div> 
                <div class="materials-display" id="materialsDisplay"> <h4>MY MATERIALS</h4> <ul id="materialsList"></ul> </div> 
                <div class="twitter-feed-container" id="twitter-widget-container"> <a class="twitter-timeline" data-dnt="true" href="https://twitter.com/nvart_?ref_src=twsrc%5Etfw">Tweets by nvart_</a> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> </div> 
            </aside>
            <div class="main-content-area">
                <section id="adventures-page" class="page-content active"> 
                    <div class="player-character-area"> <div class="player-character" aria-label="Player Character Image"></div> </div> 
                    <div class="adventure-section-wrapper"> 
                        <h2 class="adventures-label">ADVENTURES</h2> 
                        <div class="adventure-locations"> 
                            <div class="adventure" id="adventure-1-block"> 
                                <div class="adventure-lock-overlay hidden"></div>
                                <div class="adventure-icon tree"></div> 
                                <div class="adventure-main-info"> <div class="adventure-content"> <div class="adventure-details"> ADVENTURE 1, SPIRIT FOREST<br> ADVENTURE TIME = 4 HOURS<br> <span class="prize">PRIZE = 25 PV TOKENS</span> </div> <div class="adventure-controls"> <label for="num-adventurers-1">ADVENTURERS:</label> <select id="num-adventurers-1" class="adventure-num-select"> <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5" selected>5</option> </select> <button class="adventure-send-btn active-adv1" data-adventure-id="1" data-adventure-name="Spirit Forest" data-duration-hours="4" data-pv-reward="25" data-gold-chance="0">SEND</button> </div> </div> <div class="adventure-drops-area"> <button class="adventure-drops-button" data-adventure-id="1">DROPS</button> <div class="drops-popover" id="drops-popover-1"></div>  </div> </div> 
                            </div> 
                            <div class="adventure" id="adventure-2-block"> 
                                <div class="adventure-lock-overlay hidden"></div>
                                <div class="adventure-icon mountain"></div> <div class="adventure-main-info"> <div class="adventure-content"> <div class="adventure-details"> ADVENTURE 2, MOUNTAIN OF THE MAROWAN<br> ADVENTURE TIME = 8 HOURS<br> <span class="prize">PRIZE = 40 PV TOKENS</span> </div> <div class="adventure-controls"> <label for="num-adventurers-2">ADVENTURERS:</label> <select id="num-adventurers-2" class="adventure-num-select"> <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5" selected>5</option> </select> <button class="adventure-send-btn active-adv2" data-adventure-id="2" data-adventure-name="Mountain of the Marowan" data-duration-hours="8" data-pv-reward="40" data-gold-chance="0">SEND</button> </div> </div> <div class="adventure-drops-area"> <button class="adventure-drops-button" data-adventure-id="2">DROPS</button> <div class="drops-popover" id="drops-popover-2"></div>  </div> </div> 
                            </div> 
                            <div class="adventure" id="adventure-3-block"> 
                                <div class="adventure-lock-overlay hidden"></div>
                                <div class="adventure-icon fire-fields"></div> <div class="adventure-main-info"> <div class="adventure-content"> <div class="adventure-details"> ADVENTURE 3, FIRE FIELDS OF FLYINALS<br> ADVENTURE TIME = 24 HOURS<br> <span class="prize">PRIZE = 100 PV TOKENS</span><br> <span class="chance-gold">%1 CHANCE OF GOLD</span> <div class="adventure-requirement">Requires: 2 Adventurers (Simulated)</div> </div> <div class="adventure-controls"> <label for="num-adventurers-3">ADVENTURERS:</label> <select id="num-adventurers-3" class="adventure-num-select"> <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5" selected>5</option> </select> <button class="adventure-send-btn active-adv3" data-adventure-id="3" data-adventure-name="Fire Fields of Flyinals" data-duration-hours="24" data-pv-reward="100" data-gold-chance="0.01" data-adventurer-requirement="2">SEND</button> </div> </div> <div class="adventure-drops-area"> <button class="adventure-drops-button" data-adventure-id="3">DROPS</button> <div class="drops-popover" id="drops-popover-3"></div>  </div> </div> 
                            </div>
                            <div class="adventure" id="adventure-4-block"> 
                                <div class="adventure-lock-overlay hidden"></div>
                                <div class="adventure-icon tomb"></div> <div class="adventure-main-info"> <div class="adventure-content"> <div class="adventure-details"> ADVENTURE 4, TOMB OF THE DEATH RIDERS<br> ADVENTURE TIME = 168 HOURS (1 WEEK)<br> <span class="prize">PRIZE = 700 PV TOKENS</span><br> <span class="chance-gold">5% CHANCE OF GOLD</span><br> <span class="chance-diamond">1% CHANCE OF DIAMOND</span><div class="adventure-requirement">Requires: 5 Adventurers (Simulated)</div></div> <div class="adventure-controls"> <label for="num-adventurers-4">ADVENTURERS:</label> <select id="num-adventurers-4" class="adventure-num-select"> <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5" selected>5</option> </select> <button class="adventure-send-btn active-adv4" data-adventure-id="4" data-adventure-name="Tomb of the Death Riders" data-duration-hours="168" data-pv-reward="700" data-gold-chance="0.05" data-diamond-chance="0.01" data-adventurer-requirement="5">SEND</button> </div> </div> <div class="adventure-drops-area"> <button class="adventure-drops-button" data-adventure-id="4">DROPS</button> <div class="drops-popover" id="drops-popover-4"></div>  </div> </div> 
                            </div>
                        </div> 
                    </div> 
                </section>
                <section id="quests-page" class="page-content"> <h2 class="page-title">QUESTS</h2> <div class="quest-list" id="questList"> </div> </section>
                <section id="daily-rewards-page" class="page-content"> <h2 class="page-title">DAILY LOGIN REWARDS</h2> <div class="rewards-grid" id="dailyRewardsGrid"> </div> </section>
                <section id="shop-page" class="page-content"> 
                    <h2 class="page-title">SHOP & CRAFTING</h2> 
                    <div class="swap-section-container"> <div class="swap-section"><h3>Currency Swap</h3> <div class="swap-info">50 <span class="gold">GOLD</span> = 1 <span class="diamond">DIAMOND</span></div> <button id="swapGoldToDiamondBtn" class="action-button swap-btn">Swap</button> </div></div>
                    <div class="shop-section-wrapper"> <h3 >Buy Items</h3> <div class="shop-items" id="shopItems"></div> </div> 
                    <div class="crafting-section-wrapper"> <h3 >Craft Items</h3> <div class="crafting-items-container" id="craftingItemsContainer"> </div> </div> 
                </section>
                <section id="inventory-page" class="page-content"> <h2 class="page-title">INVENTORY</h2> <div class="equipment-slots-container"> <h4 >EQUIPPED ITEMS</h4> <div class="equipment-slots" id="equipmentSlotsDisplay"> </div> </div> <h4 >My Items</h4> <div class="inventory-items-container" id="inventoryItemsContainer"> </div> </section>
                <section id="whitelist-page" class="page-content">
                    <h2 class="page-title">WHITELIST RAFFLES</h2>
                    <div id="adminRafflePanel" class="hidden">
                        <h3>Create New Raffle</h3>
                        <form id="createRaffleForm">
                            <div class="admin-form-group">
                                <label for="raffleName">Raffle Name:</label>
                                <input type="text" id="raffleName" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="raffleDescription">Description:</label>
                                <textarea id="raffleDescription" required></textarea>
                            </div>
                            <div class="admin-form-group">
                                <label for="raffleImageUrl">Image URL:</label>
                                <input type="text" id="raffleImageUrl" placeholder="https://example.com/image.png">
                            </div>
                            <div class="admin-form-group">
                                <label for="raffleSocialX">Project X/Twitter URL:</label>
                                <input type="text" id="raffleSocialX" placeholder="https://x.com/project">
                            </div>
                            <div class="admin-form-group">
                                <label for="raffleSocialDiscord">Project Discord URL:</label>
                                <input type="text" id="raffleSocialDiscord" placeholder="https://discord.gg/project">
                            </div>
                            <div class="admin-form-group">
                                <label for="raffleCostPV">Cost (PV Tokens):</label>
                                <input type="number" id="raffleCostPV" value="0" min="0">
                            </div>
                            <div class="admin-form-group">
                                <label for="raffleCostGold">Cost (Gold):</label>
                                <input type="number" id="raffleCostGold" value="0" min="0">
                            </div>
                            <div class="admin-form-group">
                                <label for="raffleCostDiamonds">Cost (Diamonds):</label>
                                <input type="number" id="raffleCostDiamonds" value="0" min="0">
                            </div>
                             <div class="admin-form-group">
                                <label for="raffleDurationHours">Duration (Hours - game time):</label>
                                <input type="number" id="raffleDurationHours" value="24" min="1" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="raffleMaxWinners">Number of Winners:</label>
                                <input type="number" id="raffleMaxWinners" value="1" min="1" required>
                            </div>
                            <button type="submit" class="action-button">Create Raffle</button>
                        </form>
                    </div>
                    <div id="whitelistRafflesContainer">
                        <!-- Raffles will be dynamically inserted here -->
                    </div>
                </section>
                <section id="help-page" class="page-content"> <h2 class="page-title">HELP</h2> <div class="help-content"> <p>Welcome to Punk Voyage Adventures!</p>  <p><strong>Objective:</strong> Send your adventurers on exciting quests to earn PV Tokens and Gold, and gather materials to craft powerful items.</p> <p><strong>How to Play:</strong></p> <ul> <li>Connect your Ordinals Wallet to start or continue your voyage. Your game progress is saved to the cloud, linked to your wallet address.</li> <li>The game defaults to Dark Mode. Use the toggle in the header to switch to Light Mode.</li> <li>Use the right-hand menu to navigate between Adventures, Quests, Shop/Crafting, Inventory, etc.</li> <li>On the ADVENTURES page, select an adventure, choose the number of adventurers, and click SEND. Some adventures require a certain number of adventurers (simulated). Adventures may also require completion of previous adventure series (e.g., complete Adventure 1 series 5 times to unlock Adventure 2).</li> <li>Hover over the "DROPS" button on adventures to see potential materials.</li><li>Active adventures and potions are displayed in the right sidebar.</li> <li>Your adventurers will return after the specified time, bringing rewards and possibly materials. Potions provide timed or counted buffs.</li> <li>Use collected materials to CRAFT items in the Shop & Crafting page. You cannot craft an item if you already own it.</li> <li>View and EQUIP/UNEQUIP your crafted items from the INVENTORY page. Equipped items provide passive bonuses. Certain items like the "Rider Scroll" unlock new equipment slots.</li> <li>Complete QUESTS for extra rewards.</li><li>Enter WHITELIST raffles for chances at special rewards.</li> <li>Swap Gold for Diamonds in the Shop.</li> </ul> <p>This is a demo. Advanced wallet integration for account linking and some data persistence features are still being refined.</p> </div> </section>
            </div>
            <aside class="right-sidebar-menu"> <nav class="main-menu-nav"> <div class="menu-button-container-fixed"><button class="menu-button" id="mainMenuToggleBtn">MENU</button></div> <div class="sidebar-content-area" id="sidebarContentArea"> <ul class="main-menu-nav-list" id="mainMenuList"> <li data-page="adventures-page" class="menu-list-item">ADVENTURES</li>  <li data-page="quests-page" class="menu-list-item">QUESTS</li> <li data-page="daily-rewards-page" class="menu-list-item">DAILY LOGIN REWARDS</li> <li data-page="whitelist-page" class="menu-list-item">WHITELIST</li> <li data-page="shop-page" class="menu-list-item">SHOP & CRAFTING</li> <li data-page="inventory-page" class="menu-list-item">INVENTORY</li>  <li data-page="help-page" class="menu-list-item">HELP</li> </ul> <div class="sidebar-active-adventures-container" id="sidebarActiveAdventuresDisplay"> <h3>ACTIVE ADVENTURES</h3> <div id="sidebarActiveAdventuresList"></div> </div> <div class="active-potions-display hidden" id="activePotionsDisplay"> <h4>ACTIVE POTIONS</h4> <div id="activePotionsList"></div> </div> </div> </nav> </aside>
        </main>
    </div>

    <div id="customPopupOverlay" class="hidden"></div>
    <div id="customPopup" class="hidden">
        <h3 id="customPopupTitle">Notification</h3>
        <p id="customPopupMessage"></p>
        <button id="customPopupCloseBtn" class="action-button">OK</button>
    </div>

    <script type="module" id="firebaseModule">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, Timestamp, query, where, orderBy, getDocs, addDoc, runTransaction, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"; 
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics.js";

        const firebaseConfig = {
            apiKey: "AIzaSyASoKVnbNVJBASSPEnWOvkocTwM16ijNxM",
            authDomain: "punkvoyage.firebaseapp.com",
            projectId: "punkvoyage",
            storageBucket: "punkvoyage.appspot.com", 
            messagingSenderId: "929081617432",
            appId: "1:929081617432:web:1603e242f9cceb79ee676d",
            measurementId: "G-R5ESCD03L9"
        };
        
        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const analytics = getAnalytics(app); 

            window.firebaseApp = app;
            window.firebaseDb = db;
            window.firebaseFirestore = { doc, getDoc, setDoc, collection, Timestamp, query, where, orderBy, getDocs, addDoc, runTransaction, updateDoc, deleteDoc }; 
            
            document.dispatchEvent(new CustomEvent('firebaseReady'));
            console.log("Firebase Initialized Successfully and 'firebaseReady' event dispatched.");

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            setTimeout(() => { 
                const popupTitle = document.getElementById('customPopupTitle');
                const popupMessage = document.getElementById('customPopupMessage');
                const popupOverlay = document.getElementById('customPopupOverlay');
                const popupItself = document.getElementById('customPopup');
                if (popupTitle && popupMessage && popupOverlay && popupItself) {
                     popupTitle.textContent = "Critical Error";
                     popupMessage.textContent = "Failed to connect to game services. Please ensure your Firebase configuration is correct and you are online. Error: " + error.message;
                     popupOverlay.classList.remove('hidden');
                     popupItself.classList.remove('hidden');
                } else {
                    alert("CRITICAL FIREBASE ERROR: " + error.message + "\nCheck Firebase config and internet connection."); 
                }
            }, 100);
        }
    </script>

    <script>
        document.addEventListener('firebaseReady', () => {
            console.log("'firebaseReady' event received by main script. Initializing game logic.");
            
            const db = window.firebaseDb;
            const { doc, getDoc, setDoc, collection, Timestamp, query, where, orderBy, getDocs, addDoc, runTransaction, updateDoc, deleteDoc } = window.firebaseFirestore;

            // HTML Elements
            const welcomeScreen = document.getElementById('welcomeScreen');
            const logoutButton = document.getElementById('logoutButton');         
            const gameContainer = document.getElementById('gameContainer');
            const playerNicknameDisplay = document.getElementById('playerNicknameDisplay'); 
            const adminRafflePanel = document.getElementById('adminRafflePanel');
            const createRaffleForm = document.getElementById('createRaffleForm');
            const whitelistRafflesContainer = document.getElementById('whitelistRafflesContainer');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const body = document.body;
            const twitterWidgetContainer = document.getElementById('twitter-widget-container');
            const pvCountElement = document.getElementById('pvCount');
            const goldCountElement = document.getElementById('goldCount');
            const diamondCountElement = document.getElementById('diamondCount');
            const adventureSendButtons = document.querySelectorAll('.adventure-send-btn');
            const adventureDropButtons = document.querySelectorAll('.adventure-drops-button');
            const swapGoldToDiamondBtn = document.getElementById('swapGoldToDiamondBtn');
            const sidebarActiveAdventuresContainer = document.getElementById('sidebarActiveAdventuresDisplay'); 
            const sidebarActiveAdventuresList = document.getElementById('sidebarActiveAdventuresList');
            const activePotionsDisplay = document.getElementById('activePotionsDisplay');
            const activePotionsList = document.getElementById('activePotionsList');
            const availableAdventurersCountElement = document.getElementById('availableAdventurersCount');
            const menuItems = document.querySelectorAll('.right-sidebar-menu .main-menu-nav-list li');
            const pageContents = document.querySelectorAll('.main-content-area .page-content'); 
            const questListDiv = document.getElementById('questList');
            const shopItemsDiv = document.getElementById('shopItems');
            const materialsListDiv = document.getElementById('materialsList');
            const craftingItemsContainer = document.getElementById('craftingItemsContainer');
            const inventoryItemsContainer = document.getElementById('inventoryItemsContainer');
            const equipmentSlotsDisplay = document.getElementById('equipmentSlotsDisplay');
            const dailyRewardsGrid = document.getElementById('dailyRewardsGrid');
            const customPopupOverlay = document.getElementById('customPopupOverlay');
            const customPopup = document.getElementById('customPopup');
            const customPopupTitleEl = document.getElementById('customPopupTitle');
            const customPopupMessageEl = document.getElementById('customPopupMessage');
            const customPopupCloseBtn = document.getElementById('customPopupCloseBtn');
            const welcomeConnectWalletBtn = document.getElementById('welcomeConnectWalletBtn'); // Added


            // Game State Variables
            let userWalletAddress = null; 
            let userDisplayName = 'Voyager'; 
            const ADMIN_WALLET_ADDRESS = "YOUR_ADMIN_WALLET_ADDRESS_HERE"; // <<< IMPORTANT: SET YOUR ADMIN WALLET ADDRESS HERE

            const MAX_PLAYER_ADVENTURERS = 5;
            let currentPvTokens = 0; let currentGold = 0; let currentDiamonds = 0;
            let activeAdventures = []; let nextActiveAdventureId = 0;
            let totalAvailableAdventurers = MAX_PLAYER_ADVENTURERS;
            let playerInventory = [];
            let playerMaterials = { "Leather": 0, "Wood": 0, "Clover": 0, "Fabric": 0, "Iron": 0, "Gizmo Tail": 0, "Stone": 0, "Obsidian": 0, "Bitcoin": 0, "Bone": 0, "Flame Essence": 0, "Essence of Death": 0, "Rider's Sigil": 0, "Ancient Tablet Fragment": 0, "Shadowgem": 0 };
            let equippedItems = { Armour: null, Helmet: null, Boots: null, Amulet: null, Ring1: null, Ring2: null, Weapon: null, Misc1: null, Misc2: null };
            let playerAdventurerLevel = 1; 
            let secondRingSlotUnlocked = false;
            let activePotions = [];
            let allRaffles = []; 
            let playerRaffleEntries = {}; 
            
            const adventuresData = { "1": { name: "Spirit Forest", drops: [ { name: "Leather", chance: 0.05, qty: 1}, { name: "Wood", chance: 0.10, qty: 1}, { name: "Clover", chance: 0.01, qty: 1}, { name: "Fabric", chance: 0.03, qty: 1} ] }, "2": { name: "Mountain of the Marowan", drops: [ { name: "Iron", chance: 0.05, qty: 1}, { name: "Gizmo Tail", chance: 0.01, qty: 1}, { name: "Stone", chance: 0.10, qty: 1} ] }, "3": { name: "Fire Fields of Flyinals", adventurerRequirement: 2, drops: [ { name: "Obsidian", chance: 0.01, qty: 1}, { name: "Bitcoin", chance: 0.00001, qty: 1}, { name: "Flame Essence", chance: 0.05, qty: 1} ] }, "4": { name: "Tomb of the Death Riders", adventurerRequirement: 5, drops: [ { name: "Bone", chance: 0.15, qty: 1}, { name: "Essence of Death", chance: 0.10, qty: 1}, { name: "Bitcoin", chance: 0.0001, qty: 1},  { name: "Rider's Sigil", chance: 0.05, qty: 1}, { name: "Rider Scroll", chance: 0.005, qty: 1}, { name: "Ancient Tablet Fragment", chance: 0.02, qty: 1}, { name: "Shadowgem", chance: 0.008, qty: 1}, { name: "Cursed Band", chance: 0.002, qty: 1} ] } };
            const craftableItemsData = [ { id: "boots1", name: "Warped Boots", type: "Boots", description: "Reduces adventure time by 5 minutes.", perk: { type: "timeReduction", value: 300 }, recipe: { "Leather": 5, "Fabric": 3 }, imgColor: "var(--item-placeholder-boots)" }, { id: "amulet1", name: "Amulet of Greed", type: "Amulet", description: "Increases Gold find chance by +50% of current chance.", perk: { type: "goldChanceIncrease", multiplier: 0.5 }, recipe: { "Iron": 3, "Gizmo Tail": 1 }, imgColor: "var(--item-placeholder-amulet)" }, { id: "rucksack1", name: "Efficient Rucksack", type: "Rucksack", description: "+5% PV tokens from adventures.", perk: { type: "pvBonus", multiplier: 0.05 }, recipe: { "Fabric": 5, "Leather": 2 }, imgColor: "var(--item-placeholder-rucksack)" }, { id: "trinket1", name: "Lucky Rabbit's Foot", type: "Trinket", description: "Increases material find chance by +30% (additive).", perk: { type: "materialChanceIncrease", additive: 0.30 }, recipe: { "Clover": 3, "Bone": 2 }, imgColor: "var(--item-placeholder-trinket)" }, { id: "weapon1", name: "Rider's Blade", type: "Weapon", description: "A blade echoing with the cries of the fallen. (+5 Combat)", perk: {type: "combatBoost", value: 5}, recipe: { "Rider's Sigil": 2, "Essence of Death": 3, "Iron": 5}, imgColor: "var(--item-placeholder-weapon)"}, { id: "armour1", name: "Shadow-Woven Hauberk", type: "Armour", description: "Provides moderate protection. (+10 Defense)", perk: {type: "defenseBoost", value: 10}, recipe: {"Obsidian": 5, "Essence of Death": 2, "Shadowgem": 1}, imgColor: "var(--item-placeholder-armour)"}, { id: "helmet1", name: "Helm of the Silent Watcher", type: "Helmet", description: "Offers a gaze that pierces the veil. (+3 Perception)", perk: {type: "perceptionBoost", value: 3}, recipe: {"Iron": 4, "Rider's Sigil": 1, "Shadowgem": 1}, imgColor: "var(--item-placeholder-helmet)"}, { id: "ring_warding", name: "Ring of Minor Warding", type: "Ring", description: "Offers slight protection against mishaps. (+1 Luck)", perk: {type: "luck", value: 1}, recipe: {"Stone": 10, "Clover": 5}, imgColor: "var(--item-placeholder-ring)"}, { id: "ring_swiftness", name: "Band of Swiftness", type: "Ring", description: "Slightly reduces adventure times. (-1 min)", perk: {type: "timeReduction", value: 60}, recipe: {"Leather": 8, "Gizmo Tail": 3}, imgColor: "var(--item-placeholder-ring)"}, { id: "ring_cursedpower", name: "Cursed Band of Power", type: "Ring", description: "Grants power, but at a cost. (+2 Power)", perk: {type: "powerBoost", value: 2}, recipe: {"Rider's Sigil": 3, "Shadowgem": 2, "Essence of Death": 1}, imgColor: "var(--item-placeholder-ring)"}];
            const shopItemsData = [ { id: "potion2", name: "PV Doubler (1 Hour)", description: "Doubles PV rewards from adventures for 1 hour.", price: 200, imgColor: "var(--item-placeholder-potion2)", type: "buff", durationSeconds: 3600, effect: { type: "pvMultiplier", value: 2 } }, { id: "potion3", name: "Gold Magnet (3 Adventures)", description: "Adds +5% flat chance of finding gold on next 3 adventures.", price: 150, imgColor: "var(--item-placeholder-potion3)", type: "buff", durationAdventures: 3, effect: { type: "goldChanceBonus", flatValue: 0.05 } }, ];
            const quests = [ { id: 1, text: "Complete Spirit Forest 5 times", reward: "50 PV", completed: false, progress: 0, target: 5, adventureName: "Spirit Forest" }, { id: 2, text: "Complete Mountain of the Marowan 5 times", reward: "75 PV", completed: false, progress: 0, target: 5, adventureName: "Mountain of the Marowan"}, { id: 3, text: "Complete Fire Fields of Flyinals 5 times", reward: "150 PV", completed: false, progress: 0, target: 5, adventureName: "Fire Fields of Flyinals"}, { id: 4, text: "Venture into the Tomb of the Death Riders", reward: "250 PV, 1 Diamond", completed: false, progress: 0, target: 1, adventureName: "Tomb of the Death Riders"} ];
            const dailyRewardsData = []; for (let i = 1; i <= 30; i++) { let reward = `${50 + (i * 5)} PV`; if (i % 7 === 0 && Object.keys(playerMaterials).length > 0) reward += `, 1 ${Object.keys(playerMaterials)[i % Object.keys(playerMaterials).length]}`; if (i === 30) reward = "1 Gold, 300 PV, 1 Diamond"; dailyRewardsData.push({ day: i, reward: reward });}
            let lastClaimedDay = 0; 
            const adventureProgressionConfig = [ { id: "1", blockId: "adventure-1-block", unlockQuestId: null, unlockMessage: "" }, { id: "2", blockId: "adventure-2-block", unlockQuestId: 1, unlockMessage: "Complete 'Spirit Forest' 5 times to unlock." }, { id: "3", blockId: "adventure-3-block", unlockQuestId: 2, unlockMessage: "Complete 'Mountain of the Marowan' 5 times to unlock." }, { id: "4", blockId: "adventure-4-block", unlockQuestId: 3, unlockMessage: "Complete 'Fire Fields of Flyinals' 5 times to unlock." } ];

            // --- Popup Functions ---
            function showCustomPopup(message, title = "Notification") { if (customPopupTitleEl) customPopupTitleEl.textContent = title; if (customPopupMessageEl) customPopupMessageEl.textContent = message; if (customPopupOverlay) customPopupOverlay.classList.remove('hidden'); if (customPopup) customPopup.classList.remove('hidden'); if (customPopupCloseBtn) customPopupCloseBtn.focus(); }
            function hideCustomPopup() { if (customPopupOverlay) customPopupOverlay.classList.add('hidden'); if (customPopup) customPopup.classList.add('hidden'); }
            if (customPopupCloseBtn) customPopupCloseBtn.addEventListener('click', hideCustomPopup);
            if (customPopupOverlay) customPopupOverlay.addEventListener('click', hideCustomPopup); 

            // --- Firebase Save/Load (using Wallet Address) ---
            async function saveGameStateToFirebase(walletAddr, gameState) { 
                if (!walletAddr) { console.error("Cannot save game: Wallet Address is missing."); showCustomPopup("Error: Wallet Address is missing. Cannot save progress.", "Save Error"); return; } 
                if (!db) { console.error("Firestore not initialized!"); showCustomPopup("Error: Database connection failed. Cannot save progress.", "Save Error"); return; } 
                try { 
                    const savableGameState = { ...gameState }; 
                    if (savableGameState.activeAdventures) { savableGameState.activeAdventures = savableGameState.activeAdventures.map(adv => ({ ...adv, returnTime: typeof adv.returnTime === 'number' ? adv.returnTime : (adv.returnTime instanceof Date ? Timestamp.fromDate(adv.returnTime) : Timestamp.now()) })); } 
                    if (savableGameState.activePotions) { savableGameState.activePotions = savableGameState.activePotions.map(p => ({ ...p, endTime: typeof p.endTime === 'number' ? p.endTime : (p.endTime instanceof Date ? Timestamp.fromDate(p.endTime) : null) })); } 
                    const playerDocRef = doc(db, 'playerProgress', walletAddr); 
                    await setDoc(playerDocRef, savableGameState, { merge: true }); 
                    console.log("Game state saved for Wallet:", walletAddr); 
                } catch (error) { console.error("Error saving game state: ", error); showCustomPopup(`Failed to save game progress: ${error.message}`, "Save Error");}
            }
            async function loadGameStateFromFirebase(walletAddr) { 
                if (!walletAddr) { console.error("Cannot load game: Wallet Address is missing."); return null; } 
                if (!db) { console.error("Firestore not initialized!"); return null;} 
                try { 
                    const playerDocRef = doc(db, 'playerProgress', walletAddr); 
                    const docSnap = await getDoc(playerDocRef); 
                    if (docSnap.exists()) { 
                        const loadedData = docSnap.data(); 
                        if (loadedData.activeAdventures) { loadedData.activeAdventures = loadedData.activeAdventures.map(adv => ({ ...adv, returnTime: adv.returnTime && typeof adv.returnTime.toDate === 'function' ? adv.returnTime.toDate().getTime() : (typeof adv.returnTime === 'number' ? adv.returnTime : Date.now()) })); } 
                        if (loadedData.activePotions) { loadedData.activePotions = loadedData.activePotions.map(p => ({ ...p, endTime: p.endTime && typeof p.endTime.toDate === 'function' ? p.endTime.toDate().getTime() : (typeof p.endTime === 'number' ? p.endTime : null) })); } 
                        return loadedData; 
                    } else { 
                        console.log("No saved game state found for Wallet Address", walletAddr); 
                        return null; 
                    } 
                } catch (error) { console.error("Error directly within loadGameStateFromFirebase:", error); showCustomPopup(`Failed to load game progress from Firebase: ${error.message}`, "DB Load Error"); return null;}
            }
            
            function getCurrentGameState() { 
                return { 
                    userWalletAddress: userWalletAddress, 
                    displayName: userDisplayName,
                    pvTokens: currentPvTokens || 0, 
                    gold: currentGold || 0, 
                    diamonds: currentDiamonds || 0, 
                    activeAdventures: Array.isArray(activeAdventures) ? activeAdventures.map(adv => ({ id: adv.id, originalAdventureId: adv.originalAdventureId, name: adv.name || "Unknown Adventure", adventurers: adv.adventurers || 0, returnTime: adv.returnTime || Date.now(), pvReward: adv.pvReward || 0, goldChance: adv.goldChance || 0, diamondChance: adv.diamondChance || 0 })) : [], 
                    totalAvailableAdventurers: totalAvailableAdventurers !== undefined ? totalAvailableAdventurers : MAX_PLAYER_ADVENTURERS, 
                    playerInventory: Array.isArray(playerInventory) ? playerInventory.map(item => typeof item === 'string' ? item : item.id) : [], 
                    playerMaterials: playerMaterials || {}, 
                    equippedItems: equippedItems || { Armour: null, Helmet: null, Boots: null, Amulet: null, Ring1: null, Ring2: null, Weapon: null, Misc1: null, Misc2: null }, 
                    quests: Array.isArray(quests) ? quests.map(q => ({ id: q.id, text: q.text || "UKN", reward: q.reward || "0", completed: q.completed || false, progress: q.progress || 0, target: q.target || 0, adventureName: q.adventureName || null, metric: q.metric || null, claimed: q.claimed || false })) : [], 
                    lastClaimedDayPVA: lastClaimedDay || 0, 
                    activePotions: Array.isArray(activePotions) ? activePotions.map(p => ({ id: p.id, endTime: p.endTime || null, adventuresLeft: p.adventuresLeft !== undefined ? p.adventuresLeft : null })).filter(p => p.id) : [], 
                    playerAdventurerLevel: playerAdventurerLevel || 1, 
                    secondRingSlotUnlocked: secondRingSlotUnlocked || false, 
                    playerRaffleEntries: playerRaffleEntries || {} 
                };
            }
            function applyLoadedGameState(loadedData) { 
                console.log("Applying loaded game state for wallet:", loadedData.userWalletAddress, loadedData); 
                if (!loadedData) { console.error("applyLoadedGameState called with null or undefined state."); return; } 
                try { 
                    userWalletAddress = loadedData.userWalletAddress || userWalletAddress; 
                    userDisplayName = loadedData.displayName || `${userWalletAddress.substring(0,6)}...${userWalletAddress.substring(userWalletAddress.length - 4)}`;
                    if (playerNicknameDisplay) playerNicknameDisplay.textContent = userDisplayName; 
                    currentPvTokens = loadedData.pvTokens || 0; currentGold = loadedData.gold || 0; currentDiamonds = loadedData.diamonds || 0; activeAdventures = Array.isArray(loadedData.activeAdventures) ? loadedData.activeAdventures.map(advData => { return { id: advData.id || nextActiveAdventureId++, originalAdventureId: advData.originalAdventureId || "1", name: advData.name || "Unknown Adventure", adventurers: advData.adventurers || 0, returnTime: typeof advData.returnTime === 'number' ? advData.returnTime : Date.now(), pvReward: advData.pvReward || 0, goldChance: advData.goldChance || 0, diamondChance: advData.diamondChance || 0 }; }) : []; nextActiveAdventureId = activeAdventures.length > 0 ? Math.max(0, ...activeAdventures.map(a => a.id)) + 1 : 0; totalAvailableAdventurers = loadedData.totalAvailableAdventurers !== undefined ? loadedData.totalAvailableAdventurers : MAX_PLAYER_ADVENTURERS; playerInventory = Array.isArray(loadedData.playerInventory) ? loadedData.playerInventory.map(itemSource => { if (typeof itemSource === 'string') { let itemData = craftableItemsData.find(i => i.id === itemSource); if (!itemData && itemSource === "riderScroll") itemData = { id: "riderScroll", name: "Rider Scroll", type: "Consumable", description: "Unlocks a second ring slot.", imgColor: "var(--item-placeholder-scroll)" }; if (!itemData && itemSource === "cursedBand") itemData = { id: "cursedBand", name: "Cursed Band", type: "Ring", description: "A ring pulsing with dark energy. (+1 Dark Power)", perk: { type: "darkPower", value: 1 }, imgColor: "var(--item-placeholder-ring)" }; return itemData || { id: itemSource, name: "Unknown Item ID", type: "Unknown" }; } return itemSource || { id: "unknownObjectInInventory", name: "Unknown Item Obj", type: "Unknown" }; }).filter(item => item && item.id) : []; playerMaterials = loadedData.playerMaterials || { "Leather": 0, "Wood": 0, "Clover": 0, "Fabric": 0, "Iron": 0, "Gizmo Tail": 0, "Stone": 0, "Obsidian": 0, "Bitcoin": 0, "Bone": 0, "Flame Essence": 0, "Essence of Death": 0, "Rider's Sigil": 0, "Ancient Tablet Fragment": 0, "Shadowgem": 0 }; equippedItems = loadedData.equippedItems || { Armour: null, Helmet: null, Boots: null, Amulet: null, Ring1: null, Ring2: null, Weapon: null, Misc1: null, Misc2: null }; playerAdventurerLevel = loadedData.playerAdventurerLevel || 1; secondRingSlotUnlocked = loadedData.secondRingSlotUnlocked || false; playerRaffleEntries = loadedData.playerRaffleEntries || {}; if (Array.isArray(loadedData.quests)) { quests.forEach(q_default => { const loaded_q = loadedData.quests.find(lq => lq && lq.id === q_default.id); if (loaded_q) { q_default.completed = loaded_q.completed || false; q_default.progress = loaded_q.progress || 0; q_default.claimed = loaded_q.claimed || false; } }); } lastClaimedDay = loadedData.lastClaimedDayPVA || 0; if (Array.isArray(loadedData.activePotions)) { activePotions = loadedData.activePotions.map(pData => { if (!pData || !pData.id) return null; const potionBase = shopItemsData.find(shopItem => shopItem.id === pData.id); if (!potionBase) return null; return { id: pData.id, name: potionBase.name, description: potionBase.description, effect: potionBase.effect, endTime: typeof pData.endTime === 'number' ? pData.endTime : null, adventuresLeft: pData.adventuresLeft !== undefined ? pData.adventuresLeft : null }; }).filter(p => p !== null); activePotions = activePotions.filter(p => (p.endTime && Date.now() < p.endTime) || (p.adventuresLeft !== undefined && p.adventuresLeft > 0) || (!p.endTime && p.adventuresLeft === undefined) ); } 
                    updateStatsDisplay(); renderMaterials(); renderActiveAdventuresInSidebar(); renderActivePotions(); renderInventory(); updateAdventureDisplayStates(); 
                    if (document.getElementById('quests-page').classList.contains('active')) renderQuests(); 
                    if (document.getElementById('daily-rewards-page').classList.contains('active')) renderDailyRewards(); 
                    if (document.getElementById('shop-page').classList.contains('active')) { renderShopItems(); renderCraftingItems(); } 
                    if (document.getElementById('whitelist-page').classList.contains('active')) fetchAndDisplayRaffles(); 
                    console.log("Game state applied successfully for", userWalletAddress); 
                } catch (error) { console.error("Error during applyLoadedGameState:", error); showCustomPopup("Error applying loaded game data. Starting fresh.", "Apply State Error"); initializeNewPlayerData(userWalletAddress || "WalletErr"); await fetchAndDisplayRaffles(); }
            }
            
            async function initializeNewPlayerData(walletAddr) { 
                userWalletAddress = walletAddr;
                userDisplayName = `${walletAddr.substring(0,6)}...${walletAddr.substring(walletAddr.length - 4)}`;
                if (playerNicknameDisplay) playerNicknameDisplay.textContent = userDisplayName;
                currentPvTokens = 0; currentGold = 0; currentDiamonds = 0;
                activeAdventures = []; totalAvailableAdventurers = MAX_PLAYER_ADVENTURERS;
                playerInventory = [];
                playerMaterials = { "Leather": 0, "Wood": 0, "Clover": 0, "Fabric": 0, "Iron": 0, "Gizmo Tail": 0, "Stone": 0, "Obsidian": 0, "Bitcoin": 0, "Bone": 0, "Flame Essence": 0, "Essence of Death": 0, "Rider's Sigil": 0, "Ancient Tablet Fragment": 0, "Shadowgem": 0 };
                equippedItems = { Armour: null, Helmet: null, Boots: null, Amulet: null, Ring1: null, Ring2: null, Weapon: null, Misc1: null, Misc2: null };
                playerAdventurerLevel = 1; secondRingSlotUnlocked = false; activePotions = []; playerRaffleEntries = {};
                lastClaimedDay = 0;
                quests.forEach(q => { q.completed = false; q.progress = 0; q.claimed = false; });

                updateStatsDisplay(); renderMaterials(); generateRandomQuests(); 
                renderActiveAdventuresInSidebar(); renderActivePotions();
                renderInventory(); updateAdventureDisplayStates();
                if (userWalletAddress) await saveGameStateToFirebase(userWalletAddress, getCurrentGameState());
            }

            function resetLocalGameState() { 
                userWalletAddress = null;
                userDisplayName = 'Voyager';
                if (playerNicknameDisplay) playerNicknameDisplay.textContent = userDisplayName;
                currentPvTokens = 0; currentGold = 0; currentDiamonds = 0;
                activeAdventures = []; nextActiveAdventureId = 0; totalAvailableAdventurers = MAX_PLAYER_ADVENTURERS;
                playerInventory = [];
                playerMaterials = { "Leather": 0, "Wood": 0, "Clover": 0, "Fabric": 0, "Iron": 0, "Gizmo Tail": 0, "Stone": 0, "Obsidian": 0, "Bitcoin": 0, "Bone": 0, "Flame Essence": 0, "Essence of Death": 0, "Rider's Sigil": 0, "Ancient Tablet Fragment": 0, "Shadowgem": 0 };
                equippedItems = { Armour: null, Helmet: null, Boots: null, Amulet: null, Ring1: null, Ring2: null, Weapon: null, Misc1: null, Misc2: null };
                playerAdventurerLevel = 1; secondRingSlotUnlocked = false; activePotions = []; playerRaffleEntries = {};
                quests.forEach(q => { q.completed = false; q.progress = 0; q.claimed = false; });
                lastClaimedDay = 0;

                updateStatsDisplay(); renderMaterials(); renderActiveAdventuresInSidebar(); renderActivePotions();
                renderInventory(); updateAdventureDisplayStates(); renderQuests(); renderDailyRewards();
                if (document.getElementById('whitelist-page').classList.contains('active')) fetchAndDisplayRaffles();
            }
            
            async function handleSuccessfulWalletConnection(address, walletName) {
                userWalletAddress = address;
                connectedAccount = address; 
                connectedWalletName = walletName; 
                
                const shortAddress = `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
                userDisplayName = shortAddress; 
                if (playerNicknameDisplay) playerNicknameDisplay.textContent = userDisplayName; // Update header
                
                welcomeScreen.classList.add('hidden');
                gameContainer.classList.remove('hidden');
                logoutButton.classList.remove('hidden');

                if (userWalletAddress && userWalletAddress.toLowerCase() === ADMIN_WALLET_ADDRESS.toLowerCase() && adminRafflePanel) {
                    adminRafflePanel.classList.remove('hidden');
                } else if (adminRafflePanel) {
                    adminRafflePanel.classList.add('hidden');
                }

                const currentThemeIsDark = body.classList.contains('dark-mode');
                loadTwitterWidget(currentThemeIsDark ? 'dark' : 'light');

                const loadedState = await loadGameStateFromFirebase(userWalletAddress);
                if (loadedState) {
                    applyLoadedGameState(loadedState);
                    userDisplayName = loadedState.displayName || shortAddress; // Prefer stored displayName
                    if (playerNicknameDisplay) playerNicknameDisplay.textContent = userDisplayName;
                     showCustomPopup(`Welcome back, ${userDisplayName}! Your voyage continues.`, "Voyage Resumed");
                } else {
                    console.log("Setting up new player data in Firestore for Wallet:", userWalletAddress);
                    await initializeNewPlayerData(userWalletAddress); 
                    showCustomPopup(`Welcome, Voyager ${shortAddress}! Your new voyage begins now.`, "New Voyager");
                }
                showPage('adventures-page');
                await fetchAndDisplayRaffles();
            }


            initializeTheme(); 
            if (!localStorage.getItem('hasLoadedOncePVA')) { 
                localStorage.setItem('hasLoadedOncePVA', 'true');
            }
            
            if(logoutButton) {
                logoutButton.addEventListener('click', () => {
                    console.log("User logged out/disconnected wallet:", userWalletAddress);
                    userWalletAddress = null; 
                    connectedAccount = null;
                    connectedWalletName = null;
                    updateWalletDisplay(null); 
                    
                    welcomeScreen.classList.remove('hidden');
                    gameContainer.classList.add('hidden');
                    logoutButton.classList.add('hidden');
                    if(adminRafflePanel) adminRafflePanel.classList.add('hidden');
                    resetLocalGameState();
                    showCustomPopup("You have been disconnected.", "Disconnected");
                });
            }
            
            if (welcomeConnectWalletBtn && connectWalletBtn) { // connectWalletBtn is the header one
                 welcomeConnectWalletBtn.addEventListener('click', () => {
                    connectWalletBtn.click(); 
                });
            }

            setInterval(updateTimers, 1000);
            document.querySelectorAll('.adventure-num-select').forEach(select => { select.value = "5"; });
            
            const connectWalletBtn = document.getElementById('connectWalletBtn'); const walletDropdown = document.getElementById('walletDropdown'); const walletOptions = walletDropdown.querySelectorAll('li'); const walletAddressDisplay = document.getElementById('walletAddressDisplay');
            // let connectedAccount = null; // Already defined
            // let connectedWalletName = null; // Already defined

            function updateWalletDisplay(account, walletName = '') { 
                const headerConnectWalletBtn = document.getElementById('connectWalletBtn'); // Ensure we target header button
                if (account) { 
                    const shortAddress = `${account.substring(0, 6)}...${account.substring(account.length - 4)}`; 
                    if(headerConnectWalletBtn) { headerConnectWalletBtn.textContent = `${walletName}: ${shortAddress}`; headerConnectWalletBtn.classList.add('connected'); } 
                    if(walletAddressDisplay) walletAddressDisplay.textContent = `Wallet: ${account}`; 
                    if (!gameContainer.classList.contains('hidden')) { // Already in game, perhaps a wallet switch
                         if (userWalletAddress !== account) { // Wallet changed
                            showCustomPopup(`Wallet changed to ${shortAddress}. Reloading your progress for this wallet.`, "Wallet Changed");
                            resetLocalGameState(); // Reset before loading new wallet's data
                            handleSuccessfulWalletConnection(account, walletName);
                         }
                    } else { // Initial connection from welcome screen
                        handleSuccessfulWalletConnection(account, walletName);
                    }
                } else { // Disconnecting
                    if(headerConnectWalletBtn) { headerConnectWalletBtn.textContent = 'CONNECT WALLET'; headerConnectWalletBtn.classList.remove('connected'); } 
                    if(walletAddressDisplay) walletAddressDisplay.textContent = ''; 
                    // Logout logic will handle showing welcome screen
                } 
            }
            if(connectWalletBtn && walletDropdown) { connectWalletBtn.addEventListener('click', (event) => { event.stopPropagation(); walletDropdown.style.display = walletDropdown.style.display === 'block' ? 'none' : 'block'; }); document.addEventListener('click', (event) => { if (walletDropdown && connectWalletBtn && !connectWalletBtn.contains(event.target) && !walletDropdown.contains(event.target)) { walletDropdown.style.display = 'none'; } }); }
            async function connectWithSatsConnect(walletTypeHint = null) { if (typeof SatsConnect === 'undefined' || typeof SatsConnect.getAddresses === 'undefined') { showCustomPopup('Sats Connect library not loaded or not ready.', "Wallet Error"); return; } try { SatsConnect.getAddresses({ payload: { purposes: ['ordinals', 'payment'], message: 'Connect to Punk Voyage Adventures', network: { type: 'Mainnet' }, }, onFinish: (response) => { const ordAddress = response.addresses.find(a => a.purpose === 'ordinals'); const payAddress = response.addresses.find(a => a.purpose === 'payment'); let addr = ordAddress ? ordAddress.address : (payAddress ? payAddress.address : null); if (addr) { let name = walletTypeHint ? walletTypeHint.replace('satsconnect_', '').toUpperCase() : "BTC"; if (name === "GENERAL") name = "BTC"; updateWalletDisplay(addr, name); } }, onCancel: () => console.log('SatsConnect canceled.'), }); } catch (e) { console.error('SatsConnect error:', e); showCustomPopup('An error occurred with SatsConnect.', 'Wallet Error');} }
            async function connectUnisat() { try { if (typeof window.unisat !== 'undefined') { const accounts = await window.unisat.requestAccounts(); if (accounts && accounts.length > 0) { updateWalletDisplay(accounts[0], 'UniSat'); window.unisat.on('accountsChanged', (newAccs) => { if (connectedWalletName === 'UniSat') { const newAccount = (newAccs && newAccs.length > 0) ? newAccs[0] : null; if (newAccount !== connectedAccount) { if(newAccount) { updateWalletDisplay(newAccount, 'UniSat'); } else { if(logoutButton) logoutButton.click();}} } }); } } else { window.open('https://unisat.io/', '_blank'); } } catch (e) { console.error('UniSat error:', e); showCustomPopup('An error occurred with UniSat Wallet.', 'Wallet Error'); } }
            if (walletOptions) { walletOptions.forEach(option => { option.addEventListener('click', async (event) => { const walletType = event.target.dataset.wallet; if(walletDropdown) walletDropdown.style.display = 'none'; if (walletType === 'unisat') await connectUnisat(); else if (walletType && walletType.startsWith('satsconnect_')) { await connectWithSatsConnect(walletType.split('_')[1]); } }); }); }

            // Raffle functions (fetchAndDisplayRaffles, admin panel submit, enter, draw, delete)
            async function fetchAndDisplayRaffles() {
                if (!db) { console.error("Firestore not initialized for fetching raffles."); allRaffles = []; renderWhitelistRaffles(); return; }
                const rafflesCol = collection(db, "raffles");
                const q_raffles = query(rafflesCol, where("status", "in", ["active", "ended", "drawing_winners", "winners_announced"]), orderBy("endTime", "desc"));
                try {
                    const querySnapshot = await getDocs(q_raffles);
                    const fetchedRaffles = [];
                    for (const docSnap of querySnapshot.docs) { 
                        const raffleData = docSnap.data();
                        let displayEntryCount = raffleData.entryCount || 0;
                        fetchedRaffles.push({ id: docSnap.id, name: raffleData.name, description: raffleData.description, imageUrl: raffleData.imageUrl || '', socials: raffleData.socials || { x: '', discord: '' }, entryCost: raffleData.entryCost || { pv: 0, gold: 0, diamonds: 0 }, maxWinners: raffleData.maxWinners || 1, startTime: raffleData.startTime.toDate().getTime(), endTime: raffleData.endTime.toDate().getTime(), status: raffleData.status, entryCount: displayEntryCount, winners: raffleData.winners || [] });
                    }
                    allRaffles = fetchedRaffles;
                    renderWhitelistRaffles();
                    console.log("Fetched raffles from Firestore:", allRaffles);
                } catch (error) { console.error("Error fetching raffles: ", error); showCustomPopup("Could not load raffles from the server. Check console for details (e.g., missing index).", "Raffle Error"); allRaffles = []; renderWhitelistRaffles(); }
            }

            if (createRaffleForm) {
                createRaffleForm.addEventListener('submit', async (e) => { 
                    e.preventDefault();
                    if (!db || !userWalletAddress || userWalletAddress.toLowerCase() !== ADMIN_WALLET_ADDRESS.toLowerCase()) {
                        showCustomPopup("Admin action failed. Not logged in as admin or DB error.", "Admin Error");
                        return;
                    }
                    const name = document.getElementById('raffleName').value;
                    const description = document.getElementById('raffleDescription').value;
                    const imageUrl = document.getElementById('raffleImageUrl').value || '';
                    const socialX = document.getElementById('raffleSocialX').value;
                    const socialDiscord = document.getElementById('raffleSocialDiscord').value;
                    const costPV = parseInt(document.getElementById('raffleCostPV').value) || 0;
                    const costGold = parseInt(document.getElementById('raffleCostGold').value) || 0;
                    const costDiamonds = parseInt(document.getElementById('raffleCostDiamonds').value) || 0;
                    const durationHours = parseInt(document.getElementById('raffleDurationHours').value) || 24;
                    const maxWinners = parseInt(document.getElementById('raffleMaxWinners').value) || 1;
                    const nowMs = Date.now();
                    const startTime = Timestamp.fromDate(new Date(nowMs));
                    const endTime = Timestamp.fromDate(new Date(nowMs + durationHours * 1000)); 
                    const newRaffleData = { name: name, description: description, imageUrl: imageUrl, socials: { x: socialX, discord: socialDiscord }, entryCost: { pv: costPV, gold: costGold, diamonds: costDiamonds }, durationHours: durationHours, maxWinners: maxWinners, startTime: startTime, endTime: endTime, status: 'active', createdByWalletAddress: userWalletAddress, createdAt: Timestamp.now(), winners: [], entryCount: 0 };
                    try {
                        const newRaffleRef = await addDoc(collection(db, "raffles"), newRaffleData);
                        console.log("Raffle created in Firestore with ID: ", newRaffleRef.id);
                        showCustomPopup(`Raffle "${name}" created successfully in Firebase!`, "Admin Action");
                        createRaffleForm.reset();
                        await fetchAndDisplayRaffles(); 
                    } catch (error) { console.error("Error creating raffle in Firestore: ", error); showCustomPopup("Failed to create raffle in database.", "Admin Error"); }
                });
            }

            async function renderWhitelistRaffles() { 
                if (!whitelistRafflesContainer) return;
                whitelistRafflesContainer.innerHTML = '';
                if (allRaffles.length === 0) {
                    whitelistRafflesContainer.innerHTML = '<p style="text-align:center;">No active raffles at the moment. Check back soon!</p>';
                    return;
                }
                allRaffles.sort((a, b) => b.startTime - a.startTime); 
                for (const raffle of allRaffles) { 
                    const card = document.createElement('div');
                    card.className = 'raffle-card';
                    card.dataset.raffleId = raffle.id;
                    const timeLeftMs = raffle.endTime - Date.now();
                    let costHtml = '';
                    if (raffle.entryCost.pv > 0) costHtml += `${raffle.entryCost.pv} <span class="pv">PV</span> `;
                    if (raffle.entryCost.gold > 0) costHtml += `${raffle.entryCost.gold} <span class="gold">GOLD</span> `;
                    if (raffle.entryCost.diamonds > 0) costHtml += `${raffle.entryCost.diamonds} <span class="diamond">DIAMONDS</span>`;
                    if (costHtml === '') costHtml = 'Free Entry'; else costHtml = 'Cost: ' + costHtml;
                    const alreadyEntered = playerRaffleEntries[raffle.id];
                    let adminActionsHtml = '';
                    if (userWalletAddress && userWalletAddress.toLowerCase() === ADMIN_WALLET_ADDRESS.toLowerCase()) {
                        adminActionsHtml += `<button class="action-button raffle-action-btn delete-raffle-btn" data-raffle-id="${raffle.id}">Delete</button>`;
                        if (raffle.status === 'active') {
                             adminActionsHtml += `<button class="action-button raffle-action-btn draw-now-btn" data-raffle-id="${raffle.id}">Draw Now</button>`;
                        } else if (raffle.status === 'ended' && (!raffle.winners || raffle.winners.length === 0)) {
                            adminActionsHtml += `<button class="action-button raffle-action-btn draw-winners-btn" data-raffle-id="${raffle.id}">Draw Winners</button>`;
                        }
                    }
                    card.innerHTML = `
                        <div class="raffle-card-image ${raffle.imageUrl ? '' : 'placeholder'}" style="${raffle.imageUrl ? 'background-image: url('+raffle.imageUrl+');' : ''}">${!raffle.imageUrl ? 'No Image' : ''}</div>
                        <div class="raffle-card-content">
                            <h4>${raffle.name}</h4><p class="raffle-card-description">${raffle.description}</p>
                            <div class="raffle-card-socials">${raffle.socials.x ? `<a href="${raffle.socials.x}" target="_blank">Project X</a>` : ''}${raffle.socials.discord ? `<a href="${raffle.socials.discord}" target="_blank">Project Discord</a>` : ''}</div>
                            <p class="raffle-card-cost">${costHtml}</p><p class="raffle-card-status">Status: ${raffle.status.replace('_', ' ')}</p>
                            <p>Time Left: <span class="raffle-timer">${formatTimeLeft(timeLeftMs)}</span></p><p>Entries: ${raffle.entryCount || 0}</p>
                            ${raffle.status === 'active' && !alreadyEntered && userWalletAddress ? `<button class="action-button enter-raffle-btn raffle-action-btn" data-raffle-id="${raffle.id}">Enter Raffle</button>` : ''}
                            ${alreadyEntered ? '<p><strong>You have entered this raffle!</strong></p>' : ''}
                            <div class="raffle-admin-actions">${adminActionsHtml}</div>
                            ${raffle.winners && raffle.winners.length > 0 ? `<div><strong>Winners (${raffle.winners.length}/${raffle.maxWinners}):</strong><ul>${raffle.winners.map(w => `<li>${w}</li>`).join('')}</ul></div>` : ''}
                        </div>`;
                    whitelistRafflesContainer.appendChild(card);
                }
                whitelistRafflesContainer.querySelectorAll('.enter-raffle-btn').forEach(btn => btn.addEventListener('click', handleEnterRaffle));
                whitelistRafflesContainer.querySelectorAll('.draw-winners-btn').forEach(btn => btn.addEventListener('click', handleDrawWinners));
                whitelistRafflesContainer.querySelectorAll('.draw-now-btn').forEach(btn => btn.addEventListener('click', handleDrawNow));
                whitelistRafflesContainer.querySelectorAll('.delete-raffle-btn').forEach(btn => btn.addEventListener('click', handleDeleteRaffle));
            }
            
            async function handleEnterRaffle(event) { 
                if (!userWalletAddress) { showCustomPopup("You must connect your wallet to enter raffles.", "Connect Wallet"); return; }
                const raffleId = event.target.dataset.raffleId;
                const raffle = allRaffles.find(r => r.id === raffleId); 
                if (!raffle || raffle.status !== 'active') { showCustomPopup("Raffle is not active or not found.", "Entry Failed"); return; }
                if (playerRaffleEntries[raffle.id]) { showCustomPopup("You have already entered this raffle.", "Entry Failed"); return; }
                if (currentPvTokens < raffle.entryCost.pv || currentGold < raffle.entryCost.gold || currentDiamonds < raffle.entryCost.diamonds) { showCustomPopup("Not enough currency to enter this raffle.", "Entry Failed"); return; }
                const playerProgressRef = doc(db, "playerProgress", userWalletAddress);
                const raffleEntryRef = doc(db, "raffles", raffleId, "entries", userWalletAddress); 
                const mainRaffleDocRef = doc(db, "raffles", raffleId);
                try {
                    await runTransaction(db, async (transaction) => {
                        const playerDoc = await transaction.get(playerProgressRef);
                        if (!playerDoc.exists()) throw "Player document does not exist!";
                        const mainRaffleSnap = await transaction.get(mainRaffleDocRef);
                        if (!mainRaffleSnap.exists()) throw "Raffle document does not exist!";
                        const currentPlayerData = playerDoc.data(); const currentRaffleData = mainRaffleSnap.data();
                        const newPv = (currentPlayerData.pvTokens || 0) - raffle.entryCost.pv;
                        const newGold = (currentPlayerData.gold || 0) - raffle.entryCost.gold;
                        const newDiamonds = (currentPlayerData.diamonds || 0) - raffle.entryCost.diamonds;
                        if (newPv < 0 || newGold < 0 || newDiamonds < 0) throw "Insufficient funds (transaction check).";
                        const entryDoc = await transaction.get(raffleEntryRef);
                        if (entryDoc.exists()) throw "Player already entered this raffle (server check).";
                        let updatedPlayerRaffleEntries = { ... (currentPlayerData.playerRaffleEntries || {}), [raffleId]: true };
                        transaction.update(playerProgressRef, { pvTokens: newPv, gold: newGold, diamonds: newDiamonds, playerRaffleEntries: updatedPlayerRaffleEntries, userWalletAddress: userWalletAddress });
                        transaction.set(raffleEntryRef, { timestamp: Timestamp.now(), walletAddress: userWalletAddress, displayName: userDisplayName }); 
                        transaction.update(mainRaffleDocRef, { entryCount: (currentRaffleData.entryCount || 0) + 1 });
                    });
                    currentPvTokens -= raffle.entryCost.pv; currentGold -= raffle.entryCost.gold; currentDiamonds -= raffle.entryCost.diamonds;
                    playerRaffleEntries[raffle.id] = true; 
                    const raffleInClientArray = allRaffles.find(r => r.id === raffleId);
                    if (raffleInClientArray) raffleInClientArray.entryCount = (raffleInClientArray.entryCount || 0) + 1;
                    updateStatsDisplay(); renderWhitelistRaffles(); 
                    showCustomPopup(`Successfully entered raffle: ${raffle.name}!`, "Raffle Entry");
                } catch (error) { console.error("Raffle entry transaction failed: ", error); showCustomPopup(`Raffle entry failed: ${error.toString()}`, "Entry Error"); }
            }

            async function drawRaffleWinners(raffleId, isDrawingNow = false) {
                if (!userWalletAddress || userWalletAddress.toLowerCase() !== ADMIN_WALLET_ADDRESS.toLowerCase() || !db) return false;
                const raffleDocRef = doc(db, "raffles", raffleId);
                try {
                    const raffleDocSnap = await getDoc(raffleDocRef);
                    if (!raffleDocSnap.exists()) { showCustomPopup("Raffle document not found.", "Admin Error"); return false; }
                    const raffleData = raffleDocSnap.data();
                    if (!isDrawingNow && raffleData.status !== 'ended') { showCustomPopup("Raffle not ended yet.", "Admin Action Failed"); return false; }
                    if (raffleData.winners && raffleData.winners.length > 0) { showCustomPopup("Winners already drawn.", "Admin Info"); return false; }
                    
                    await updateDoc(raffleDocRef, { status: 'drawing_winners', endTime: Timestamp.now() });
                    const localRaffle = allRaffles.find(r => r.id === raffleId);
                    if(localRaffle) localRaffle.status = 'drawing_winners';
                    renderWhitelistRaffles();

                    const entriesColRef = collection(db, "raffles", raffleId, "entries");
                    const entriesSnapshot = await getDocs(entriesColRef);
                    const allEntryUsersData = []; 
                    entriesSnapshot.forEach(entryDoc => { 
                        allEntryUsersData.push({ id: entryDoc.id, displayName: entryDoc.data().displayName || entryDoc.id }); 
                    });

                    if (allEntryUsersData.length === 0) {
                        await updateDoc(raffleDocRef, { status: 'winners_announced', winners: [] });
                        if(localRaffle) { localRaffle.status = 'winners_announced'; localRaffle.winners = [];}
                        showCustomPopup(`No entries for raffle: ${raffleData.name}. No winners drawn.`, "Raffle Result");
                        renderWhitelistRaffles(); return true;
                    }
                    let potentialWinnersData = [...allEntryUsersData]; 
                    const drawnWinnerDisplayNames = [];
                    for (let i = 0; i < raffleData.maxWinners && potentialWinnersData.length > 0; i++) {
                        const winnerIndex = Math.floor(Math.random() * potentialWinnersData.length);
                        drawnWinnerDisplayNames.push(potentialWinnersData.splice(winnerIndex, 1)[0].displayName);
                    }
                    await updateDoc(raffleDocRef, { winners: drawnWinnerDisplayNames, status: 'winners_announced' });
                    if(localRaffle) { localRaffle.winners = drawnWinnerDisplayNames; localRaffle.status = 'winners_announced'; }
                    showCustomPopup(`Winners drawn for ${raffleData.name}! Check list.`, "Raffle Result");
                    renderWhitelistRaffles(); return true;
                } catch (error) { console.error("Error drawing winners: ", error); showCustomPopup("Failed to draw winners.", "Admin Error"); const localRaffle = allRaffles.find(r => r.id === raffleId); if(localRaffle && localRaffle.status === 'drawing_winners') localRaffle.status = 'ended'; renderWhitelistRaffles(); return false; }
            }

            async function handleDrawWinners(event) { await drawRaffleWinners(event.target.dataset.raffleId, false); }
            async function handleDrawNow(event) { await drawRaffleWinners(event.target.dataset.raffleId, true); }

            async function handleDeleteRaffle(event) {
                if (!userWalletAddress || userWalletAddress.toLowerCase() !== ADMIN_WALLET_ADDRESS.toLowerCase() || !db) return;
                const raffleId = event.target.dataset.raffleId;
                const raffleName = allRaffles.find(r => r.id === raffleId)?.name || "this raffle";
                if (confirm(`Are you sure you want to delete "${raffleName}"? This cannot be undone.`)) {
                    const raffleDocRef = doc(db, "raffles", raffleId);
                    try {
                        await deleteDoc(raffleDocRef);
                        showCustomPopup(`Raffle "${raffleName}" deleted.`, "Admin Action");
                        await fetchAndDisplayRaffles(); 
                    } catch (error) { console.error("Error deleting raffle:", error); showCustomPopup("Failed to delete raffle.", "Admin Error"); }
                }
            }


            initializeTheme(); 
            if (!localStorage.getItem('hasLoadedOncePVA')) { 
                localStorage.setItem('hasLoadedOncePVA', 'true');
            }
            
            setInterval(updateTimers, 1000);
            document.querySelectorAll('.adventure-num-select').forEach(select => { select.value = "5"; });
            
            const connectWalletBtn = document.getElementById('connectWalletBtn'); 
            const walletDropdown = document.getElementById('walletDropdown'); 
            const walletOptions = walletDropdown.querySelectorAll('li'); 
            const walletAddressDisplay = document.getElementById('walletAddressDisplay');
            let connectedAccount = null; 
            let connectedWalletName = null; 

            if(connectWalletBtn && walletDropdown) { connectWalletBtn.addEventListener('click', (event) => { event.stopPropagation(); walletDropdown.style.display = walletDropdown.style.display === 'block' ? 'none' : 'block'; }); document.addEventListener('click', (event) => { if (walletDropdown && connectWalletBtn && !connectWalletBtn.contains(event.target) && !walletDropdown.contains(event.target)) { walletDropdown.style.display = 'none'; } }); }
            async function connectWithSatsConnect(walletTypeHint = null) { if (typeof SatsConnect === 'undefined' || typeof SatsConnect.getAddresses === 'undefined') { showCustomPopup('Sats Connect library not loaded or not ready.', "Wallet Error"); return; } try { SatsConnect.getAddresses({ payload: { purposes: ['ordinals', 'payment'], message: 'Connect to Punk Voyage Adventures', network: { type: 'Mainnet' }, }, onFinish: (response) => { const ordAddress = response.addresses.find(a => a.purpose === 'ordinals'); const payAddress = response.addresses.find(a => a.purpose === 'payment'); let addr = ordAddress ? ordAddress.address : (payAddress ? payAddress.address : null); if (addr) { let name = walletTypeHint ? walletTypeHint.replace('satsconnect_', '').toUpperCase() : "BTC"; if (name === "GENERAL") name = "BTC"; updateWalletDisplay(addr, name); } }, onCancel: () => console.log('SatsConnect canceled.'), }); } catch (e) { console.error('SatsConnect error:', e); showCustomPopup('An error occurred with SatsConnect.', 'Wallet Error');} }
            async function connectUnisat() { try { if (typeof window.unisat !== 'undefined') { const accounts = await window.unisat.requestAccounts(); if (accounts && accounts.length > 0) { updateWalletDisplay(accounts[0], 'UniSat'); window.unisat.on('accountsChanged', (newAccs) => { if (connectedWalletName === 'UniSat') { const newAccount = (newAccs && newAccs.length > 0) ? newAccs[0] : null; if (newAccount !== connectedAccount) { if(newAccount) { updateWalletDisplay(newAccount, 'UniSat'); } else { if(logoutButton) logoutButton.click();}} } }); } } else { window.open('https://unisat.io/', '_blank'); } } catch (e) { console.error('UniSat error:', e); showCustomPopup('An error occurred with UniSat Wallet.', 'Wallet Error'); } }
            if (walletOptions) { walletOptions.forEach(option => { option.addEventListener('click', async (event) => { const walletType = event.target.dataset.wallet; if(walletDropdown) walletDropdown.style.display = 'none'; if (walletType === 'unisat') await connectUnisat(); else if (walletType && walletType.startsWith('satsconnect_')) { await connectWithSatsConnect(walletType.split('_')[1]); } }); }); }
            if (welcomeConnectWalletBtn && connectWalletBtn) {
                 welcomeConnectWalletBtn.addEventListener('click', () => connectWalletBtn.click());
            }


        }); // End of 'firebaseReady' event listener
    </script>
</body>
</html>