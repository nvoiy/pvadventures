<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punk Voyage Adventures</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@sats-connect/core@latest/dist/bundles/sats-connect.js"></script>
    <style>
        :root {
            --body-bg-image-url: url('https://beige-managing-snail-510.mypinata.cloud/ipfs/bafybeigsu7ak3jbbia6w66slcz2rnk6b6ysundurmgz5etoq6xh23vsbpm');
            --border-color: #000000;
            --text-color: #000000;
            --label-color: #333333; 
            --header-text-color: #333333;
            --game-container-bg: rgba(255, 255, 255, 0.9); 
            --section-bg: rgba(255, 255, 255, 0.8);
            --adventure-block-bg: rgba(255, 255, 255, 0.75);
            --button-bg: #E0E0E0;
            --button-text-color: #000000;
            --button-border: #000000;
            --dropdown-bg: #FFFFFF;
            --twitter-feed-bg: rgba(255, 255, 255, 0.7);
            --highlight-color-pv: #00FF00; 
            --highlight-color-gold: #FFFF00;
            --highlight-color-diamond: #00BFFF; 
            --highlight-color-danger: #FF0000; 
            --highlight-color-connected: #4CAF50;
            --orange-label: #FFA500; 
            --base-font-size: 18px;
            --item-icon-size: 40px; /* Consistent item icon size */
            --menu-icon-size: 1.1em; /* Consistent menu icon size */
            --item-placeholder-boots: #8B4513; --item-placeholder-amulet: #FFD700; 
            --item-placeholder-armour: #C0C0C0; --item-placeholder-helmet: #A9A9A9;
            --item-placeholder-ring: #B8860B; --item-placeholder-weapon: #778899;
            --item-placeholder-misc: #DA70D6; 
            --item-upgrade-plus4-border: #FFA500;
            --item-upgrade-plus5-border: #DC143C; 
        }

        body {
            font-family: 'VT323', monospace;
            background-image: var(--body-bg-image-url); 
            background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: fixed; 
            color: var(--text-color); 
            margin: 0; font-size: var(--base-font-size); 
            display: flex; flex-direction: column; 
            align-items: center; min-height: 100vh; box-sizing: border-box; 
            transition: color 0.3s, background-color 0.3s;
        }

        body.dark-mode {
            --border-color: #777777; 
            --text-color: #FFFFFF;
            --label-color: var(--orange-label); 
            --header-text-color: var(--orange-label); 
            --game-container-bg: rgba(20, 20, 20, 0.9); 
            --section-bg: rgba(30, 30, 30, 0.85);
            --adventure-block-bg: rgba(40, 40, 40, 0.8);
            --button-bg: #444444;
            --button-text-color: #FFFFFF;
            --button-border: #666666;
            --dropdown-bg: #333333;
            --twitter-feed-bg: rgba(25, 25, 25, 0.7);
            --item-upgrade-plus4-border: #FF8C00; 
            --item-upgrade-plus5-border: #FF4500; 
        }
        
        #welcomeScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: var(--body-bg-image-url); 
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat;
            display: flex; 
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 3000; text-align: center; padding: 20px; box-sizing: border-box;
            overflow-y: auto; 
        }
        #welcomeImageLarge { display: block; margin: 0 auto 20px auto; max-width: 80%; max-height: 50vh; object-fit: contain; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        #authFormContainer { background-color: var(--section-bg); padding: 20px 30px; border-radius: 10px; border: 2px solid var(--border-color); box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: background-color 0.3s, border-color 0.3s; z-index: 3001; width: 100%; max-width: 480px; }
        #authFormContainer h2 { margin-top: 0; margin-bottom: 15px; font-size: 1.8em; color: var(--label-color); transition: color 0.3s; }
        body.dark-mode #authFormContainer h2 {  color: var(--orange-label); }
        .auth-form-field { margin-bottom: 12px; text-align: left; }
        .auth-form-field label { display: block; margin-bottom: 4px; font-size: 1.0em; color: var(--label-color); font-weight: bold; transition: color 0.3s; }
        body.dark-mode .auth-form-field label {  color: var(--orange-label); }
        .auth-form-field input { font-family: 'VT323', monospace; font-size: 1.1em; padding: 8px; border: 2px solid var(--border-color); background-color: var(--dropdown-bg); color: var(--text-color); border-radius: 5px; width: calc(100% - 20px); box-sizing: border-box; transition: background-color 0.3s, border-color 0.3s, color 0.3s; }
        .auth-buttons { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; margin-bottom: 10px; }
        #loginButton, #registerButton, #googleSignInButton { font-family: 'VT323', monospace; font-size: 1.2em; padding: 10px 15px; cursor: pointer; border-radius: 5px; transition: background-color 0.2s; width: 100%; box-sizing: border-box; }
        #loginButton, #registerButton { background-color: var(--highlight-color-connected); color: #FFFFFF; border: 2px solid #3c8c3c; }
        #loginButton:hover, #registerButton:hover { background-color: #3e8e41; }
        #googleSignInButton { background-color: #4285F4; color: white; border: 2px solid #3578E5; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        #googleSignInButton:hover { background-color: #3367D6; }
        #googleSignInButton img {  height: 20px; width: 20px; background-color: white; border-radius: 2px; }
        .auth-links-container {  margin-top: 15px; }
        #authToggleLink, #forgotPasswordLink { display: inline-block; margin: 5px 10px; font-size: 0.9em; color: var(--highlight-color-pv); cursor: pointer; text-decoration: underline; }
        #authToggleLink:hover, #forgotPasswordLink:hover { color: var(--highlight-color-gold); }

        .hidden { display: none !important; }

        #customPopupOverlay, #itemSelectionModalOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8); 
            display: flex; 
            justify-content: center; align-items: center;
        }
        #customPopupOverlay { z-index: 2000; }
        #itemSelectionModalOverlay { z-index: 2005; } 

        #customPopup, #itemSelectionModal { 
            background-color: var(--section-bg); border: 3px solid var(--border-color);
            padding: 25px; border-radius: 10px; 
            text-align: center;
            min-width: 350px; max-width: 80%; width: auto; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.4); font-family: 'VT323', monospace;
            color: var(--text-color); box-sizing: border-box;
            position: fixed; 
            top: 50%; left: 50%;
            transform: translate(-50%, -50%); 
        }
        #customPopup { z-index: 2001; }
        #itemSelectionModal { 
            z-index: 2006; 
            max-width: 600px; 
            max-height: 70vh; 
            overflow-y: auto;
        }

        #customPopupTitle, #itemSelectionModalTitle { 
            font-size: 1.8em; margin-top: 0; margin-bottom: 15px;
            color: var(--label-color); 
        }
        #customPopupMessage { font-size: 1.1em; margin-bottom: 25px; line-height: 1.6; white-space: pre-wrap; text-align: left; }
        #customPopupButtons { display: flex; justify-content: center; gap: 15px;}
        #customPopupCloseBtn, #itemSelectionModalCloseBtn, #popupCraftAgainBtn, #customPopupConfirmBtn, #customPopupCancelBtn { font-size: 1.2em; padding: 10px 20px; min-width: 100px; margin-top: 15px; }
        #popupCraftAgainBtn, #customPopupConfirmBtn { background-color: var(--highlight-color-connected); color:white;}


        .game-container { width: 98%; max-width: none; margin: 10px auto; border: 3px solid var(--border-color); padding: 15px; background-color: var(--game-container-bg); box-shadow: 0px 0px 15px rgba(0,0,0,0.5); box-sizing: border-box; display: flex; flex-direction: column; transition: background-color 0.3s, border-color 0.3s; }
        header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 2px solid var(--border-color); margin-bottom: 15px; width: 100%; transition: border-color 0.3s; }
        .header-title-container { display: flex; align-items: center; margin-right: auto; }
        .header-title-container img.header-logo { height: 80px; width: auto; margin-right: 15px; }
        header h1 { font-size: 2.5em; margin: 0; letter-spacing: 2px; color: var(--header-text-color); transition: color 0.3s; flex-shrink: 0; }
        .header-byline { font-size: 0.9em; color: white; margin-left: 10px; font-weight: normal; align-self: flex-end; padding-bottom: 5px; }
        body:not(.dark-mode) .header-byline { color: #333333; }

        .header-controls { display: flex; align-items: center; gap: 15px;  }
        .player-info-wallet { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        .player-stats { text-align: right; font-size: 1em; } 
        .player-stats .pv { color: var(--highlight-color-pv); font-weight: bold; } 
        .player-stats .gold { color: var(--highlight-color-gold); font-weight: bold; } 
        .player-stats .diamond { color: var(--highlight-color-diamond); font-weight: bold; }
        .player-stats .wallet-address { font-size: 0.9em; color: var(--highlight-color-connected); word-break: break-all; }
        .wallet-connector { position: relative; }
        .connect-wallet-btn, .menu-button, .social-btn-link button, .adventure-send-btn, .action-button, .craft-button, .equip-btn, .unequip-btn, .swap-btn, .raffle-action-btn, #signOutButton, #upgradeItemButton, .leaderboard-filter-btn, .use-rider-scroll-btn { background-color: var(--button-bg); border: 2px solid var(--button-border); padding: 6px 12px; color: var(--button-text-color); cursor: pointer; font-family: 'VT323', monospace; font-size: 1em; text-align: center; transition: background-color 0.3s, border-color 0.3s, color 0.3s; }
        .connect-wallet-btn, .menu-button, #signOutButton { min-width: 160px; }
        #signOutButton { background-color: var(--highlight-color-danger); color: white; border-color: var(--highlight-color-danger); }
        body:not(.dark-mode) #signOutButton:hover { background-color: #cc0000; }
        body.dark-mode #signOutButton:hover { background-color: #dd0000; }
        .leaderboard-filter-btn.active { background-color: var(--highlight-color-connected); color: white; }
        .use-rider-scroll-btn { font-size: 0.85em; padding: 3px 6px; margin-top: 5px; }


        .header-controls .socials-nav { padding: 0; border: none; background-color: transparent; display: flex; align-items: center; gap: 10px; }
        .header-controls .socials-nav .social-title { font-size: 1.1em; margin-bottom: 0; }
        .header-controls .socials-nav .social-buttons { gap: 10px; display: flex; align-items: center; }
        .social-icon-link img { height: 30px; width: auto; vertical-align: middle; border: 1px solid var(--button-border); padding: 3px; background-color: var(--button-bg); border-radius: 4px; transition: filter 0.2s; }
        .social-icon-link img:hover { filter: brightness(0.85); }

        body:not(.dark-mode) .connect-wallet-btn:hover, body:not(.dark-mode) .menu-button:hover, body:not(.dark-mode) .social-btn-link button:hover, body:not(.dark-mode) .adventure-send-btn:hover, body:not(.dark-mode) .action-button:hover, body:not(.dark-mode) .craft-button:hover, body:not(.dark-mode) .equip-btn:hover, body:not(.dark-mode) .unequip-btn:hover, body:not(.dark-mode) .swap-btn:hover, body:not(.dark-mode) .raffle-action-btn:hover, body:not(.dark-mode) #upgradeItemButton:hover, body:not(.dark-mode) .leaderboard-filter-btn:not(.active):hover, body:not(.dark-mode) .use-rider-scroll-btn:hover { background-color: #cccccc; }
        body.dark-mode .connect-wallet-btn:hover, body.dark-mode .menu-button:hover, body.dark-mode .social-btn-link button:hover, body.dark-mode .adventure-send-btn:hover, body.dark-mode .action-button:hover, body.dark-mode .craft-button:hover, body.dark-mode .equip-btn:hover, body.dark-mode .unequip-btn:hover, body.dark-mode .swap-btn:hover, body.dark-mode .raffle-action-btn:hover, body.dark-mode #upgradeItemButton:hover, body.dark-mode .leaderboard-filter-btn:not(.active):hover, body.dark-mode .use-rider-scroll-btn:hover { background-color: #555555;}
        .connect-wallet-btn.connected { background-color: var(--highlight-color-connected); color: white; border-color: var(--highlight-color-connected); }
        .wallet-dropdown { display: none; position: absolute; top: 100%; right: 0; background-color: var(--dropdown-bg); color: var(--text-color); border: 2px solid var(--border-color); list-style: none; padding: 0; margin: 5px 0 0 0; width: 100%; z-index: 10; box-shadow: 0px 3px 7px rgba(0,0,0,0.2); transition: background-color 0.3s, border-color 0.3s, color 0.3s; }
        .wallet-dropdown li { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid var(--border-color); text-align: center; transition: background-color 0.3s, border-color 0.3s; } .wallet-dropdown li:last-child { border-bottom: none; }
        body:not(.dark-mode) .wallet-dropdown li:hover { background-color: #f0f0f0; } body.dark-mode .wallet-dropdown li:hover { background-color: #4a4a4a; }
        .main-content { display: flex; gap: 20px; width: 100%; flex-grow: 1; }
        .left-sidebar { width: 300px; display: flex; flex-direction: column; gap: 20px; flex-shrink: 0; }
        .twitter-feed-container { border: 2px solid var(--border-color); padding: 10px; background-color: var(--twitter-feed-bg); height: auto; min-height: 250px; overflow-y: auto; display: flex; flex-direction: column; transition: background-color 0.3s, border-color 0.3s; margin-top: 20px; }
        .twitter-feed-container .twitter-timeline { width: 100% !important; }
        #availableAdventurersDisplay, .materials-display, #playerCombatStatsDisplay { border: 2px solid var(--border-color); padding: 10px; background-color: var(--section-bg); transition: background-color 0.3s, border-color 0.3s; }
        #availableAdventurersDisplay, #playerCombatStatsDisplay { text-align:center; font-size: 1.2em; } 
        #playerCombatStatsDisplay h4 {font-size: 1.2em; margin-top:0; margin-bottom: 8px; color: var(--label-color);}
        #playerCombatStatsDisplay p {font-size: 1em; margin: 5px 0;}

        .socials-nav .social-title, .adventure-controls label, .page-title, .materials-display h4, .adventures-label, #activeAdventuresDisplay_page h3, 
        .equipment-slots-container h4, #inventory-page > h4, .shop-section-wrapper h3, #crafting-page h2, .swap-section h3, #whitelist-page h3, #upgrade-page h3, #leaderboard-page h3, #dungeons-page h3 {  color: var(--label-color); font-weight: bold; transition: color 0.3s; }
        .materials-display h4 {font-size: 1.2em; margin-top:0; margin-bottom: 8px;} 
        .materials-display .material-tier-title, .materials-display .upgrade-scrolls-title { font-size: 1.1em; font-weight: bold; margin-top:10px; margin-bottom:5px; color: var(--label-color); }
        .materials-display .upgrade-scrolls-title { color: var(--highlight-color-pv); } 
        body.dark-mode .materials-display .upgrade-scrolls-title { color: var(--highlight-color-pv); }

        .materials-display ul { list-style: none; padding: 0; margin: 5px 0 0 0; font-size: 1em; } .materials-display li { margin-bottom: 3px; }
        .main-content-area { flex-grow: 1; display: flex; }
        .page-content { display: none; width: 100%; flex-direction: column; padding: 0 15px; box-sizing: border-box; overflow-y: auto; flex-grow: 1;} 
        .page-content.active { display: flex; }

        #adventures-page { flex-direction: row; align-items: flex-start; gap: 25px; padding:0; }
        .player-character-area { display: none; }
        .adventure-section-wrapper { display: flex; flex-direction: column; flex-grow: 1; align-items: center; } 
        .adventures-label { font-size: 2em; margin-bottom: 10px; text-align: center; width: 100%; }
        #adventureMilestoneInfo { text-align: center; font-size: 0.95em; margin-bottom: 15px; color: var(--highlight-color-diamond); }
        .adventure-locations { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .adventure { display: flex; align-items: center; gap: 20px; width: 100%; max-width: 800px; background-color: var(--adventure-block-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); box-sizing: border-box; transition: background-color 0.3s, border-color 0.3s; position: relative; }
        .adventure-lock-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(30, 30, 30, 0.85); color: var(--highlight-color-danger); display: flex; justify-content: center; align-items: center; text-align: center; font-size: 1.1em; font-weight: bold; padding: 15px; box-sizing: border-box; border-radius: 8px; z-index: 5; line-height: 1.4; }
        .adventure-lock-overlay.hidden { display: none; }
        .adventure.locked-by-progression .adventure-send-btn, .adventure.locked-by-progression .adventure-num-select { filter: grayscale(100%) opacity(0.7); cursor: not-allowed !important; }
        .adventure-icon { width: 150px; height: 150px; border: 2px solid var(--border-color); background-size: cover; background-position: center; background-repeat: no-repeat; flex-shrink: 0; border-radius: 5px; transition: border-color 0.3s; }
        .adventure-icon.tree { background-image: url('https://beige-managing-snail-510.mypinata.cloud/ipfs/bafybeiblzgkncylseo57qr7kyhsxdgb3bq2aghcmj6gdf2ihhagpxp3uoy/adventure1.png'); } 
        .adventure-icon.mountain { background-image: url('https://beige-managing-snail-510.mypinata.cloud/ipfs/bafybeiblzgkncylseo57qr7kyhsxdgb3bq2aghcmj6gdf2ihhagpxp3uoy/adventure2.png'); } 
        .adventure-icon.fire-fields { background-image: url('https://beige-managing-snail-510.mypinata.cloud/ipfs/bafybeiblzgkncylseo57qr7kyhsxdgb3bq2aghcmj6gdf2ihhagpxp3uoy/adventure3.png'); }
        .adventure-icon.tomb { background-image: url('https://beige-managing-snail-510.mypinata.cloud/ipfs/bafybeignh3fvjn5cxire5d52foozgud23boulezgssmw6egepvoty5vk3q'); }
        .adventure-main-info { flex-grow: 1; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; } 
        .adventure-content { display: flex; flex-direction: column; gap: 10px; } 
        .adventure-details { font-size: 1.1em; line-height: 1.5; } 
        .adventure-details .prize { color: var(--highlight-color-pv); font-weight: bold; } 
        .adventure-details .chance-gold { color: var(--highlight-color-gold); font-weight: bold; } 
        .adventure-details .chance-diamond { color: var(--highlight-color-diamond); font-weight: bold; }
        .adventure-requirement { color: var(--highlight-color-danger); font-weight: bold; font-size: 0.9em; margin-top: 5px;}
        .adventure-controls { display: flex; align-items: center; gap: 12px; margin-top: 10px; } 
        .adventure-controls label { font-size: 1.1em; } 
        .adventure-num-select { font-family: 'VT323', monospace; font-size: 1em; padding: 4px; border: 2px solid var(--border-color); background-color: var(--dropdown-bg); color: var(--text-color); min-width: 40px; transition: background-color 0.3s, border-color 0.3s, color 0.3s; } 
        .adventure-send-btn { padding: 6px 10px; font-size: 1em; } 
        .adventure-send-btn.active-adv1 { background-color: var(--highlight-color-pv); color: black;} 
        .adventure-send-btn.active-adv2 { background-color: var(--highlight-color-gold); color: black;} 
        .adventure-send-btn.active-adv3, .adventure-send-btn.active-adv4 { background-color: var(--highlight-color-danger); color: white;}
        .adventure-drops-area { position: relative; align-self: flex-start; min-height: 100px; } 
        .adventure-drops-button { font-size: 1em; padding: 4px 10px; } 
        .drops-popover { display: none; position: absolute; top: calc(100% + 5px); left: 50%; transform: translateX(-50%); background-color: var(--section-bg); border: 1px solid var(--border-color); padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 20; width: 220px; min-width: 180px; font-size: 1em; text-align: left; transition: background-color 0.3s, border-color 0.3s; } 
        .drops-popover h5 { margin: 0 0 5px 0; color: var(--label-color); transition: color 0.3s;} 
        .drops-popover ul { list-style: none; padding: 0; margin: 0; } 
        .drops-popover li { margin-bottom: 3px; }
        
        #active-adventures-page .active-adventures-container { margin-top: 0; width:100%; max-width:none; padding: 10px; border: none; background-color: transparent; box-shadow:none; }
        #active-adventures-page .active-adventures-container h3 { font-size: 1.6em; text-align:left; margin-bottom:10px;}
        #active-adventures-page .active-adventure-item { font-size:1em; padding:10px; background-color: var(--adventure-block-bg); border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 8px;}
        #active-adventures-page .active-adventure-item p { margin: 4px 0; font-size: 1.1em; line-height: 1.6; }
        
        .right-sidebar-menu { width: 300px; flex-shrink: 0; display: flex; flex-direction: column; gap: 0; border: 2px solid var(--border-color); background-color: var(--section-bg); padding: 10px; box-sizing: border-box; transition: background-color 0.3s, border-color 0.3s; }
        .right-sidebar-menu .menu-button-container-fixed { text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .right-sidebar-menu .menu-button { min-width: auto; width: 85%; padding: 10px 15px; font-size: 1.4em; }
        .sidebar-content-area { flex-grow: 1; overflow-y: auto; }
        .main-menu-nav-list { list-style: none; padding: 0; margin: 0; }
        .main-menu-nav-list li { padding: 12px 8px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: border-color 0.3s, background-color 0.3s; font-size: 1.25em; text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .main-menu-nav-list li img.menu-item-icon { height: var(--menu-icon-size); width: var(--menu-icon-size); object-fit: contain; vertical-align: middle; }
        .main-menu-nav-list li:last-child { border-bottom: none; } body:not(.dark-mode) .main-menu-nav-list li:hover { background-color: #f0f0f0; } body.dark-mode .main-menu-nav-list li:hover { background-color: #4a4a4a; }
        
        .sidebar-active-adventures-container { padding-top: 10px; } 
        .sidebar-active-adventures-container h3 { font-size: 1.3em; text-align: center; margin-bottom: 10px; color: var(--label-color); }
        .sidebar-active-adventures-container .active-adventure-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.95em; padding: 8px; margin-bottom: 8px; background-color: var(--adventure-block-bg); border: 1px solid var(--border-color); border-radius: 4px; }
        .sidebar-active-adventures-container .active-adventure-item-info { flex-grow: 1; }
        .sidebar-active-adventures-container .active-adventure-item p { margin: 3px 0; }
        .cancel-adventure-btn { background-color: transparent; border: none; color: var(--highlight-color-danger); font-size: 1.5em; cursor: pointer; padding: 0 5px; line-height: 1; }
        .cancel-adventure-btn:hover { color: darkred; }


        .active-potions-display { padding-top: 15px; margin-top: 15px; border-top: 1px solid var(--border-color); }
        .active-potions-display h4 { font-size: 1.3em; text-align: center; margin-bottom: 10px; color: var(--label-color); }
        .active-potions-display .potion-item { font-size: 0.95em; padding: 8px; margin-bottom: 8px; background-color: var(--adventure-block-bg); border: 1px solid var(--border-color); border-radius: 4px; }
        .active-potions-display .potion-item p { margin: 3px 0; }

        .dark-mode-switch { display: flex; align-items: center; gap: 8px; } .dark-mode-switch label { font-size: 1em; color: var(--text-color); cursor: pointer; transition: color 0.3s; } .switch { position: relative; display: inline-block; width: 50px; height: 24px; } .switch input { opacity: 0; width: 0; height: 0; } .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; } .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; } input:checked + .slider { background-color: var(--highlight-color-connected); } input:focus + .slider { box-shadow: 0 0 1px var(--highlight-color-connected); } input:checked + .slider:before { transform: translateX(26px); }
        .page-title { font-size: 2.2em; margin-bottom: 25px; text-align:center; width:100%; }
        
        #shop-page { align-items: center; flex-direction: column; }
        .shop-top-section {
            display: flex;
            flex-direction: row;
            gap: 20px;
            align-items: flex-start;
            width: 100%;
            max-width: 900px; /* Adjusted for better spacing */
            margin-bottom: 30px;
            margin-left: auto;
            margin-right: auto;
        }
        .shop-image-container {
            flex: 1; /* Takes up available space */
            max-width: 350px; /* Max width for the image */
        }
        .shop-image-container img {
            width: 100%;
            height: auto;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            display: block;
            margin: 0 auto; /* Center image if container is wider */
        }
        .swap-section-container {
            flex: 1; /* Takes up available space */
            display: flex;
            flex-direction: column;
            align-items: center; /* Center the swap-section div */
             max-width: 350px;
        }
        @media (max-width: 800px) {
            .shop-top-section {
                flex-direction: column;
                align-items: center;
            }
            .shop-image-container, .swap-section-container {
                max-width: 80%;
                margin-bottom: 20px;
            }
        }
        #reverseSwapDirectionBtn img {
            height: 24px; /* Adjust size as needed */
            width: auto;
            vertical-align: middle;
        }
        #reverseSwapDirectionBtn {
            padding: 6px 10px; /* Adjust padding if needed */
            line-height: 0; /* May help align icon if it has extra space */
        }


        #crafting-page { align-items: center; flex-direction: column; }
        .crafting-gif-container { flex: 1; max-width: 50%; margin: 0 auto 20px auto;}
        .crafting-gif-container img { width: 100%; max-width: 400px; height: auto; border: 2px solid var(--border-color); border-radius: 8px; display: block; margin: 0 auto; }
        
        .swap-section h3 { font-size: 1.8em; text-align: center; margin-bottom: 15px; }
        .shop-section-wrapper, .crafting-section-wrapper { width: 100%; max-width: 800px; margin-bottom:30px;} .shop-section-wrapper h3, #crafting-page h3 { font-size: 1.8em; text-align: center; margin-bottom: 20px; color: var(--label-color); }
        .quest-list, .shop-items, .crafting-items-container, .inventory-items-container { display: flex; flex-direction: column; gap: 18px; width:100%; max-width:800px; margin:0 auto; }
        .quest-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--adventure-block-bg); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; transition: background-color 0.3s, border-color 0.3s; }
        .quest-item .quest-info { flex-grow: 1; }
        .quest-item .quest-actions { text-align: right; flex-shrink: 0; display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        .shop-item, .craftable-item-card, .inventory-item-card { position:relative; background-color: var(--adventure-block-bg); border: 1px solid var(--border-color); padding: 18px; border-radius: 8px; display: flex; align-items: center; transition: background-color 0.3s, border-color 0.3s; gap: 15px; }
        .quest-item p, .shop-item p, .craftable-item-card p, .inventory-item-card p { font-size: 1.05em; margin:3px 0; }
        .quest-item .quest-reward, .shop-item .shop-price, .craftable-item-card .crafting-cost, .inventory-item-card .item-type { margin-left: auto; white-space: nowrap; text-align: right; }
        .shop-item .shop-price { color: var(--highlight-color-pv); } .action-button { padding: 6px 12px; font-size: 0.9em; } 
        .shop-item .quantity-selector { font-family: 'VT323', monospace; font-size: 0.9em; padding: 4px; border: 1px solid var(--border-color); background-color: var(--dropdown-bg); color: var(--text-color); width: 50px; margin-right: 8px; }
        
        .help-content { width: 100%; max-width: 900px; margin: 0 auto; }
        .help-content p, .help-content ul, .help-content h3, .help-content h4 { font-size: 1.05em; margin-bottom: 10px; line-height: 1.7; }
        .help-content h3 { font-size: 1.5em; margin-top: 20px; color: var(--label-color); }
        .help-content h4 { font-size: 1.2em; margin-top: 15px; color: var(--label-color); }
        .help-content ul { list-style: disc; padding-left: 25px; }
        .help-content strong { color: var(--highlight-color-pv); }
        body.dark-mode .help-content strong { color: var(--highlight-color-gold); }
        .help-gif-container { text-align: center; margin: 25px 0; }
        .help-gif-container img { max-width: 80%; height: auto; border: 2px solid var(--border-color); border-radius: 8px; }

        .item-icon-placeholder { width: var(--item-icon-size); height: var(--item-icon-size); border: 1px solid var(--border-color); border-radius: 4px; margin-right: 10px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 0.7em; overflow:hidden; }
        .item-icon-placeholder img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .upgrade-slot .item-icon-placeholder { width: calc(var(--item-icon-size) + 10px) ; height: calc(var(--item-icon-size) + 10px); } 

        .craftable-item-card .item-info, .inventory-item-card .item-info { flex-grow: 1; }
        .crafting-cost small, .item-perk small { display: block; font-size: 0.9em; opacity: 0.8; }
        .equip-btn, .unequip-btn { font-size: 0.9em; padding: 4px 8px; margin-left: 5px; }
        .inventory-item-card .equipped-status { font-size: 0.9em; color: var(--highlight-color-connected); margin-left: 10px; }
        .inventory-item-card .use-btn { font-size: 0.9em; padding: 4px 8px; margin-left: 10px; background-color: var(--highlight-color-pv); color: black;}
        .inventory-item-card.item-level-plus4 { border: 2px solid var(--item-upgrade-plus4-border) !important; box-shadow: 0 0 8px var(--item-upgrade-plus4-border); }
        .inventory-item-card.item-level-plus5 { border: 2px solid var(--item-upgrade-plus5-border) !important; box-shadow: 0 0 10px var(--item-upgrade-plus5-border); }

        .equipment-slots-container { margin-bottom: 30px; padding: 15px; border: 1px dashed var(--border-color); border-radius: 5px; width: 100%; max-width: 800px; box-sizing: border-box; margin-left:auto; margin-right:auto; }
        .equipment-slots-container h4 { margin-top: 0; margin-bottom: 15px; text-align: center; color: var(--label-color); font-size: 1.8em; }
        .equipment-slots { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; } 
        .equipment-slot { border: 1px solid var(--border-color); background-color: var(--adventure-block-bg); padding: 10px; border-radius: 4px; text-align: center; min-height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: background-color 0.3s, border-color 0.3s; position: relative; } /* Added position relative for tooltip handling */
        .equipment-slot.locked .slot-name::after { content: ""; font-size: 0.8em; }
        .equipment-slot .slot-name { font-size: 1em; margin-bottom: 8px; color: var(--label-color); font-weight:normal; }
        .equipment-slot .item-icon-placeholder { margin-bottom: 5px; width: var(--item-icon-size); height: var(--item-icon-size); font-size: 0.7em; }
        .equipment-slot .equipped-item-name { font-size: 0.95em; font-weight: bold; margin-bottom: 5px; }
        .equipment-slot .equipped-item-container { /* New container for tooltip */ display: flex; flex-direction: column; align-items: center; cursor: default; /* Or pointer if interactive */ }
        .equipment-slot .empty-slot-text { font-size: 0.9em; opacity: 0.7; }
        .equipment-slot.item-level-plus4 { border: 2px solid var(--item-upgrade-plus4-border) !important; box-shadow: 0 0 8px var(--item-upgrade-plus4-border); }
        .equipment-slot.item-level-plus5 { border: 2px solid var(--item-upgrade-plus5-border) !important; box-shadow: 0 0 10px var(--item-upgrade-plus5-border); }

        #inventory-page { align-items: center; }
        #inventory-page > h4 { font-size: 1.8em; color: var(--label-color); margin-top: 25px; margin-bottom: 15px; text-align: center; width: 100%; max-width: 800px; margin-left:auto; margin-right:auto; }
        
        #daily-rewards-page .rewards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 20px; }
        #daily-rewards-page .reward-day { border: 1px solid var(--border-color); background-color: var(--adventure-block-bg); padding: 10px; border-radius: 5px; text-align: center; }
        #daily-rewards-page .reward-day h5 { margin: 0 0 5px 0; color: var(--label-color); }
        #daily-rewards-page .reward-day p { margin: 0; font-size: 0.9em; }
        #daily-rewards-page .reward-day button { margin-top: 8px; }

        .swap-section { margin-top:10px; text-align: center;} 
        .swap-section .swap-info { margin-bottom: 10px; font-size: 1.1em; }
        .swap-btn { padding: 8px 15px; font-size: 1.1em; }

        #upgrade-page { align-items: center; flex-direction: column; }
        .upgrade-main-image-container { text-align: center; margin-bottom: 20px; }
        .upgrade-main-image-container img { max-width: 250px; width: 100%; height: auto; }
        .upgrade-interface { display: flex; flex-direction: column; align-items: center; gap: 15px; padding: 20px; background-color: var(--adventure-block-bg); border: 1px solid var(--border-color); border-radius: 8px; width: 100%; max-width: 500px; }
        .upgrade-slot { width: 120px; height: 120px; border: 2px dashed var(--border-color); border-radius: 5px; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 0.9em; background-color: var(--section-bg); color: var(--label-color); cursor: pointer; flex-direction: column; }
        .upgrade-slot img.icon-preview { max-width: var(--item-icon-size); max-height: var(--item-icon-size); margin-bottom: 5px; object-fit: contain; } 
        .upgrade-slot.filled { border-style: solid; }
        #selectedItemForUpgradeDisplay, #selectedScrollForUpgradeDisplay { font-size: 1em; text-align: center; display: flex; flex-direction:column; align-items: center; justify-content: center; gap: 5px; }
        #upgradeSuccessRateDisplay { margin-top: 10px; font-size: 1.1em; font-weight: bold; color: var(--label-color); }
        #upgradeResultDisplay { margin-top: 10px; font-size: 1.1em; font-weight: bold; }

        #whitelist-page { align-items: center; } 
        #adminRafflePanel { background-color: var(--section-bg); padding: 20px; border: 2px solid var(--border-color); border-radius: 8px; margin-bottom: 30px; width: 100%; max-width: 700px; box-shadow: 0 3px 10px rgba(0,0,0,0.15); }
        #adminRafflePanel h3 { text-align: center; margin-bottom: 15px; font-size: 1.6em; }
        .admin-form-group { margin-bottom: 12px; }
        .admin-form-group label { display: block; margin-bottom: 5px; font-size: 1.1em; color: var(--label-color); }
        .admin-form-group input[type="text"], .admin-form-group input[type="number"], .admin-form-group textarea { width: calc(100% - 20px); padding: 8px; font-family: 'VT323', monospace; font-size: 1em; border: 1px solid var(--border-color); background-color: var(--dropdown-bg); color: var(--text-color); border-radius: 4px; }
        .admin-form-group textarea { min-height: 60px; }
        #whitelistRafflesContainer { display: flex; flex-direction: column; gap: 20px; width: 100%; max-width: 800px; }
        .raffle-card { background-color: var(--adventure-block-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; display: flex; gap: 20px; align-items: flex-start; }
        .raffle-card-image { width: 120px; height: 120px; background-size: cover; background-position: center; border: 1px solid var(--border-color); border-radius: 5px; flex-shrink: 0; }
        .raffle-card-image.placeholder { display: flex; align-items: center; justify-content: center; background-color: #555; color: white; font-size: 0.9em; }
        .raffle-card-content { flex-grow: 1; }
        .raffle-card-content h4 { margin: 0 0 10px 0; font-size: 1.5em; color: var(--label-color); }
        .raffle-card-content p { margin: 5px 0; font-size: 1em; line-height: 1.5; }
        .raffle-card-description { margin-bottom: 10px !important; }
        .raffle-card-socials a { margin-right: 10px; text-decoration: none; color: var(--highlight-color-connected); font-weight: bold; }
        .raffle-card-socials a:hover { text-decoration: underline; }
        .raffle-card-cost { margin-top: 10px; font-size: 0.95em; }
        .raffle-card-cost .pv { color: var(--highlight-color-pv); } .raffle-card-cost .gold { color: var(--highlight-color-gold); } .raffle-card-cost .diamond { color: var(--highlight-color-diamond); }
        .raffle-card-status { margin-top: 10px; font-weight: bold; }
        .raffle-card-winners ul { list-style: disc; padding-left: 20px; margin-top: 5px;}
        .raffle-admin-actions button { margin-right: 10px; margin-top:5px; }

        #leaderboard-page { align-items: center; flex-direction: column; }
        .leaderboard-filters { margin-bottom: 20px; display:flex; gap: 10px; }
        .leaderboard-container { width: 100%; max-width: 700px; margin-bottom: 30px; background-color: var(--section-bg); padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; }
        .leaderboard-container h4 { font-size: 1.5em; color: var(--label-color); text-align: center; margin-bottom: 15px; }
        .leaderboard-list { list-style: none; padding: 0; margin: 0; }
        .leaderboard-list li { display: flex; justify-content: space-between; padding: 8px 5px; border-bottom: 1px solid var(--border-color); font-size: 1.1em; }
        .leaderboard-list li:last-child { border-bottom: none; }
        .leaderboard-list .rank { margin-right: 10px; color: var(--label-color); }
        .leaderboard-list .nickname { flex-grow: 1; }
        .leaderboard-list .score { font-weight: bold; }
        .leaderboard-list .score.pv { color: var(--highlight-color-pv); } .leaderboard-list .score.gold { color: var(--highlight-color-gold); } .leaderboard-list .score.diamond { color: var(--highlight-color-diamond); }

        /* Dungeons Page Specific Styles */
        #dungeons-page .help-gif-container img { /* Ensure the main image isn't too large */
            max-width: 600px; /* Or your preferred size */
            width: 90%; /* Responsive width */
            height: auto;
            border: 2px solid var(--border-color);
            border-radius: 8px;
        }
        .dungeon-entry {
            display: flex;
            align-items: center;
            gap: 20px;
            width: 100%;
            background-color: var(--adventure-block-bg);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-sizing: border-box;
        }
        .dungeon-entry.locked {
            filter: grayscale(70%) opacity(0.8);
        }
        .dungeon-icon-placeholder {
            width: 80px;
            height: 80px;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: white;
            font-weight: bold;
        }
        .dungeon-info {
            flex-grow: 1;
        }
        .dungeon-info h3 {
            margin: 0 0 10px 0;
            font-size: 1.4em;
            color: var(--label-color);
        }
        .dungeon-info p {
            margin: 5px 0;
            font-size: 1em;
        }
        .dungeon-requirements {
            color: var(--highlight-color-danger);
            font-weight: bold;
        }
        .enter-dungeon-btn {
            padding: 8px 15px;
            font-size: 1.1em;
        }
    
        /* Tooltip Styles */
        #itemTooltip {
            position: fixed; 
            background-color: var(--section-bg);
            border: 2px solid var(--border-color);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            z-index: 10000; 
            font-size: 0.95em;
            line-height: 1.5;
            max-width: 320px; 
            display: none; 
            pointer-events: none; 
            font-family: 'VT323', monospace;
            color: var(--text-color);
        }
        #itemTooltip h5 { 
            margin: 0 0 8px 0; 
            color: var(--label-color); 
            font-size: 1.1em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        body.dark-mode #itemTooltip h5 { color: var(--orange-label); }
        #itemTooltip p { margin: 4px 0; }
        #itemTooltip ul { list-style: none; padding-left: 0; margin: 6px 0; }
        #itemTooltip ul li { margin-bottom: 3px; }
        #itemTooltip small { opacity: 0.9; display: block; margin-top: 3px;}
        #itemTooltip .perk-info { color: var(--highlight-color-pv); font-weight: bold;}
        body.dark-mode #itemTooltip .perk-info { color: var(--highlight-color-gold);}
        #itemTooltip .recipe-info { margin-top: 8px; font-size: 0.9em;}
        #itemTooltip .recipe-info strong { color: var(--label-color); }
        body.dark-mode #itemTooltip .recipe-info strong { color: var(--orange-label); }
    </style>
</head>
<body>
    <div id="itemTooltip"></div> <!-- Tooltip Element -->
    <div id="welcomeScreen">
        <img id="welcomeImageLarge" src="https://beige-managing-snail-510.mypinata.cloud/ipfs/bafybeiblrc356d6jb72bgbxmo475c7si4ae5gmugw3nlb2citjiz4jzibm" alt="Punk Voyage Adventures Welcome">
        <div id="authFormContainer">
            <h2 id="authFormTitle">Login to Punk Voyage Adventures</h2>
            <form id="loginRegisterForm">
                <div class="auth-form-field">
                    <label for="authEmail">Email:</label>
                    <input type="email" id="authEmail" autocomplete="email">
                </div>
                <div class="auth-form-field">
                    <label for="authPassword">Password:</label>
                    <input type="password" id="authPassword" autocomplete="current-password">
                </div>
                <div class="auth-form-field hidden" id="authNicknameField">
                    <label for="authNickname">Nickname (for in-game display):</label>
                    <input type="text" id="authNickname" maxlength="20">
                </div>
                <div class="auth-buttons">
                    <button type="button" id="loginButton">Login</button>
                    <button type="button" id="registerButton" class="hidden">Register</button>
                </div>
            </form>
            <button type="button" id="googleSignInButton">
                <img src="https://beige-managing-snail-510.mypinata.cloud/ipfs/bafkreidpivlm24hjxcx7wlknozui7lgwpbtoaeio7dqqeg3b4drbcpwesu" alt="Google G Logo">
                Sign in with Google
            </button>
            <div class="auth-links-container">
                <a id="authToggleLink">Need an account? Register</a>
                <a id="forgotPasswordLink">Forgot Password?</a>
            </div>
        </div>
    </div>

    <div class="game-container hidden" id="gameContainer">
        <header> 
            <div class="header-title-container">
                <img src="https://beige-managing-snail-510.mypinata.cloud/ipfs/bafkreige4cba5c3bwwknrhupt3upkz5he7orgz2m7ygilbqmhmb2bsmd5q" alt="Punk Voyage Logo" class="header-logo">
                <h1>PUNK VOYAGE ADVENTURES</h1>
                <span class="header-byline">by NV.Art</span>
            </div>
            <div class="header-controls"> 
                <div class="player-info-wallet"> 
                     <div class="player-stats" id="playerStats"> PLAYER <span id="playerNicknameDisplay">Voyager</span>, WELCOME<br> <span class="pv">PV = <span id="pvCount">0</span></span> , <span class="gold">GOLD = <span id="goldCount">0</span></span>, <span class="diamond">DIAMOND = <span id="diamondCount">0</span></span> <div class="wallet-address" id="walletAddressDisplay"></div> 
                    </div> 
                    <div class="wallet-connector"><button class="connect-wallet-btn" id="connectWalletBtn">CONNECT WALLET</button><ul class="wallet-dropdown" id="walletDropdown"><li data-wallet="satsconnect_xverse">XVERSE</li><li data-wallet="unisat">UNISAT</li><li data-wallet="satsconnect_magiceden">MAGIC EDEN</li><li data-wallet="satsconnect_general">ANY BTC WALLET</li></ul>
                    </div> 
                </div>
                 <button id="signOutButton" class="hidden">Sign Out</button> 
                <nav class="socials-nav" id="headerSocialsNav"> 
                    <div class="social-title">SOCIALS</div> 
                    <div class="social-buttons"> 
                        <a href="https://x.com/nvart_" target="_blank" class="social-icon-link">
                            <img src="https://beige-managing-snail-510.mypinata.cloud/ipfs/bafkreic6eqw6jyae55x3uhqtvrbt2woamgifhtck5vquluwlwvl2yhjj7q" alt="X/Twitter">
                        </a> 
                        <a href="https://discord.com/invite/4CEtXAFf3x" target="_blank" class="social-icon-link">
                            <img src="https://beige-managing-snail-510.mypinata.cloud/ipfs/bafkreidjwxzcb5qeb76qjgo4ft5ha3fuskaxkeho7ppv7umoc5ihm5ohwq" alt="Discord">
                        </a> 
                        <a href="https://magiceden.io/tr/ordinals/marketplace/punkvoyage" target="_blank" title="Punk Voyage on Magic Eden" class="social-icon-link">
                            <img src="https://beige-managing-snail-510.mypinata.cloud/ipfs/bafkreihixbhp2x6w7w5odpo5zyt2dbqdd54f3eepgvmt3zsfg7ax6jnftu" alt="Magic Eden">
                        </a>
                    </div> 
                </nav>
                <div class="dark-mode-switch"> 
                    <label for="darkModeToggle">Dark Mode</label> 
                    <label class="switch"> <input type="checkbox" id="darkModeToggle"> <span class="slider"></span> </label> 
                </div> 
            </div> 
        </header>
        <main class="main-content">
            <aside class="left-sidebar"> 
                <div id="availableAdventurersDisplay"> Available Adventurers: <span id="availableAdventurersCount">5</span> </div> 
                <div id="playerCombatStatsDisplay" class="materials-display" style="text-align:center;">
                    <h4>COMBAT STATS</h4>
                    <p>Attack: <span id="playerAttackStat">0</span></p>
                    <p>Defense: <span id="playerDefenseStat">0</span></p>
                </div>
                <div class="materials-display" id="materialsDisplay"> 
                    <h4>MY MATERIALS</h4> 
                    <div id="materialsListContainer"></div>
                </div> 
                <div class="twitter-feed-container" id="twitter-widget-container"> <a class="twitter-timeline" data-dnt="true" href="https://twitter.com/nvart_?ref_src=twsrc%5Etfw">Tweets by nvart_</a> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> </div> 
            </aside>
            <div class="main-content-area">
                <section id="adventures-page" class="page-content active"> 
                    <div class="player-character-area"> 
                        <div class="player-character" aria-label="Player Character Image"></div> 
                    </div> 
                    <div class="adventure-section-wrapper"> 
                        <h2 class="adventures-label">ADVENTURES</h2> 
                        <p id="adventureMilestoneInfo">Complete 100 adventures for a bonus of 50 Gold and 1 Diamond!</p>
                        <div class="adventure-locations"> 
                            <div class="adventure" id="adventure-1-block"> 
                                <div class="adventure-lock-overlay hidden"></div>
                                <div class="adventure-icon tree"></div> 
                                <div class="adventure-main-info"> <div class="adventure-content"> <div class="adventure-details"> ADVENTURE 1, SPIRIT FOREST<br> ADVENTURE TIME = 4 HOURS<br> <span class="prize">PRIZE = 25 PV TOKENS</span> </div> <div class="adventure-controls"> <label for="num-adventurers-1">ADVENTURERS:</label> <select id="num-adventurers-1" class="adventure-num-select"> <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5" selected>5</option> </select> <button class="adventure-send-btn active-adv1" data-adventure-id="1" data-adventure-name="Spirit Forest" data-duration-hours="4" data-pv-reward="25" data-gold-chance="0">SEND</button> </div> </div> <div class="adventure-drops-area"> <button class="adventure-drops-button" data-adventure-id="1">DROPS</button> <div class="drops-popover" id="drops-popover-1"></div>  </div> </div> 
                            </div> 
                            <div class="adventure" id="adventure-2-block"> 
                                <div class="adventure-lock-overlay hidden"></div>
                                <div class="adventure-icon mountain"></div> <div class="adventure-main-info"> <div class="adventure-content"> <div class="adventure-details"> ADVENTURE 2, MOUNTAIN OF THE MAROWAN<br> ADVENTURE TIME = 8 HOURS<br> <span class="prize">PRIZE = 40 PV TOKENS</span> </div> <div class="adventure-controls"> <label for="num-adventurers-2">ADVENTURERS:</label> <select id="num-adventurers-2" class="adventure-num-select"> <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5" selected>5</option> </select> <button class="adventure-send-btn active-adv2" data-adventure-id="2" data-adventure-name="Mountain of the Marowan" data-duration-hours="8" data-pv-reward="40" data-gold-chance="0">SEND</button> </div> </div> <div class="adventure-drops-area"> <button class="adventure-drops-button" data-adventure-id="2">DROPS</button> <div class="drops-popover" id="drops-popover-2"></div>  </div> </div> 
                            </div> 
                            <div class="adventure" id="adventure-3-block"> 
                                <div class="adventure-lock-overlay hidden"></div>
                                <div class="adventure-icon fire-fields"></div> <div class="adventure-main-info"> <div class="adventure-content"> <div class="adventure-details"> ADVENTURE 3, FIRE FIELDS OF FLYINALS<br> ADVENTURE TIME = 24 HOURS<br> <span class="prize">PRIZE = 100 PV TOKENS</span><br> <span class="chance-gold">%1 CHANCE OF GOLD</span> <div class="adventure-requirement">Requires: 2 Adventurers</div> </div> <div class="adventure-controls"> <label for="num-adventurers-3">ADVENTURERS:</label> <select id="num-adventurers-3" class="adventure-num-select"> <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5" selected>5</option> </select> <button class="adventure-send-btn active-adv3" data-adventure-id="3" data-adventure-name="Fire Fields of Flyinals" data-duration-hours="24" data-pv-reward="100" data-gold-chance="0.01" data-adventurer-requirement="2">SEND</button> </div> </div> <div class="adventure-drops-area"> <button class="adventure-drops-button" data-adventure-id="3">DROPS</button> <div class="drops-popover" id="drops-popover-3"></div>  </div> </div> 
                            </div>
                            <div class="adventure" id="adventure-4-block"> 
                                <div class="adventure-lock-overlay hidden"></div>
                                <div class="adventure-icon tomb"></div> <div class="adventure-main-info"> <div class="adventure-content"> <div class="adventure-details"> ADVENTURE 4, TOMB OF THE DEATH RIDERS<br> ADVENTURE TIME = 168 HOURS (1 WEEK)<br> <span class="prize">PRIZE = 700 PV TOKENS</span><br> <span class="chance-gold">5% CHANCE OF GOLD</span><br> <span class="chance-diamond">1% CHANCE OF DIAMOND</span><div class="adventure-requirement">Requires: 5 Adventurers</div></div> <div class="adventure-controls"> <label for="num-adventurers-4">ADVENTURERS:</label> <select id="num-adventurers-4" class="adventure-num-select"> <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5" selected>5</option> </select> <button class="adventure-send-btn active-adv4" data-adventure-id="4" data-adventure-name="Tomb of the Death Riders" data-duration-hours="168" data-pv-reward="700" data-gold-chance="0.05" data-diamond-chance="0.01" data-adventurer-requirement="5">SEND</button> </div> </div> <div class="adventure-drops-area"> <button class="adventure-drops-button" data-adventure-id="4">DROPS</button> <div class="drops-popover" id="drops-popover-4"></div>  </div> </div> 
                            </div>
                        </div> 
                    </div> 
                </section>
                <section id="dungeons-page" class="page-content">
                    <h2 class="page-title">DUNGEONS</h2>
                    <div class="help-gif-container" style="margin-bottom: 30px;">
                        <img src="https://beige-managing-snail-510.mypinata.cloud/ipfs/bafybeia2l4itmrl2hynunpmp4h3k4anr2rgnxv7nb2wntxixihdxjkgwiy" alt="Dungeon Entrance Art">
                    </div>
                    <div id="dungeonListContainer" style="display: flex; flex-direction: column; align-items: center; gap: 20px; width:100%; max-width:700px; margin: 0 auto;">
                        <div class="dungeon-entry locked">
                            <div class="dungeon-icon-placeholder" style="background-color: #4A2A00;">D1</div>
                            <div class="dungeon-info">
                                <h3>Whispering Crypts (Locked)</h3>
                                <p>Ancient spirits guard untold riches, or perhaps just dust.</p>
                                <p class="dungeon-requirements">Requires: 10 Attack, 10 Defense</p>
                            </div>
                            <button class="action-button enter-dungeon-btn" disabled>Enter</button>
                        </div>
                        <div class="dungeon-entry locked">
                            <div class="dungeon-icon-placeholder" style="background-color: #33334C;">D2</div>
                            <div class="dungeon-info">
                                <h3>Dragon's Peak Ascent (Locked)</h3>
                                <p>Only the bravest (and strongest) dare to seek the wyrm's hoard.</p>
                                <p class="dungeon-requirements">Requires: 15 Attack, 15 Defense</p>
                            </div>
                            <button class="action-button enter-dungeon-btn" disabled>Enter</button>
                        </div>
                    </div>
                    <p style="text-align:center; margin-top: 20px;">More dungeons and challenges await those who prove their mettle...</p>
                </section>
                <section id="quests-page" class="page-content"> <h2 class="page-title">QUESTS</h2> <div class="quest-list" id="questList"> </div> </section>
                <section id="daily-rewards-page" class="page-content"> <h2 class="page-title">DAILY LOGIN REWARDS</h2> <div class="rewards-grid" id="dailyRewardsGrid"> </div> </section>
                
                <section id="shop-page" class="page-content"> 
                    <h2 class="page-title">SHOP</h2> 
                     <div class="shop-top-section">
                        <div class="shop-image-container">
                             <img src="https://beige-managing-snail-510.mypinata.cloud/ipfs/bafybeihnh2oz5tfkuscwq7k2llmjwp6d7nrk54b7yoc6727ppayissbg24" alt="Shop Decorative Image">
                        </div>
                        <div class="swap-section-container"> 
                            <div class="swap-section">
                                <h3>Currency Swap</h3> 
                                <div class="swap-info" id="swapInfoDisplay">100 <span class="gold">GOLD</span> = 1 <span class="diamond">DIAMOND</span></div> 
                                 <div style="display: flex; flex-direction: column; gap: 10px; align-items: center; margin-top: 10px; margin-bottom: 10px;">
                                    <button id="swapBtn" class="action-button swap-btn">Swap Gold for Diamond</button>
                                    <button id="reverseSwapDirectionBtn" class="action-button" title="Reverse Swap Direction">
                                        <img src="https://green-tough-gopher-310.mypinata.cloud/ipfs/bafkreigehaezkeralenqxjg5sk6q7s3flkxuz5iu7xlseztd5ptvxm2tnq" alt="Reverse Swap">
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="shop-section-wrapper"> <h3>Buy Items</h3> <div class="shop-items" id="shopItems"></div> </div> 
                </section>

                <section id="crafting-page" class="page-content">
                    <h2 class="page-title">CRAFTING</h2>
                    <div class="crafting-gif-container">
                        <img src="https://beige-managing-snail-510.mypinata.cloud/ipfs/bafybeibtfrmufw37ujdz77bua6d2lzfb5kmizo5q67rt4lunxmtdgzgfre" alt="Crafting Anvil GIF">
                    </div>
                    <div class="crafting-section-wrapper"> 
                        <h3 >Craft Items</h3> 
                        <div class="crafting-items-container" id="craftingItemsContainer"> </div> 
                    </div> 
                </section>

                <section id="inventory-page" class="page-content"> 
                    <h2 class="page-title">INVENTORY</h2> 
                    <div class="equipment-slots-container"> 
                        <h4 >EQUIPPED ITEMS</h4> 
                        <div class="equipment-slots" id="equipmentSlotsDisplay"> </div> 
                    </div> 
                    <h4 >My Items</h4> 
                    <div class="inventory-items-container" id="inventoryItemsContainer"> </div> 
                </section>
                <section id="upgrade-page" class="page-content">
                    <h2 class="page-title">UPGRADE STATION</h2>
                    <div class="upgrade-main-image-container">
                        <img src="https://beige-managing-snail-510.mypinata.cloud/ipfs/bafybeigp746l6dpyv2ciq7g42rhpfnfmbavrzh3dcwkqhjbrdsgciad64m" alt="Upgrade Anvil">
                    </div>
                     <p style="text-align:center; margin-top: 5px; margin-bottom:10px; font-size:0.9em;">Using a higher tier scroll than the item's base tier (for a compatible level upgrade) grants a +10% success chance bonus!</p>
                    <div class="upgrade-interface">
                        <div id="upgradeItemSlot" class="upgrade-slot">
                            <div id="selectedItemForUpgradeDisplay">Item: None</div>
                        </div>
                        <div id="upgradeScrollSlot" class="upgrade-slot">
                             <div id="selectedScrollForUpgradeDisplay">Scroll: None</div>
                        </div>
                        <button id="upgradeItemButton" class="action-button">Upgrade Item</button>
                        <div id="upgradeSuccessRateDisplay"></div>
                        <div id="upgradeResultDisplay"></div>
                    </div>
                    <p style="text-align:center; margin-top: 15px; font-size:0.95em;">
                        Item levels enhance their base effectiveness. Each level up to +5 provides a cumulative bonus: +5% for +1, +10% for +2, +15% for +3, +20% for +4, and a +25% increase to base stats/perks at +5.
                    </p>
                    <p style="text-align:center; margin-top: 10px;">Select an equippable item (level +0 to +4) and an appropriate Upgrade Scroll. High risk, high reward! Failed upgrades will destroy the item.</p>
                </section>
                <section id="leaderboard-page" class="page-content">
                    <h2 class="page-title">LEADERBOARDS</h2>
                    <div class="leaderboard-filters">
                        <button class="leaderboard-filter-btn active" data-resource="pvTokens">PV Tokens</button>
                        <button class="leaderboard-filter-btn" data-resource="gold">Gold</button>
                        <button class="leaderboard-filter-btn" data-resource="diamonds">Diamonds</button>
                    </div>
                    <div class="leaderboard-container">
                        <h4 id="leaderboardCurrentTypeTitle">PV Token Leaders</h4>
                        <ul id="leaderboardDisplayList" class="leaderboard-list">
                            <li>Click a filter above to load a leaderboard.</li>
                        </ul>
                    </div>
                     <p style="text-align:center; font-size:0.9em;">Note: If leaderboards show errors, your Firebase may be missing required indexes for 'pvTokens', 'gold', and 'diamonds' (descending) on the 'playerProgress' collection. Check Firebase console.</p>
                </section>
                <section id="whitelist-page" class="page-content">
                    <h2 class="page-title">WHITELIST RAFFLES</h2>
                    <div id="adminRafflePanel" class="hidden">
                        <h3>Create New Raffle</h3>
                        <form id="createRaffleForm">
                            <div class="admin-form-group">
                                <label for="raffleName">Raffle Name:</label>
                                <input type="text" id="raffleName" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="raffleDescription">Description:</label>
                                <textarea id="raffleDescription" required></textarea>
                            </div>
                            <div class="admin-form-group">
                                <label for="raffleImageUrl">Image URL:</label>
                                <input type="text" id="raffleImageUrl" placeholder="https://example.com/image.png">
                            </div>
                            <div class="admin-form-group">
                                <label for="raffleSocialX">Project X/Twitter URL:</label>
                                <input type="text" id="raffleSocialX" placeholder="https://x.com/project">
                            </div>
                            <div class="admin-form-group">
                                <label for="raffleSocialDiscord">Project Discord URL:</label>
                                <input type="text" id="raffleSocialDiscord" placeholder="https://discord.gg/project">
                            </div>
                            <div class="admin-form-group">
                                <label for="raffleCostPV">Cost (PV Tokens):</label>
                                <input type="number" id="raffleCostPV" value="0" min="0">
                            </div>
                            <div class="admin-form-group">
                                <label for="raffleCostGold">Cost (Gold):</label>
                                <input type="number" id="raffleCostGold" value="0" min="0">
                            </div>
                            <div class="admin-form-group">
                                <label for="raffleCostDiamonds">Cost (Diamonds):</label>
                                <input type="number" id="raffleCostDiamonds" value="0" min="0">
                            </div>
                             <div class="admin-form-group">
                                <label for="raffleDurationHours">Duration (Hours - game time):</label>
                                <input type="number" id="raffleDurationHours" value="24" min="1" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="raffleMaxWinners">Number of Winners:</label>
                                <input type="number" id="raffleMaxWinners" value="1" min="1" required>
                            </div>
                            <button type="submit" class="action-button">Create Raffle</button>
                        </form>
                    </div>
                    <div id="whitelistRafflesContainer">
                        <!-- Raffles will be dynamically inserted here -->
                    </div>
                </section>
                <section id="help-page" class="page-content"> 
                    <h2 class="page-title">PUNK VOYAGE HELP</h2> 
                    <div class="help-content"> 
                        <h3>Welcome, Voyager!</h3>
                        <p>Embark on an epic journey in Punk Voyage Adventures! This guide will help you navigate the cosmos of possibilities, from sending your brave adventurers on perilous quests to crafting legendary gear.</p>

                        <div class="help-gif-container">
                            <img src="https://beige-managing-snail-510.mypinata.cloud/ipfs/bafybeibyu3nj3yofxnngakyoyekde2vyffe73mnesrw3ogqmidrm3wgpli" alt="Helpful Guide GIF">
                        </div>

                        <h3>Getting Started</h3>
                        <ul>
                            <li><strong>Account:</strong> Create an account using Email/Password (don't forget to set a cool Nickname!) or sign in quickly with your Google account. Your game progress is saved automatically to the Firebase cloud, linked to your account.</li>
                            <li><strong>Nickname:</strong> Your chosen nickname will be your identity in the game world and for raffles.</li>
                            <li><strong>Interface:</strong> The game starts in Dark Mode. You can toggle to Light Mode using the switch in the top-right header. Use the main menu (usually on the right) to navigate between game sections.</li>
                        </ul>

                        <h3>The Core Voyage</h3>
                        <ul>
                            <li><strong>Adventurers:</strong> You have a set number of adventurers (initially 5). Below your adventurer count in the left sidebar, you'll see your current total Attack and Defense power derived from your equipped items.</li>
                            <li><strong>Adventures Page:</strong> This is where the action begins!
                                <ul>
                                    <li>Select an available adventure location.</li>
                                    <li>Choose how many of your available adventurers to send.</li>
                                    <li>Click "SEND". Some adventures have minimum adventurer requirements. If an adventure is already active, this button may change to "ADD MORE (+)" allowing you to send additional adventurers (this will reset the adventure timer).</li>
                                    <li><strong>Cancel Adventure:</strong> In the "ACTIVE ADVENTURES" list in the right sidebar, you can click the "✖" button next to an adventure to cancel it. Adventurers return immediately, but no rewards are given. A confirmation will be asked.</li>
                                    <li><strong>Progression:</strong> New, more challenging (and rewarding!) adventures unlock as you complete prerequisites, often by finishing earlier adventure series multiple times (e.g., "Complete Spirit Forest 5 times"). Locked adventures will show their unlock requirements.</li>
                                    <li><strong>Duration:</strong> Each adventure takes a set amount of time. Keep an eye on the "Active Adventures" list in the sidebar! (Remember: for testing, 1 game hour = 1 real second).</li>
                                    <li><strong>Rewards:</strong> Upon return, adventurers bring back <strong>PV Tokens</strong>, and have a chance to find <strong>Gold</strong>, rare <strong>Diamonds</strong>, and crafting <strong>Materials</strong>.</li>
                                    <li><strong>Milestone Reward:</strong> Every 100 adventures completed (any type, cumulative) will grant you a bonus of 50 Gold and 1 Diamond! This is noted on the Adventures page.</li>
                                    <li><strong>Drops:</strong> Hover over the "DROPS" button on an adventure card to see a list of potential material drops and their chances.</li>
                                </ul>
                            </li>
                            <li><strong>Materials:</strong> Gathered from adventures, these are essential for crafting items. View your current stash under "MY MATERIALS" in the left sidebar, now grouped by tier. You will also find your <strong>Upgrade Scroll</strong> counts here (Low, Middle, High), shown in green text.</li>
                        </ul>

                        <h3>Currencies & Economy</h3>
                        <ul>
                            <li><strong>PV Tokens:</strong> Earned primarily from adventures and quests. Used to buy items from the Shop.</li>
                            <li><strong>Gold:</strong> A rarer currency found on adventures, as special rewards, or from the 100-adventure milestone. Its main use currently is to swap for Diamonds.</li>
                            <li><strong>Diamonds:</strong> A premium currency. Obtainable by swapping Gold, as rare drops from high-level adventures, specific quest rewards, or from the 100-adventure milestone. Diamonds might be used for exclusive items or features in the future.</li>
                            <li><strong>Currency Swap:</strong> In the "Shop" page, you can swap 100 Gold for 1 Diamond, or 1 Diamond for 100 Gold.</li>
                        </ul>

                        <h3>Shop</h3>
                        <ul>
                             <li>Purchase consumable items like Potions and Upgrade Scrolls using PV Tokens.</li>
                             <li><strong>Potions:</strong> Provide temporary buffs. You cannot have multiple identical potions active simultaneously.</li>
                             <li><strong>Rider Scroll (Unlock):</strong> A one-time purchase from the shop for <strong>50,000 PV</strong>. This item goes to your inventory. You then "Use" it from the locked Ring 2 slot in your Equipment (Inventory page) to permanently unlock it.</li>
                             <li><strong>Upgrade Scrolls:</strong> Low, Middle, and High Class scrolls are available for item upgrades. You can buy these in quantities of 1 to 10. Purchasing these adds to your scroll count (visible in "MY MATERIALS"). Scroll prices are 125 PV (Low), 250 PV (Middle), and 500 PV (High).
                                <ul>
                                    <li><strong>Low Class Scroll:</strong> Used for upgrading items from level +0 to +1. Cannot be used on items that are already +1 or higher.</li>
                                    <li><strong>Middle Class Scroll:</strong> Used for upgrading items that are currently level +0, +1, or +2 (to become +1, +2, or +3 respectively).</li>
                                    <li><strong>High Class Scroll:</strong> Used for upgrading items that are currently level +0, +1, +2, +3, or +4 (to become +1 up to +5 respectively).</li>
                                    <li>A +10% success chance bonus is applied if you use a scroll of a higher tier (Middle or High) on an item whose base tier is lower than the scroll's effective tier, provided the scroll is compatible with the item's current level. (e.g., Middle Scroll on a Tier 0/1 item, or High Scroll on a Tier 0/1/2 item).</li>
                                </ul>
                             </li>
                        </ul>
                        <h3>Crafting</h3>
                        <ul>
                            <li>Visit the "Crafting" page. The crafting GIF is now located here.</li>
                            <li>Use materials collected from adventures to craft powerful equipment.</li>
                            <li>You'll see a list of craftable items and their required materials. Hover over an item to see its full stats and recipe.</li>
                            <li>You cannot craft an item if you already own an instance of that base item ID. If an item is destroyed during a failed upgrade, you can then craft a new +0 version. You will be prompted to craft the item again if an upgrade fails.</li>
                        </ul>
                        
                        <h3>Inventory & Equipment</h3>
                        <ul>
                            <li><strong>View Items:</strong> The Inventory page shows all items you've crafted or bought (excluding Upgrade Scrolls). Hover over items to see their details. Upgraded items will show their level (e.g., +1, +2).</li>
                            <li><strong>Equip Items:</strong> Equip your crafted gear to gain passive bonuses, which contribute to your Attack and Defense stats shown in the left sidebar.
                                <ul>
                                    <li><strong>Slots:</strong> Armour, Helmet, Boots, Amulet, Ring 1, Ring 2, Weapon, Misc 1, Misc 2.</li>
                                    <li><strong>Unlocking Ring 2:</strong> Purchase the "Rider Scroll (Unlock)" from the Shop. It appears in "My Items". Go to "Inventory", and in "EQUIPPED ITEMS", click "Use Rider Scroll" on the locked Ring 2 slot. This consumes the scroll and unlocks the slot.</li>
                                </ul>
                            </li>
                            <li><strong>Unequip:</strong> You can unequip items. They return to "My Items".</li>
                            <li><strong>Item Levels:</strong> Items start at +0. They can be upgraded up to +5. +4 items have an orange highlight, +5 items have a dark red highlight. Item levels enhance their base effectiveness (+0% at +0, +5% at +1, +10% at +2, +15% at +3, +20% at +4, +25% at +5).</li>
                        </ul>

                        <h3>Item Upgrading (Upgrade Station)</h3>
                        <ul>
                            <li>Visit the "Upgrade" page.</li>
                            <li>Select an equippable item (from +0 to +4) and an Upgrade Scroll type. The pop-up shows your scroll counts.</li>
                            <li><strong>Scroll Compatibility & Bonus:</strong>
                                <ul>
                                    <li><strong>Low Class Scrolls (Tier 1 Scroll):</strong> Can *only* be used to upgrade an item from +0 to +1. The item's base tier (0-4) does not prevent its use for this specific +0 to +1 upgrade.</li>
                                    <li><strong>Middle Class Scrolls (Tier 2 Scroll):</strong> Can be used if the item's current level is +0, +1, or +2. The item's base tier (0-4) does not prevent its use. A +10% success chance bonus is granted if the item's base tier is 0 or 1 (lower than the scroll's tier).</li>
                                    <li><strong>High Class Scrolls (Tier 3 Scroll):</strong> Can be used if the item's current level is +0, +1, +2, +3, or +4. The item's base tier (0-4) does not prevent its use. A +10% success chance bonus is granted if the item's base tier is 0, 1, or 2 (lower than the scroll's tier).</li>
                                </ul>
                            </li>
                            <li>The success chance for the upgrade will be displayed.</li>
                            <li>Attempting an upgrade:
                                <ul>
                                    <li><strong>Success:</strong> Item level increases (e.g., +0 becomes +1). The item remains in the upgrade slot.</li>
                                    <li><strong>Failure:</strong> Item is **DESTROYED**! You'll be asked if you want to craft a new +0 version (if you have materials). If the destroyed item was equipped, and you re-craft it, it will be automatically re-equipped to its previous slot.</li>
                                </ul>
                            </li>
                            <li>Base Upgrade Chances (before any +10% bonus from higher-tier scrolls): +0 to +1 (100%), +1 to +2 (85%), +2 to +3 (50%), +3 to +4 (35%), +4 to +5 (13%). Max level is +5.</li>
                        </ul>

                        <h3>Other Features</h3>
                        <ul>
                            <li><strong>Dungeons:</strong> (Coming Soon!) Placeholder dungeons are now visible.</li>
                            <li><strong>Quests:</strong> Complete objectives for rewards. Claim from the Quests page.</li>
                            <li><strong>Daily Login Rewards:</strong> Claim a reward every 24 hours.</li>
                            <li><strong>Whitelist Raffles:</strong> Participate in raffles.</li>
                            <li><strong>Leaderboards:</strong> See top players. (Index errors require Firebase console setup).</li>
                        </ul>

                        <h3>Community & Support</h3>
                        <ul>
                            <li><strong>Socials:</strong> Join our community! Links in header.</li>
                            <li><strong>Game Status:</strong> Punk Voyage Adventures is evolving. Feedback is valued!</li>
                        </ul>
                        <p>Good luck on your voyages, Voyager! May your hauls be plentiful and your Punks legendary!</p>
                    </div> 
                </section>
            </div>
            <aside class="right-sidebar-menu"> <nav class="main-menu-nav"> <div class="menu-button-container-fixed"><button class="menu-button" id="mainMenuToggleBtn">MENU</button></div> <div class="sidebar-content-area" id="sidebarContentArea"> <ul class="main-menu-nav-list" id="mainMenuList"> 
                <li data-page="adventures-page" class="menu-list-item"><img src="https://green-tough-gopher-310.mypinata.cloud/ipfs/bafybeidvav6u7a4naahsxhqalytbmnr7mhmonhanqhcuerchy7fkldjiua/adventures.jpg" alt="" class="menu-item-icon">ADVENTURES</li>  
                <li data-page="dungeons-page" class="menu-list-item"><img src="https://green-tough-gopher-310.mypinata.cloud/ipfs/bafybeidvav6u7a4naahsxhqalytbmnr7mhmonhanqhcuerchy7fkldjiua/dungeons.jpg" alt="" class="menu-item-icon">DUNGEONS</li> 
                <li data-page="quests-page" class="menu-list-item"><img src="https://green-tough-gopher-310.mypinata.cloud/ipfs/bafybeihk33icq4ytbr5m54tor4qkibqwphgu72l3si5ydcmvkj2oav42i4/quest.jpg" alt="" class="menu-item-icon">QUESTS</li> 
                <li data-page="daily-rewards-page" class="menu-list-item"><img src="https://green-tough-gopher-310.mypinata.cloud/ipfs/bafybeidvav6u7a4naahsxhqalytbmnr7mhmonhanqhcuerchy7fkldjiua/reward.jpg" alt="" class="menu-item-icon">DAILY LOGIN REWARDS</li> 
                <li data-page="shop-page" class="menu-list-item"><img src="https://green-tough-gopher-310.mypinata.cloud/ipfs/bafybeidvav6u7a4naahsxhqalytbmnr7mhmonhanqhcuerchy7fkldjiua/shop.jpg" alt="" class="menu-item-icon">SHOP</li> 
                <li data-page="crafting-page" class="menu-list-item"><img src="https://green-tough-gopher-310.mypinata.cloud/ipfs/bafybeidvav6u7a4naahsxhqalytbmnr7mhmonhanqhcuerchy7fkldjiua/crafting.jpg" alt="" class="menu-item-icon">CRAFTING</li> 
                <li data-page="inventory-page" class="menu-list-item"><img src="https://green-tough-gopher-310.mypinata.cloud/ipfs/bafybeihk33icq4ytbr5m54tor4qkibqwphgu72l3si5ydcmvkj2oav42i4/stash.jpg" alt="" class="menu-item-icon">INVENTORY</li>  
                <li data-page="upgrade-page" class="menu-list-item"><img src="https://green-tough-gopher-310.mypinata.cloud/ipfs/bafybeihk33icq4ytbr5m54tor4qkibqwphgu72l3si5ydcmvkj2oav42i4/anvil.jpg" alt="" class="menu-item-icon">UPGRADE</li> 
                <li data-page="leaderboard-page" class="menu-list-item"><img src="https://green-tough-gopher-310.mypinata.cloud/ipfs/bafybeidvav6u7a4naahsxhqalytbmnr7mhmonhanqhcuerchy7fkldjiua/leaderboard.jpg" alt="" class="menu-item-icon">LEADERBOARD</li> 
                <li data-page="whitelist-page" class="menu-list-item">WHITELIST</li> 
                <li data-page="help-page" class="menu-list-item"><img src="https://green-tough-gopher-310.mypinata.cloud/ipfs/bafybeidvav6u7a4naahsxhqalytbmnr7mhmonhanqhcuerchy7fkldjiua/help.jpg" alt="" class="menu-item-icon">HELP</li> </ul> <div class="sidebar-active-adventures-container" id="sidebarActiveAdventuresDisplay"> <h3>ACTIVE ADVENTURES</h3> <div id="sidebarActiveAdventuresList"></div> </div> <div class="active-potions-display hidden" id="activePotionsDisplay"> <h4>ACTIVE POTIONS</h4> <div id="activePotionsList"></div> </div> </div> </nav> </aside>
        </main>
    </div>

    <div id="customPopupOverlay" class="hidden"></div>
    <div id="customPopup" class="hidden">
        <h3 id="customPopupTitle">Notification</h3>
        <div id="customPopupMessage"></div> 
        <div id="customPopupButtons">
            <button id="customPopupConfirmBtn" class="action-button hidden">Confirm</button>
            <button id="customPopupCancelBtn" class="action-button hidden">Cancel</button>
            <button id="customPopupCloseBtn" class="action-button">OK</button>
        </div>
    </div>

    <!-- Item Selection Modal for Upgrading -->
    <div id="itemSelectionModalOverlay" class="hidden"></div>
    <div id="itemSelectionModal" class="hidden">
        <h3 id="itemSelectionModalTitle">Select Item</h3>
        <div id="itemSelectionModalList"></div>
        <button id="itemSelectionModalCloseBtn" class="action-button">Cancel</button>
    </div>


    <script type="module" id="firebaseModule">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, Timestamp, query, where, orderBy, getDocs, addDoc, runTransaction, updateDoc, deleteDoc, limit } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"; 
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";


        const firebaseConfig = {
            apiKey: "AIzaSyASoKVnbNVJBASSPEnWOvkocTwM16ijNxM", 
            authDomain: "punkvoyage.firebaseapp.com",
            projectId: "punkvoyage",
            storageBucket: "punkvoyage.appspot.com", 
            messagingSenderId: "929081617432",
            appId: "1:929081617432:web:1603e242f9cceb79ee676d",
            measurementId: "G-R5ESCD03L9"
        };
        

        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const analytics = getAnalytics(app); 
            const auth = getAuth(app); 

            window.firebaseApp = app;
            window.firebaseDb = db;
            window.fbAuth = auth; 
            window.firebaseFirestore = { doc, getDoc, setDoc, collection, Timestamp, query, where, orderBy, getDocs, addDoc, runTransaction, updateDoc, deleteDoc, limit }; 
            window.firebaseAuthFunctions = { createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup }; 
            
            document.dispatchEvent(new CustomEvent('firebaseReady'));
            console.log("Firebase Initialized Successfully (including Auth with Google) and 'firebaseReady' event dispatched.");

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            setTimeout(() => { 
                const popupTitle = document.getElementById('customPopupTitle');
                const popupMessage = document.getElementById('customPopupMessage');
                const popupOverlay = document.getElementById('customPopupOverlay');
                const popupItself = document.getElementById('customPopup');
                if (popupTitle && popupMessage && popupOverlay && popupItself) {
                     popupTitle.textContent = "Critical Error";
                     popupMessage.innerHTML = "Failed to connect to game services. Please ensure your Firebase configuration is correct and you are online. Error: " + error.message;
                     popupOverlay.classList.remove('hidden');
                     popupItself.classList.remove('hidden');
                } else {
                    alert("CRITICAL FIREBASE ERROR: " + error.message + "\nCheck Firebase config and internet connection."); 
                }
            }, 100);
        }
    </script>

    <script>
        document.addEventListener('firebaseReady', () => {
            console.log("'firebaseReady' event received by main script. Initializing game logic.");
            
            const db = window.firebaseDb;
            const auth = window.fbAuth; 
            const { doc, getDoc, setDoc, collection, Timestamp, query, where, orderBy, getDocs, addDoc, runTransaction, updateDoc, deleteDoc, limit } = window.firebaseFirestore;
            const { createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut: fbSignOut, onAuthStateChanged, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup } = window.firebaseAuthFunctions; 

            const GAME_HOUR_IN_REAL_SECONDS = 1; 
            const TWENTY_FOUR_HOURS_MS = 24 * 60 * 60 * 1000;


            // --- HTML Element Constants ---
            const welcomeScreen = document.getElementById('welcomeScreen');
            const authFormContainer = document.getElementById('authFormContainer');
            const authFormTitle = document.getElementById('authFormTitle');
            const loginRegisterForm = document.getElementById('loginRegisterForm');
            const authEmailInput = document.getElementById('authEmail');
            const authPasswordInput = document.getElementById('authPassword');
            const authNicknameField = document.getElementById('authNicknameField');
            const authNicknameInput = document.getElementById('authNickname');
            const loginButton = document.getElementById('loginButton');
            const registerButton = document.getElementById('registerButton');
            const googleSignInButton = document.getElementById('googleSignInButton'); 
            const authToggleLink = document.getElementById('authToggleLink');
            const forgotPasswordLink = document.getElementById('forgotPasswordLink');
            const signOutButton = document.getElementById('signOutButton');

            const gameContainer = document.getElementById('gameContainer');
            const playerNicknameDisplay = document.getElementById('playerNicknameDisplay');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const body = document.body;
            const twitterWidgetContainer = document.getElementById('twitter-widget-container');
            const pvCountElement = document.getElementById('pvCount');
            const goldCountElement = document.getElementById('goldCount');
            const diamondCountElement = document.getElementById('diamondCount');
            const adventureSendButtons = document.querySelectorAll('.adventure-send-btn');
            const adventureDropButtons = document.querySelectorAll('.adventure-drops-button');
            
            const swapInfoDisplay = document.getElementById('swapInfoDisplay');
            const swapBtn = document.getElementById('swapBtn');
            const reverseSwapDirectionBtn = document.getElementById('reverseSwapDirectionBtn');

            const sidebarActiveAdventuresContainer = document.getElementById('sidebarActiveAdventuresDisplay'); 
            const sidebarActiveAdventuresList = document.getElementById('sidebarActiveAdventuresList');
            const activePotionsDisplay = document.getElementById('activePotionsDisplay');
            const activePotionsList = document.getElementById('activePotionsList');
            const availableAdventurersCountElement = document.getElementById('availableAdventurersCount');
            const playerAttackStatElement = document.getElementById('playerAttackStat');
            const playerDefenseStatElement = document.getElementById('playerDefenseStat');

            const menuItems = document.querySelectorAll('.right-sidebar-menu .main-menu-nav-list li');
            const pageContents = document.querySelectorAll('.main-content-area .page-content'); 
            const questListDiv = document.getElementById('questList');
            const shopItemsDiv = document.getElementById('shopItems');
            const materialsListContainer = document.getElementById('materialsListContainer'); 
            const craftingItemsContainer = document.getElementById('craftingItemsContainer');
            const inventoryItemsContainer = document.getElementById('inventoryItemsContainer');
            const equipmentSlotsDisplay = document.getElementById('equipmentSlotsDisplay');
            const dailyRewardsGrid = document.getElementById('dailyRewardsGrid');
            const customPopupOverlay = document.getElementById('customPopupOverlay');
            const customPopup = document.getElementById('customPopup');
            const customPopupTitleEl = document.getElementById('customPopupTitle');
            const customPopupMessageEl = document.getElementById('customPopupMessage');
            const customPopupButtonsEl = document.getElementById('customPopupButtons');
            const customPopupCloseBtn = document.getElementById('customPopupCloseBtn');
            const customPopupConfirmBtn = document.getElementById('customPopupConfirmBtn');
            const customPopupCancelBtn = document.getElementById('customPopupCancelBtn');
            const adminRafflePanel = document.getElementById('adminRafflePanel');
            const createRaffleForm = document.getElementById('createRaffleForm');
            const whitelistRafflesContainer = document.getElementById('whitelistRafflesContainer');
            const itemTooltipElement = document.getElementById('itemTooltip');


            // Leaderboard elements
            const leaderboardFilterButtons = document.querySelectorAll('.leaderboard-filter-btn');
            const leaderboardDisplayList = document.getElementById('leaderboardDisplayList');
            const leaderboardCurrentTypeTitle = document.getElementById('leaderboardCurrentTypeTitle');
            
            // Upgrade Page Elements
            const upgradeItemSlot = document.getElementById('upgradeItemSlot');
            const upgradeScrollSlot = document.getElementById('upgradeScrollSlot');
            const selectedItemForUpgradeDisplay = document.getElementById('selectedItemForUpgradeDisplay');
            const selectedScrollForUpgradeDisplay = document.getElementById('selectedScrollForUpgradeDisplay');
            const upgradeItemButton = document.getElementById('upgradeItemButton');
            const upgradeSuccessRateDisplay = document.getElementById('upgradeSuccessRateDisplay');
            const upgradeResultDisplay = document.getElementById('upgradeResultDisplay');
            const itemSelectionModalOverlay = document.getElementById('itemSelectionModalOverlay');
            const itemSelectionModal = document.getElementById('itemSelectionModal');
            const itemSelectionModalTitle = document.getElementById('itemSelectionModalTitle');
            const itemSelectionModalList = document.getElementById('itemSelectionModalList');
            const itemSelectionModalCloseBtn = document.getElementById('itemSelectionModalCloseBtn');

            // --- Game State Variables ---
            let currentUser = null; 
            let userNickname = ''; 
            const MAX_PLAYER_ADVENTURERS = 5;
            let currentPvTokens = 0; let currentGold = 0; let currentDiamonds = 0;
            let activeAdventures = []; let nextActiveAdventureId = 0;
            let totalAvailableAdventurers = MAX_PLAYER_ADVENTURERS;
            let playerInventory = []; 
            let nextUniqueInstanceId = 0; 
            let playerScrolls = { low: 0, middle: 0, high: 0 };
            let playerHasPurchasedRiderScroll = false; 
            let totalAdventuresCompleted = 0;


            const initialPlayerMaterials = { 
                "Leather": 0, "Wood": 0, "Clover": 0, "Fabric": 0, "Iron": 0, "Gizmo Tail": 0, 
                "Stone": 0, "Obsidian": 0, "Bitcoin": 0, "Bone": 0, "Flame Essence": 0, 
                "Essence of Death": 0, "Rider's Sigil": 0, "Ancient Tablet Fragment": 0, "Shadowgem": 0 
            };
            let playerMaterials = { ...initialPlayerMaterials };

            let equippedItems = { 
                Armour: null, Helmet: null, Boots: null, Amulet: null, 
                Ring1: null, Ring2: null, Weapon: null, 
                Misc1: null, Misc2: null 
            }; 
            let playerAdventurerLevel = 1; 
            let secondRingSlotUnlocked = false;
            let activePotions = [];
            let allRaffles = []; 
            let playerRaffleEntries = {}; 
            
            let lastDailyRewardDayClaimed = 0;
            let lastDailyRewardClaimTimestamp = 0;

            let popupMessageQueue = [];
            let isPopupCurrentlyVisible = false;
            let currentPopupCraftCallback = null; 
            let currentPopupConfirmCallback = null;


            let selectedItemForUpgrade = null; 
            let selectedScrollForUpgrade = null; 
            let isGoldToDiamondSwap = true;
            
            // --- Game Data ---
             const adventuresData = { 
                "1": { name: "Spirit Forest", drops: [ { name: "Leather", chance: 0.05, qty: 1}, { name: "Wood", chance: 0.10, qty: 1}, { name: "Clover", chance: 0.01, qty: 1}, { name: "Fabric", chance: 0.03, qty: 1} ] }, 
                "2": { name: "Mountain of the Marowan", drops: [ { name: "Iron", chance: 0.05, qty: 1}, { name: "Gizmo Tail", chance: 0.01, qty: 1}, { name: "Stone", chance: 0.10, qty: 1} ] }, 
                "3": { name: "Fire Fields of Flyinals", adventurerRequirement: 2, drops: [ { name: "Obsidian", chance: 0.01, qty: 1}, { name: "Bitcoin", chance: 0.00001, qty: 1}, { name: "Flame Essence", chance: 0.05, qty: 1} ] }, 
                "4": { name: "Tomb of the Death Riders", adventurerRequirement: 5, drops: [ { name: "Bone", chance: 0.15, qty: 1}, { name: "Essence of Death", chance: 0.10, qty: 1}, { name: "Bitcoin", chance: 0.0001, qty: 1},  { name: "Rider's Sigil", chance: 0.05, qty: 1}, { name: "Ancient Tablet Fragment", chance: 0.02, qty: 1}, { name: "Shadowgem", chance: 0.008, qty: 1}, { name: "ring_cursedpower", chance: 0.002, qty: 1} ] } 
            };
            const materialTiers = {
                1: ["Leather", "Wood", "Clover", "Fabric"],
                2: ["Iron", "Gizmo Tail", "Stone"],
                3: ["Obsidian", "Bitcoin", "Flame Essence"], 
                4: ["Bone", "Essence of Death", "Rider's Sigil", "Ancient Tablet Fragment", "Shadowgem"]
            };
             const scrollData = { // scrollTier: 1=Low, 2=Mid, 3=High
                low: { name: "Low Class Scroll", icon: "https://green-tough-gopher-310.mypinata.cloud/ipfs/bafybeihk33icq4ytbr5m54tor4qkibqwphgu72l3si5ydcmvkj2oav42i4/low%20upgrade%20scroll.jpg", tier: 1, shopId: "scroll_low" },
                middle: { name: "Middle Class Scroll", icon: "https://green-tough-gopher-310.mypinata.cloud/ipfs/bafybeihk33icq4ytbr5m54tor4qkibqwphgu72l3si5ydcmvkj2oav42i4/middle%20upgrade%20scroll.jpg", tier: 2, shopId: "scroll_mid" },
                high: { name: "High Class Scroll", icon: "https://green-tough-gopher-310.mypinata.cloud/ipfs/bafkreicbt5kelkj3ph32jykjslocal24sn3srfjttq7pfg75bqjagrzlyi", tier: 3, shopId: "scroll_high"}
            };

            const craftableItemsData = [ // item tier: 0-4
                { id: "boots1", name: "Warped Boots", type: "Boots", description: "Reduces adventure time by 15 minutes.", perk: { type: "timeReduction", value: 900 }, recipe: { "Leather": 5, "Fabric": 3 }, iconUrlOrColor: "https://green-tough-gopher-310.mypinata.cloud/ipfs/bafybeidvav6u7a4naahsxhqalytbmnr7mhmonhanqhcuerchy7fkldjiua/boots.jpg", tier: 1 }, 
                { id: "amulet1", name: "Amulet of Greed", type: "Amulet", description: "Increases Gold find chance by +50% of current chance.", perk: { type: "goldChanceIncrease", value: 0.5 }, recipe: { "Iron": 3, "Gizmo Tail": 1 }, iconUrlOrColor: "https://green-tough-gopher-310.mypinata.cloud/ipfs/bafkreih7mmirdvzhdw3duyd67y6taqklq5qpcns6vw765msuafd74i44by", tier: 2 }, 
                { id: "rucksack1", name: "Efficient Rucksack", type: "Rucksack", description: "+10% PV tokens from adventures.", perk: { type: "pvBonus", value: 0.10 }, recipe: { "Fabric": 5, "Leather": 2 }, iconUrlOrColor: "https://green-tough-gopher-310.mypinata.cloud/ipfs/bafybeihk33icq4ytbr5m54tor4qkibqwphgu72l3si5ydcmvkj2oav42i4/pouch.jpg", tier: 1 }, 
                { id: "trinket1", name: "Lucky Rabbit's Foot", type: "Trinket", description: "Increases material find chance by x1.3 (multiplicative).", perk: { type: "materialChanceMultiplier", value: 1.3 }, recipe: { "Clover": 3, "Bone": 2 }, iconUrlOrColor: "https://green-tough-gopher-310.mypinata.cloud/ipfs/bafybeihk33icq4ytbr5m54tor4qkibqwphgu72l3si5ydcmvkj2oav42i4/rabbit%20foot.jpg", tier: 4 }, 
                { id: "weapon1", name: "Rider's Blade", type: "Weapon", description: "A blade echoing with the cries of the fallen. (+5 Attack)", perk: {type: "attackBoost", value: 5}, recipe: { "Rider's Sigil": 2, "Essence of Death": 3, "Iron": 5}, iconUrlOrColor: "https://green-tough-gopher-310.mypinata.cloud/ipfs/bafybeidvav6u7a4naahsxhqalytbmnr7mhmonhanqhcuerchy7fkldjiua/sword.jpg", tier: 4}, 
                { id: "armour1", name: "Shadow-Woven Armour", type: "Armour", description: "Provides moderate protection. (+10 Defense)", perk: {type: "defenseBoost", value: 10}, recipe: {"Obsidian": 5, "Essence of Death": 2, "Shadowgem": 1}, iconUrlOrColor: "https://green-tough-gopher-310.mypinata.cloud/ipfs/bafybeidvav6u7a4naahsxhqalytbmnr7mhmonhanqhcuerchy7fkldjiua/armour.jpg", tier: 4}, 
                { id: "helmet1", name: "Helm of the Silent Watcher", type: "Helmet", description: "Offers a gaze that pierces the veil. (+3 Defense)", perk: {type: "defenseBoost", value: 3}, recipe: {"Iron": 4, "Rider's Sigil": 1, "Shadowgem": 1}, iconUrlOrColor: "https://green-tough-gopher-310.mypinata.cloud/ipfs/bafybeidvav6u7a4naahsxhqalytbmnr7mhmonhanqhcuerchy7fkldjiua/helmet.jpg", tier: 4}, 
                { id: "ring_warding", name: "Ring of Minor Warding", type: "Ring", description: "Offers slight protection. (+1% Gold/Diamond find).", perk: {type: "flatCurrencyChanceBoost", goldBonus: 0.01, diamondBonus: 0.01}, recipe: {"Stone": 10, "Clover": 5}, iconUrlOrColor: "https://green-tough-gopher-310.mypinata.cloud/ipfs/bafybeidvav6u7a4naahsxhqalytbmnr7mhmonhanqhcuerchy7fkldjiua/ring1.jpeg", tier: 2}, 
                { id: "ring_swiftness", name: "Band of Swiftness", type: "Ring", description: "Slightly reduces adventure times. (-5 min)", perk: {type: "timeReduction", value: 300}, recipe: {"Leather": 8, "Gizmo Tail": 3}, iconUrlOrColor: "https://green-tough-gopher-310.mypinata.cloud/ipfs/bafybeidvav6u7a4naahsxhqalytbmnr7mhmonhanqhcuerchy7fkldjiua/ring2.jpeg", tier: 2}, 
                { id: "ring_cursedpower", name: "Cursed Ring of Power", type: "Ring", description: "Grants power, but at a cost. (+5 Attack, -2 Defense)", perk: {type: "statBoost", attack: 5, defense: -2}, recipe: {"Rider's Sigil": 3, "Shadowgem": 2, "Essence of Death": 1}, iconUrlOrColor: "https://green-tough-gopher-310.mypinata.cloud/ipfs/bafybeidvav6u7a4naahsxhqalytbmnr7mhmonhanqhcuerchy7fkldjiua/ring3.jpg", tier: 4}
            ];

            const shopItemsData = [ 
                { id: "potion2", name: "PV Doubler (1 Use)", description: "Doubles PV rewards from NEXT adventure.", price: 200, iconUrlOrColor: "https://green-tough-gopher-310.mypinata.cloud/ipfs/bafybeihk33icq4ytbr5m54tor4qkibqwphgu72l3si5ydcmvkj2oav42i4/pv%20doubler.jpg", type: "buff", durationAdventures: 1, effect: { type: "pvMultiplier", value: 2 } }, 
                { id: "potion3", name: "Gold Magnet (3 Adventures)", description: "Adds +1% FLAT chance of finding gold on next 3 adventures.", price: 400, iconUrlOrColor: "https://green-tough-gopher-310.mypinata.cloud/ipfs/bafybeihk33icq4ytbr5m54tor4qkibqwphgu72l3si5ydcmvkj2oav42i4/gold%20magnet.jpg", type: "buff", durationAdventures: 3, effect: { type: "goldChanceBonus", flatValue: 0.01 } }, 
                { id: "scroll_low", name: "Low Class Scroll", description: "For upgrading items from +0 to +1.", price: 125, iconUrlOrColor: scrollData.low.icon, type: "upgrade_scroll_purchase", scrollTypeKey: "low"},
                { id: "scroll_mid", name: "Middle Class Scroll", description: "For +0 to +2 items (to +1/+2/+3). Bonus on low-tier items.", price: 250, iconUrlOrColor: scrollData.middle.icon, type: "upgrade_scroll_purchase", scrollTypeKey: "middle"},
                { id: "scroll_high", name: "High Class Scroll", description: "For +0 to +4 items (to +1 thru +5). Bonus on low/mid-tier items.", price: 500, iconUrlOrColor: scrollData.high.icon, type: "upgrade_scroll_purchase", scrollTypeKey: "high"},
                { id: "rider_scroll_unlock", name: "Rider Scroll (Unlock)", description: "Permanently unlocks your second Ring Slot. One-time purchase, consumed on use from Equipment Slot.", price: 50000, iconUrlOrColor: "var(--item-placeholder-misc)", type: "unlockable_consumable" }
            ];


            const quests = [ 
                { id: 1, text: "Complete Spirit Forest 5 times", reward: "50 PV", completed: false, progress: 0, target: 5, adventureName: "Spirit Forest" }, 
                { id: 2, text: "Complete Mountain of the Marowan 5 times", reward: "75 PV", completed: false, progress: 0, target: 5, adventureName: "Mountain of the Marowan"}, 
                { id: 3, text: "Complete Fire Fields of Flyinals 5 times", reward: "150 PV", completed: false, progress: 0, target: 5, adventureName: "Fire Fields of Flyinals"}, 
                { id: 4, text: "Venture into the Tomb of the Death Riders", reward: "250 PV, 1 Diamond", completed: false, progress: 0, target: 1, adventureName: "Tomb of the Death Riders"},
                { id: 5, text: "Craft any 3 items", reward: "100 PV", completed: false, progress: 0, target: 3, metric: "itemsCrafted" },
                { id: 6, text: "Accumulate 1000 PV Tokens", reward: "1 Gold", completed: false, progress: 0, target: 1000, metric: "pvBalance" }, 
                { id: 7, text: "Upgrade any item to +2", reward: "200 PV", completed: false, progress: 0, target: 1, metric: "itemUpgradedToPlus2" }, 
                { id: 8, text: "Collect 10 Iron materials", reward: "50 PV", completed: false, progress: 0, target: 10, metric: "materialCollected_Iron" },
                { id: 9, text: "Complete 25 total adventures (any type)", reward: "1 Diamond, 100 PV", completed: false, progress: 0, target: 25, metric: "totalAdventuresCompletedOverall" },
                { id: 10, text: "Equip a full set of Tier 1 gear (Boots, Rucksack)", reward: "150 PV", completed: false, progress: 0, target: 2, metric: "equippedTier1Set" },
                { id: 11, text: "Reach 10 Attack Power", reward: "1 Gold, 50 PV", completed: false, progress: 0, target: 10, metric: "attackPower" },
                { id: 12, text: "Successfully upgrade an item to +3", reward: "1 Diamond, 100 PV", completed: false, progress: 0, target: 1, metric: "itemUpgradedToPlus3" },
                { id: 13, text: "Use a PV Doubler Potion", reward: "25 PV", completed: false, progress: 0, target: 1, metric: "potionUsed_potion2" },
                { id: 14, text: "Find 5 Gold from adventures", reward: "100 PV, 1 Diamond", completed: false, progress: 0, target: 5, metric: "goldFoundAdventures" }
            ];
            const dailyRewardsData = []; for (let i = 1; i <= 30; i++) { let reward = `${50 + (i * 5)} PV`; if (i % 7 === 0 && Object.keys(playerMaterials).length > 0) reward += `, 1 ${Object.keys(playerMaterials)[i % Object.keys(playerMaterials).length]}`; if (i === 30) reward = "1 Gold, 300 PV, 1 Diamond"; dailyRewardsData.push({ day: i, reward: reward });}
            const adventureProgressionConfig = [ { id: "1", blockId: "adventure-1-block", unlockQuestId: null, unlockMessage: "" }, { id: "2", blockId: "adventure-2-block", unlockQuestId: 1, unlockMessage: "Complete 'Spirit Forest' 5 times to unlock." }, { id: "3", blockId: "adventure-3-block", unlockQuestId: 2, unlockMessage: "Complete 'Mountain of the Marowan' 5 times to unlock." }, { id: "4", blockId: "adventure-4-block", unlockQuestId: 3, unlockMessage: "Complete 'Fire Fields of Flyinals' 5 times to unlock." } ];
            const upgradeChances = [1, 0.85, 0.50, 0.35, 0.13]; // For +0->+1, +1->+2, ..., +4->+5


            // --- Perk Scaling Function ---
            function getScaledItemPerk(itemMaster, itemLevel) {
                if (!itemMaster || !itemMaster.perk || itemLevel === undefined) {
                    return itemMaster ? itemMaster.perk : null;
                }
                if (itemLevel === 0) { return itemMaster.perk; }

                const scaleFactors = [1.00, 1.05, 1.10, 1.15, 1.20, 1.25]; // Index 0 for +0, 1 for +1, etc.
                const scaleFactor = scaleFactors[itemLevel] || 1.00; // Default to 1.00 if level out of bounds

                const scaledPerk = JSON.parse(JSON.stringify(itemMaster.perk)); // Deep copy to avoid modifying original

                switch (scaledPerk.type) {
                    case "timeReduction":
                    case "attackBoost":
                    case "defenseBoost":
                        scaledPerk.value = Math.round(itemMaster.perk.value * scaleFactor);
                        break;
                    case "pvBonus": // e.g., value: 0.10 for +10%
                    case "goldChanceIncrease": // e.g., value: 0.5 for +50% to chance factor
                        scaledPerk.value = parseFloat((itemMaster.perk.value * scaleFactor).toFixed(4));
                        break;
                    case "materialChanceMultiplier": // e.g., value: 1.3 for x1.3
                         scaledPerk.value = parseFloat((itemMaster.perk.value * scaleFactor).toFixed(4));
                        break;
                    case "flatCurrencyChanceBoost":
                        if (scaledPerk.goldBonus !== undefined) {
                            scaledPerk.goldBonus = parseFloat((itemMaster.perk.goldBonus * scaleFactor).toFixed(4));
                        }
                        if (scaledPerk.diamondBonus !== undefined) {
                            scaledPerk.diamondBonus = parseFloat((itemMaster.perk.diamondBonus * scaleFactor).toFixed(4));
                        }
                        break;
                    case "statBoost":
                        if (scaledPerk.attack !== undefined) {
                            scaledPerk.attack = Math.round(itemMaster.perk.attack * scaleFactor);
                        }
                        if (scaledPerk.defense !== undefined) {
                            scaledPerk.defense = Math.round(itemMaster.perk.defense * scaleFactor);
                        }
                        break;
                    default:
                        // No scaling for unknown perk types
                        break;
                }
                return scaledPerk;
            }


            // --- Tooltip Functions ---
            function showItemTooltip(event, itemData, isCraftable = false) {
                if (!itemTooltipElement || !itemData) return;

                const currentItemLevel = itemData.level || 0; // itemData might already have .level if it's an instance
                const baseItemMaster = craftableItemsData.find(ci => ci.id === itemData.id) || shopItemsData.find(si => si.id === itemData.id) || itemData; // Ensure we have the base master data for perks

                let contentHtml = `<h5>${itemData.name} <small>(${itemData.type || 'Item'})</small></h5>`;
                contentHtml += `<p>${itemData.description || 'No description.'}</p>`;

                if (baseItemMaster.perk) {
                    const displayPerk = getScaledItemPerk(baseItemMaster, currentItemLevel);
                    contentHtml += `<p class="perk-info">Perk: `;
                    if (displayPerk.type === "timeReduction") contentHtml += `Adventure time -${displayPerk.value / 60} mins.`;
                    else if (displayPerk.type === "goldChanceIncrease") contentHtml += `Gold find chance +${(displayPerk.value * 100).toFixed(1)}%.`;
                    else if (displayPerk.type === "pvBonus") contentHtml += `PV Tokens +${(displayPerk.value * 100).toFixed(1)}%.`;
                    else if (displayPerk.type === "materialChanceMultiplier") contentHtml += `Material find x${displayPerk.value.toFixed(2)}.`;
                    else if (displayPerk.type === "attackBoost") contentHtml += `Attack +${displayPerk.value}.`;
                    else if (displayPerk.type === "defenseBoost") contentHtml += `Defense +${displayPerk.value}.`;
                    else if (displayPerk.type === "flatCurrencyChanceBoost") contentHtml += `Gold/Diamond find +${(displayPerk.goldBonus * 100).toFixed(1)}% / +${(displayPerk.diamondBonus * 100).toFixed(1)}%.`;
                     else if (displayPerk.type === "statBoost") {
                        let stats = [];
                        if(displayPerk.attack !== undefined) stats.push(`Attack ${displayPerk.attack > 0 ? '+' : ''}${displayPerk.attack}`);
                        if(displayPerk.defense !== undefined) stats.push(`Defense ${displayPerk.defense > 0 ? '+' : ''}${displayPerk.defense}`);
                        contentHtml += stats.join(', ') + '.';
                    }
                    contentHtml += `</p>`;
                }
                if (itemData.level > 0) { // Item level for +X display
                     contentHtml += `<p>Level: +${itemData.level}</p>`;
                }
                 if (itemData.tier !== undefined) { // Item base tier
                    contentHtml += `<p><small>Base Tier: ${itemData.tier}</small></p>`;
                }


                if (isCraftable && itemData.recipe) {
                    contentHtml += `<div class="recipe-info"><strong>Requires:</strong><ul>`;
                    for (const mat in itemData.recipe) {
                        contentHtml += `<li>${itemData.recipe[mat]} ${mat}</li>`;
                    }
                    contentHtml += `</ul></div>`;
                }
                 if (itemData.price) { 
                    contentHtml += `<p>Price: <span class="pv">${itemData.price} PV</span></p>`;
                }


                itemTooltipElement.innerHTML = contentHtml;
                itemTooltipElement.style.display = 'block';
                
                const targetElement = event.target.closest('.shop-item, .craftable-item-card, .inventory-item-card, .equipment-slot .equipped-item-container');
                if (!targetElement) return; 

                const rect = targetElement.getBoundingClientRect();
                let x = rect.right + 10; 
                let y = rect.top;

                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                const tooltipWidth = itemTooltipElement.offsetWidth;
                const tooltipHeight = itemTooltipElement.offsetHeight;

                if (x + tooltipWidth > screenWidth) {
                    x = rect.left - tooltipWidth - 10; 
                }
                if (x < 0) x = 5;


                if (y + tooltipHeight > screenHeight) {
                    y = screenHeight - tooltipHeight - 5;
                }
                 if (y < 0) y = 5;


                itemTooltipElement.style.left = x + 'px';
                itemTooltipElement.style.top = y + 'px';
            }
            function hideItemTooltip() {
                if (itemTooltipElement) itemTooltipElement.style.display = 'none';
            }


            // --- Popup Functions ---
            function processPopupQueue() { 
                if (isPopupCurrentlyVisible || popupMessageQueue.length === 0) { return; } 
                isPopupCurrentlyVisible = true; 
                const { message, title, craftCallback, confirmCallback } = popupMessageQueue.shift(); 
                if (customPopupTitleEl) customPopupTitleEl.textContent = title; 
                if (customPopupMessageEl) customPopupMessageEl.innerHTML = message; 
                
                const existingCraftBtn = document.getElementById('popupCraftAgainBtn');
                if (existingCraftBtn) existingCraftBtn.remove();

                customPopupConfirmBtn.classList.add('hidden');
                customPopupCancelBtn.classList.add('hidden');
                customPopupCloseBtn.classList.remove('hidden');


                if (craftCallback) {
                    const craftBtn = document.createElement('button');
                    craftBtn.id = 'popupCraftAgainBtn';
                    craftBtn.className = 'action-button';
                    craftBtn.textContent = 'Craft Again';
                    craftBtn.onclick = () => {
                        craftCallback();
                        hideCustomPopup();
                    };
                    customPopupButtonsEl.appendChild(craftBtn);
                } else if (confirmCallback) {
                    customPopupConfirmBtn.classList.remove('hidden');
                    customPopupCancelBtn.classList.remove('hidden');
                    customPopupCloseBtn.classList.add('hidden');

                    customPopupConfirmBtn.onclick = () => {
                        confirmCallback(true);
                        hideCustomPopup();
                    };
                    customPopupCancelBtn.onclick = () => {
                        confirmCallback(false);
                        hideCustomPopup();
                    };
                }


                if (customPopupOverlay) customPopupOverlay.classList.remove('hidden'); 
                if (customPopup) customPopup.classList.remove('hidden'); 
                if (customPopupCloseBtn && !confirmCallback) customPopupCloseBtn.focus(); 
                else if (customPopupConfirmBtn && confirmCallback) customPopupConfirmBtn.focus();
            }
            function showCustomPopup(message, title = "Notification", options = {}) { 
                const { craftCallback = null, confirmCallback = null } = options;
                popupMessageQueue.push({ message, title, craftCallback, confirmCallback }); 
                processPopupQueue(); 
            }
            function hideCustomPopup() { 
                if (customPopupOverlay) customPopupOverlay.classList.add('hidden'); 
                if (customPopup) customPopup.classList.add('hidden'); 
                isPopupCurrentlyVisible = false; 
                currentPopupCraftCallback = null;
                currentPopupConfirmCallback = null;
                
                const existingCraftBtn = document.getElementById('popupCraftAgainBtn');
                if (existingCraftBtn) existingCraftBtn.remove();

                customPopupConfirmBtn.classList.add('hidden');
                customPopupCancelBtn.classList.add('hidden');
                customPopupCloseBtn.classList.remove('hidden'); // Ensure OK button is visible by default

                processPopupQueue(); 
            }

            if (customPopupCloseBtn) customPopupCloseBtn.addEventListener('click', hideCustomPopup);
            if (customPopupOverlay) customPopupOverlay.addEventListener('click', (event) => { if (event.target === customPopupOverlay) { hideCustomPopup(); } });

            // --- Firebase Auth State Change Listener ---
             onAuthStateChanged(auth, async (user) => {
                currentUser = user;
                if (user) {
                    console.log("User signed in:", user.uid, user.email, user.displayName);
                    welcomeScreen.classList.add('hidden');
                    gameContainer.classList.remove('hidden');
                    signOutButton.classList.remove('hidden');

                    if (user.email && user.email.toLowerCase() === 'nvoiysol@gmail.com' && adminRafflePanel) { 
                        adminRafflePanel.classList.remove('hidden');
                    } else if (adminRafflePanel) {
                        adminRafflePanel.classList.add('hidden');
                    }

                    const currentThemeIsDark = body.classList.contains('dark-mode');
                    loadTwitterWidget(currentThemeIsDark ? 'dark' : 'light');
                    
                    const loadedState = await loadGameStateFromFirebase(user.uid);
                    if (loadedState) {
                        applyLoadedGameState(loadedState);
                    } else {
                        const nicknameForNewUser = user.displayName || authNicknameInput.value.trim() || "Voyager";
                        await createInitialGameState(user.uid, nicknameForNewUser); 
                    }
                    showPage('adventures-page'); 
                } else {
                    console.log("User signed out.");
                    currentUser = null;
                    userNickname = '';
                    welcomeScreen.classList.remove('hidden');
                    gameContainer.classList.add('hidden');
                    signOutButton.classList.add('hidden');
                    if (adminRafflePanel) adminRafflePanel.classList.add('hidden');
                    resetGameStateToDefaults(); 
                    updateStatsDisplay(); 
                    updateWalletDisplay(null);
                }
            });
            
            function resetGameStateToDefaults() {
                currentPvTokens = 0; currentGold = 0; currentDiamonds = 0;
                activeAdventures = []; nextActiveAdventureId = 0;
                totalAvailableAdventurers = MAX_PLAYER_ADVENTURERS;
                playerInventory = []; nextUniqueInstanceId = 0;
                playerMaterials = { ...initialPlayerMaterials };
                playerScrolls = { low: 0, middle: 0, high: 0 };
                playerHasPurchasedRiderScroll = false;
                totalAdventuresCompleted = 0;

                equippedItems = { Armour: null, Helmet: null, Boots: null, Amulet: null, Ring1: null, Ring2: null, Weapon: null, Misc1: null, Misc2: null };
                playerAdventurerLevel = 1; 
                secondRingSlotUnlocked = false;
                activePotions = [];
                allRaffles = []; 
                playerRaffleEntries = {}; 
                quests.forEach(q => { q.progress = 0; q.completed = false; q.claimed = false; }); 
                lastDailyRewardDayClaimed = 0; 
                lastDailyRewardClaimTimestamp = 0;
                selectedItemForUpgrade = null;
                selectedScrollForUpgrade = null;
                isGoldToDiamondSwap = true; updateSwapDisplay();


                if(sidebarActiveAdventuresList) sidebarActiveAdventuresList.innerHTML = '';
                if(activePotionsList) activePotionsList.innerHTML = '';
                if(materialsListContainer) materialsListContainer.innerHTML = '';
                if(inventoryItemsContainer) inventoryItemsContainer.innerHTML = '';
                if(equipmentSlotsDisplay) equipmentSlotsDisplay.innerHTML = '';
                if (whitelistRafflesContainer) whitelistRafflesContainer.innerHTML = '';
                if (dailyRewardsGrid) dailyRewardsGrid.innerHTML = ''; 
                if (leaderboardDisplayList) leaderboardDisplayList.innerHTML = '<li>Click a filter above to load a leaderboard.</li>';
                if (leaderboardCurrentTypeTitle) leaderboardCurrentTypeTitle.textContent = 'Leaderboard';
                if (upgradeResultDisplay) upgradeResultDisplay.textContent = '';
                if (selectedItemForUpgradeDisplay) selectedItemForUpgradeDisplay.innerHTML = 'Item: None';
                if (selectedScrollForUpgradeDisplay) selectedScrollForUpgradeDisplay.innerHTML = 'Scroll: None';
                if (upgradeSuccessRateDisplay) upgradeSuccessRateDisplay.textContent = '';
                updatePlayerCombatStatsDisplay(); 
            }


            // --- Auth Form Toggle ---
            authToggleLink.addEventListener('click', () => {
                const isLoginModeCurrently = !registerButton.classList.contains('hidden'); // If register button is shown, we are in register mode
                loginRegisterForm.reset(); 
                if (isLoginModeCurrently) { // Switch to Login
                    authFormTitle.textContent = "Login to Punk Voyage Adventures";
                    authNicknameField.classList.add('hidden');
                    loginButton.classList.remove('hidden');
                    registerButton.classList.add('hidden');
                    authToggleLink.textContent = "Need an account? Register";
                } else { // Switch to Register
                    authFormTitle.textContent = "Register for Punk Voyage Adventures";
                    authNicknameField.classList.remove('hidden');
                    loginButton.classList.add('hidden');
                    registerButton.classList.remove('hidden');
                    authToggleLink.textContent = "Already have an account? Login";
                }
            });


            // --- Auth Event Listeners ---
            loginButton.addEventListener('click', async () => {
                const email = authEmailInput.value.trim();
                const password = authPasswordInput.value;
                if (!email || !password) {
                    showCustomPopup("Please enter both email and password.", "Login Error");
                    return;
                }
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Login error:", error);
                    showCustomPopup(`Login failed: ${error.code} - ${error.message}`, "Login Error");
                }
            });

            registerButton.addEventListener('click', async () => {
                const email = authEmailInput.value.trim();
                const password = authPasswordInput.value;
                const nickname = authNicknameInput.value.trim();

                if (!email || !password || !nickname) {
                    showCustomPopup("Please fill in all fields: email, password, and nickname.", "Registration Error");
                    return;
                }
                if (password.length < 6) {
                     showCustomPopup("Password must be at least 6 characters long.", "Registration Error");
                    return;
                }
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Registration error:", error);
                    showCustomPopup(`Registration failed: ${error.code} - ${error.message}`, "Registration Error");
                }
            });

            googleSignInButton.addEventListener('click', async () => {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Google Sign-In error:", error);
                    showCustomPopup(`Google Sign-In failed: ${error.code} - ${error.message}`, "Google Sign-In Error");
                }
            });

            signOutButton.addEventListener('click', async () => {
                try {
                    await fbSignOut(auth);
                } catch (error) {
                    console.error("Sign out error:", error);
                    showCustomPopup(`Sign out failed: ${error.message}`, "Sign Out Error");
                }
            });
            
            forgotPasswordLink.addEventListener('click', async () => {
                const email = authEmailInput.value.trim();
                if (!email) {
                    showCustomPopup("Please enter your email address in the email field to reset your password.", "Password Reset");
                    return;
                }
                try {
                    await sendPasswordResetEmail(auth, email);
                    showCustomPopup(`Password reset email sent to ${email}. Please check your inbox (and spam folder).`, "Password Reset");
                } catch (error) {
                    console.error("Password reset error:", error);
                    showCustomPopup(`Password reset failed: ${error.message}`, "Password Reset Error");
                }
            });


            // --- Firebase Save/Load ---
            async function saveGameStateToFirebase(userId, gameState) { 
                if (!userId) { console.error("Cannot save game: User ID (UID) is missing."); showCustomPopup("Error: User ID is missing. Cannot save progress.", "Save Error"); return; } 
                if (!db) { console.error("Firestore not initialized!"); showCustomPopup("Error: Database connection failed. Cannot save progress.", "Save Error"); return; } 
                try { 
                    const savableGameState = { ...gameState }; 
                    if (savableGameState.activeAdventures) { savableGameState.activeAdventures = savableGameState.activeAdventures.map(adv => ({ ...adv, returnTime: typeof adv.returnTime === 'number' ? adv.returnTime : (adv.returnTime instanceof Date ? Timestamp.fromDate(adv.returnTime) : Timestamp.now()) })); } 
                    if (savableGameState.activePotions) { savableGameState.activePotions = savableGameState.activePotions.map(p => ({ ...p, endTime: typeof p.endTime === 'number' ? p.endTime : (p.endTime instanceof Date ? Timestamp.fromDate(p.endTime) : null) })); } 
                    
                    savableGameState.nickname = userNickname || "Voyager";
                    savableGameState.lastDailyRewardDayClaimed = lastDailyRewardDayClaimed;
                    savableGameState.lastDailyRewardClaimTimestamp = lastDailyRewardClaimTimestamp;
                    savableGameState.nextUniqueInstanceId = nextUniqueInstanceId;


                    const playerDocRef = doc(collection(db, 'playerProgress'), userId); 
                    await setDoc(playerDocRef, savableGameState); 
                    console.log("Game state saved for user ID:", userId); 
                } catch (error) { 
                    console.error("Error saving game state: ", error); 
                    showCustomPopup(`Failed to save game progress: ${error.message}`, "Save Error");
                }
            }

            async function loadGameStateFromFirebase(userId) { 
                if (!userId) { console.error("Cannot load game: User ID (UID) is missing."); return null; } 
                if (!db) { console.error("Firestore not initialized!"); return null;} 
                try { 
                    const playerDocRef = doc(collection(db, 'playerProgress'), userId); 
                    const docSnap = await getDoc(playerDocRef); 
                    if (docSnap.exists()) { 
                        const loadedData = docSnap.data(); 
                        console.log("Raw loaded data from Firebase for UID", userId, JSON.parse(JSON.stringify(loadedData))); 
                        if (loadedData.activeAdventures) { loadedData.activeAdventures = loadedData.activeAdventures.map(adv => ({ ...adv, returnTime: adv.returnTime && typeof adv.returnTime.toDate === 'function' ? adv.returnTime.toDate().getTime() : (typeof adv.returnTime === 'number' ? adv.returnTime : Date.now()) })); } 
                        if (loadedData.activePotions) { loadedData.activePotions = loadedData.activePotions.map(p => ({ ...p, endTime: p.endTime && typeof p.endTime.toDate === 'function' ? p.endTime.toDate().getTime() : (typeof p.endTime === 'number' ? p.endTime : null) })); } 
                        console.log("Processed loaded data before apply:", JSON.parse(JSON.stringify(loadedData))); 
                        return loadedData; 
                    } else { 
                        console.log("No saved game state found for UID", userId); 
                        return null; 
                    } 
                } catch (error) { 
                    console.error("Error directly within loadGameStateFromFirebase:", error); 
                    showCustomPopup(`Failed to load game progress from Firebase: ${error.message}`, "DB Load Error"); 
                    return null;
                }
            }
            
            async function createInitialGameState(userId, nicknameToUse) {
                console.log("Creating initial game state for new user:", userId, "Nickname:", nicknameToUse);
                userNickname = nicknameToUse; 
                const initialGameState = {
                    nickname: nicknameToUse,
                    pvTokens: 0, 
                    gold: 0, 
                    diamonds: 0, 
                    activeAdventures: [],
                    totalAvailableAdventurers: MAX_PLAYER_ADVENTURERS,
                    playerInventory: [], 
                    nextUniqueInstanceId: 0,
                    playerMaterials: { ...initialPlayerMaterials },
                    playerScrolls: { low: 0, middle: 0, high: 0 },
                    playerHasPurchasedRiderScroll: false,
                    totalAdventuresCompleted: 0,
                    equippedItems: { Armour: null, Helmet: null, Boots: null, Amulet: null, Ring1: null, Ring2: null, Weapon: null, Misc1: null, Misc2: null },
                    quests: quests.map(q => ({ ...q, progress: 0, completed: false, claimed: false })), 
                    activePotions: [],
                    playerAdventurerLevel: 1,
                    secondRingSlotUnlocked: false,
                    playerRaffleEntries: {},
                    lastDailyRewardDayClaimed: 0, 
                    lastDailyRewardClaimTimestamp: 0 
                };
                await saveGameStateToFirebase(userId, initialGameState); 
                applyLoadedGameState(initialGameState); 
                showCustomPopup(`Welcome, ${nicknameToUse}! Your new voyage begins!`, "New Game Created");
            }
            
            function getCurrentGameState() { 
                return { 
                    nickname: userNickname || "Voyager",
                    pvTokens: currentPvTokens || 0, 
                    gold: currentGold || 0, 
                    diamonds: currentDiamonds || 0, 
                    activeAdventures: Array.isArray(activeAdventures) ? activeAdventures.map(adv => ({ id: adv.id, originalAdventureId: adv.originalAdventureId, name: adv.name || "Unknown Adventure", adventurers: adv.adventurers || 0, returnTime: adv.returnTime || Date.now(), pvReward: adv.pvReward || 0, goldChance: adv.goldChance || 0, diamondChance: adv.diamondChance || 0 })) : [], 
                    totalAvailableAdventurers: totalAvailableAdventurers !== undefined ? totalAvailableAdventurers : MAX_PLAYER_ADVENTURERS, 
                    playerInventory: Array.isArray(playerInventory) ? playerInventory : [], 
                    nextUniqueInstanceId: nextUniqueInstanceId,
                    playerMaterials: playerMaterials || { ...initialPlayerMaterials }, 
                    playerScrolls: playerScrolls || { low: 0, middle: 0, high: 0 },
                    playerHasPurchasedRiderScroll: playerHasPurchasedRiderScroll || false,
                    totalAdventuresCompleted: totalAdventuresCompleted || 0,
                    equippedItems: equippedItems || { Armour: null, Helmet: null, Boots: null, Amulet: null, Ring1: null, Ring2: null, Weapon: null, Misc1: null, Misc2: null }, 
                    quests: Array.isArray(quests) ? quests.map(q => ({ id: q.id, text: q.text || "UKN", reward: q.reward || "0", completed: q.completed || false, progress: q.progress || 0, target: q.target || 0, adventureName: q.adventureName || null, metric: q.metric || null, claimed: q.claimed || false })) : [], 
                    activePotions: Array.isArray(activePotions) ? activePotions.map(p => ({ id: p.id, endTime: p.endTime || null, adventuresLeft: p.adventuresLeft !== undefined ? p.adventuresLeft : null })).filter(p => p.id) : [], 
                    playerAdventurerLevel: playerAdventurerLevel || 1, 
                    secondRingSlotUnlocked: secondRingSlotUnlocked || false, 
                    playerRaffleEntries: playerRaffleEntries || {},
                    lastDailyRewardDayClaimed: lastDailyRewardDayClaimed, 
                    lastDailyRewardClaimTimestamp: lastDailyRewardClaimTimestamp 
                };
            }

            function applyLoadedGameState(loadedState) {
                console.log("Applying loaded game state:", JSON.parse(JSON.stringify(loadedState)));
                if (!loadedState) {
                    console.error("applyLoadedGameState called with null or undefined state.");
                    showCustomPopup("No game data found to load. Starting fresh or try logging in again.", "Load Error");
                    return;
                }
                try {
                    userNickname = loadedState.nickname || "Voyager";
                    if (playerNicknameDisplay && userNickname) playerNicknameDisplay.textContent = userNickname;
                    currentPvTokens = loadedState.pvTokens || 0;
                    currentGold = loadedState.gold || 0;
                    currentDiamonds = loadedState.diamonds || 0;

                    activeAdventures = Array.isArray(loadedState.activeAdventures) ? loadedState.activeAdventures.map(advData => {
                        return {
                            id: advData.id || nextActiveAdventureId++,
                            originalAdventureId: advData.originalAdventureId || "1",
                            name: advData.name || "Unknown Adventure",
                            adventurers: advData.adventurers || 0,
                            returnTime: typeof advData.returnTime === 'number' ? advData.returnTime : Date.now(),
                            pvReward: advData.pvReward || 0,
                            goldChance: advData.goldChance || 0,
                            diamondChance: advData.diamondChance || 0
                        };
                    }) : [];
                    nextActiveAdventureId = activeAdventures.length > 0 ? Math.max(0, ...activeAdventures.map(a => a.id)) + 1 : 0;

                    totalAvailableAdventurers = loadedState.totalAvailableAdventurers !== undefined ? loadedState.totalAvailableAdventurers : MAX_PLAYER_ADVENTURERS;
                    totalAdventuresCompleted = loadedState.totalAdventuresCompleted || 0;

                    nextUniqueInstanceId = loadedState.nextUniqueInstanceId || 0; 
                    playerInventory = []; 
                    if (Array.isArray(loadedState.playerInventory)) {
                        loadedState.playerInventory.forEach(itemSource => {
                            if (!itemSource) return; 
                            if (itemSource.id === "scroll_low" || itemSource.id === "scroll_mid" || itemSource.id === "scroll_high" || (itemSource.type && itemSource.type === "upgrade_scroll")) {
                                return; 
                            }
                            let newItem = {};
                            if (typeof itemSource === 'string') { 
                                newItem = {
                                    id: itemSource,
                                    level: 0,
                                    uniqueInstanceId: `legacy_${nextUniqueInstanceId++}`
                                };
                            } else { 
                                newItem = {
                                    id: itemSource.id, 
                                    level: itemSource.level || 0,
                                    uniqueInstanceId: itemSource.uniqueInstanceId || `loaded_${nextUniqueInstanceId++}`
                                };
                            }
                            if (newItem.id) { 
                                playerInventory.push(newItem);
                            } else {
                                console.warn("Loaded inventory item source without an ID:", itemSource);
                            }
                        });
                    }
                    
                    playerMaterials = loadedState.playerMaterials || { ...initialPlayerMaterials };
                    playerScrolls = loadedState.playerScrolls || { low: 0, middle: 0, high: 0 };
                    playerHasPurchasedRiderScroll = loadedState.playerHasPurchasedRiderScroll || false;

                    equippedItems = loadedState.equippedItems || { Armour: null, Helmet: null, Boots: null, Amulet: null, Ring1: null, Ring2: null, Weapon: null, Misc1: null, Misc2: null };
                    playerAdventurerLevel = loadedState.playerAdventurerLevel || 1;
                    secondRingSlotUnlocked = loadedState.secondRingSlotUnlocked || false;
                    playerRaffleEntries = loadedState.playerRaffleEntries || {};

                    lastDailyRewardDayClaimed = loadedState.lastDailyRewardDayClaimed || 0;
                    lastDailyRewardClaimTimestamp = loadedState.lastDailyRewardClaimTimestamp || 0;

                    if (Array.isArray(loadedState.quests)) {
                        quests.forEach(q_default => {
                            const loaded_q = loadedState.quests.find(lq => lq && lq.id === q_default.id);
                            if (loaded_q) {
                                q_default.completed = loaded_q.completed || false;
                                q_default.progress = loaded_q.progress || 0;
                                q_default.claimed = loaded_q.claimed || false;
                            }
                        });
                    }

                    if (Array.isArray(loadedState.activePotions)) {
                        activePotions = loadedState.activePotions.map(pData => {
                            if (!pData || !pData.id) return null;
                            const potionBase = shopItemsData.find(shopItem => shopItem.id === pData.id);
                            if (!potionBase) return null;
                            return {
                                id: pData.id,
                                name: potionBase.name,
                                description: potionBase.description,
                                effect: potionBase.effect,
                                endTime: typeof pData.endTime === 'number' ? pData.endTime : null,
                                adventuresLeft: pData.adventuresLeft !== undefined ? pData.adventuresLeft : null
                            };
                        }).filter(p => p !== null);
                        activePotions = activePotions.filter(p => (p.endTime && Date.now() < p.endTime) || (p.adventuresLeft !== undefined && p.adventuresLeft > 0) || (!p.endTime && p.adventuresLeft === undefined));
                    }

                    updateStatsDisplay();
                    updatePlayerCombatStatsDisplay();
                    renderMaterials();
                    renderActiveAdventuresInSidebar();
                    renderActivePotions();
                    renderInventory(); 
                    updateAdventureDisplayStates();
                    updateSwapDisplay(); // For currency swap

                    const activePageElement = document.querySelector('.page-content.active');
                    if (activePageElement) {
                        const pageId = activePageElement.id;
                        if (pageId === 'quests-page') renderQuests();
                        else if (pageId === 'daily-rewards-page') renderDailyRewards();
                        else if (pageId === 'shop-page') renderShopItems();
                        else if (pageId === 'crafting-page') renderCraftingItems();
                        else if (pageId === 'whitelist-page') fetchAndDisplayRaffles();
                        else if (pageId === 'leaderboard-page') fetchAndDisplayLeaderboards('pvTokens'); 
                    }
                    console.log("Game state applied successfully.");
                } catch (error) {
                    console.error("Error during applyLoadedGameState:", error, error.stack); 
                    showCustomPopup("Error applying loaded game data. Please try logging in again or contact support if this persists.", "Apply State Error");
                }
            }
            

            // --- Theme and Page Navigation ---
            function initializeTheme() { const savedTheme = localStorage.getItem('theme'); if (savedTheme === 'light') { body.classList.remove('dark-mode'); body.classList.add('light-mode'); if(darkModeToggle) darkModeToggle.checked = false; if (gameContainer && !gameContainer.classList.contains('hidden')) loadTwitterWidget('light'); } else { body.classList.add('dark-mode'); body.classList.remove('light-mode'); if(darkModeToggle) darkModeToggle.checked = true; if (gameContainer && !gameContainer.classList.contains('hidden')) loadTwitterWidget('dark'); } }
            function loadTwitterWidget(theme) { if (twitterWidgetContainer) { twitterWidgetContainer.innerHTML = ''; const twitterLink = document.createElement('a'); twitterLink.className = 'twitter-timeline'; twitterLink.setAttribute('data-dnt', 'true'); twitterLink.href = 'https://twitter.com/nvart_?ref_src=twsrc%5Etfw'; twitterLink.setAttribute('data-theme', theme); twitterLink.setAttribute('data-height', '400'); twitterLink.textContent = 'Tweets by nvart_'; twitterWidgetContainer.appendChild(twitterLink); let twitterScript = document.querySelector('script[src="https://platform.twitter.com/widgets.js"]'); if (twitterScript) { twitterScript.remove(); } twitterScript = document.createElement('script'); twitterScript.async = true; twitterScript.src = 'https://platform.twitter.com/widgets.js'; twitterScript.charset = 'utf-8'; document.body.appendChild(twitterScript); } }
            
            if(darkModeToggle){ darkModeToggle.addEventListener('change', () => { if (darkModeToggle.checked) { body.classList.add('dark-mode'); body.classList.remove('light-mode'); localStorage.setItem('theme', 'dark'); loadTwitterWidget('dark'); } else { body.classList.remove('dark-mode'); body.classList.add('light-mode'); localStorage.setItem('theme', 'light'); loadTwitterWidget('light'); } });}
            async function showPage(pageIdToShow) { console.log("Switching to page:", pageIdToShow); if(!pageContents || pageContents.length === 0) { console.error("pageContents NodeList is empty or not found in showPage. Ensure HTML elements with class 'page-content' exist and are selected correctly."); return; } pageContents.forEach(page => { page.classList.remove('active'); }); const targetPage = document.getElementById(pageIdToShow); if (targetPage) { targetPage.classList.add('active'); if (pageIdToShow === 'quests-page') renderQuests(); else if (pageIdToShow === 'shop-page') renderShopItems(); else if (pageIdToShow === 'crafting-page') renderCraftingItems(); else if (pageIdToShow === 'inventory-page') renderInventory(); else if (pageIdToShow === 'daily-rewards-page') renderDailyRewards(); else if (pageIdToShow === 'whitelist-page') await fetchAndDisplayRaffles(); else if (pageIdToShow === 'upgrade-page') { /* placeholder for upgrade page specific logic if any needed on show */ } else if (pageIdToShow === 'leaderboard-page') await fetchAndDisplayLeaderboards('pvTokens'); else if (pageIdToShow === 'dungeons-page') { /* placeholder for dungeons */ } } else { console.error("Target page with ID '" + pageIdToShow + "' not found."); showPage('adventures-page'); }}
            if(menuItems){ menuItems.forEach(item => { item.addEventListener('click', () => { const targetPageId = item.dataset.page; if (targetPageId) { showPage(targetPageId); } }); });}
            

            // --- Core Game Logic Display & Updates ---
            updateStatsDisplay(); 
            
            function updateStatsDisplay() { if(pvCountElement) pvCountElement.textContent = currentPvTokens; if(goldCountElement) goldCountElement.textContent = currentGold; if(diamondCountElement) diamondCountElement.textContent = currentDiamonds; if(availableAdventurersCountElement) availableAdventurersCountElement.textContent = totalAvailableAdventurers; }
            function formatTimeLeft(milliseconds) { if (milliseconds <= 0) return "Ended"; let ts = Math.ceil(milliseconds / 1000); let h = Math.floor(ts / 3600); ts %= 3600; let m = Math.floor(ts / 60); let s = ts % 60; return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`; }
            
            function renderActiveAdventuresInSidebar() {
                if (!sidebarActiveAdventuresList || !sidebarActiveAdventuresContainer) return;
                sidebarActiveAdventuresList.innerHTML = '';
                if (activeAdventures.length === 0) {
                    const p = document.createElement('p');
                    p.textContent = "No adventurers currently on an adventure.";
                    p.style.textAlign = "center";
                    sidebarActiveAdventuresList.appendChild(p);
                } else {
                    activeAdventures.forEach(adv => {
                        const itemDiv = document.createElement('div');
                        itemDiv.classList.add('active-adventure-item');
                        itemDiv.dataset.instanceId = adv.id;
                        const timeLeftMs = adv.returnTime - Date.now();

                        const infoDiv = document.createElement('div');
                        infoDiv.classList.add('active-adventure-item-info');
                        infoDiv.innerHTML = `<p><strong>${adv.name}</strong></p><p>Adventurers: ${adv.adventurers}</p><p>Time Left: <span class="timer">${formatTimeLeft(timeLeftMs)}</span></p>`;
                        
                        const cancelBtn = document.createElement('button');
                        cancelBtn.classList.add('cancel-adventure-btn');
                        cancelBtn.innerHTML = '&times;';
                        cancelBtn.title = 'Cancel Adventure';
                        cancelBtn.dataset.adventureInstanceId = adv.id;
                        cancelBtn.addEventListener('click', () => handleCancelAdventure(adv.id));

                        itemDiv.appendChild(infoDiv);
                        itemDiv.appendChild(cancelBtn);
                        sidebarActiveAdventuresList.appendChild(itemDiv);
                    });
                }
                sidebarActiveAdventuresContainer.classList.remove('hidden');
            }

            function renderActivePotions() { if (!activePotionsList || !activePotionsDisplay) return; activePotionsList.innerHTML = ''; if (activePotions.length === 0) { activePotionsDisplay.classList.add('hidden'); return; } activePotionsDisplay.classList.remove('hidden'); activePotions.forEach(potion => { const itemDiv = document.createElement('div'); itemDiv.classList.add('potion-item'); let details = ''; if (potion.endTime) { const timeLeftMs = potion.endTime - Date.now(); details = `Time Left: <span class="timer">${formatTimeLeft(timeLeftMs)}</span>`; } else if (potion.adventuresLeft !== undefined) { details = `Adventures Left: ${potion.adventuresLeft}`; } itemDiv.innerHTML = `<p><strong>${potion.name}</strong></p><p>${potion.description}</p><p>${details}</p>`; activePotionsList.appendChild(itemDiv); });}
            
            function updatePlayerCombatStatsDisplay() {
                if (!playerAttackStatElement || !playerDefenseStatElement) return;
                let totalAttack = 0;
                let totalDefense = 0;

                Object.values(equippedItems).forEach(equippedInstanceId => {
                    if (!equippedInstanceId) return;
                    const invItem = playerInventory.find(i => i.uniqueInstanceId === equippedInstanceId);
                    if (invItem) {
                        const itemMaster = craftableItemsData.find(im => im.id === invItem.id);
                        if (itemMaster && itemMaster.perk) {
                            const scaledPerk = getScaledItemPerk(itemMaster, invItem.level || 0);
                            if (scaledPerk) {
                                if (scaledPerk.type === "attackBoost") {
                                    totalAttack += scaledPerk.value;
                                } else if (scaledPerk.type === "defenseBoost") {
                                    totalDefense += scaledPerk.value;
                                } else if (scaledPerk.type === "statBoost") {
                                    totalAttack += (scaledPerk.attack || 0);
                                    totalDefense += (scaledPerk.defense || 0);
                                }
                            }
                        }
                    }
                });
                playerAttackStatElement.textContent = totalAttack;
                playerDefenseStatElement.textContent = totalDefense;
            }


            function renderMaterials() { 
                if (!materialsListContainer) return;
                materialsListContainer.innerHTML = ''; 

                for (const tier in materialTiers) {
                    const tierTitle = document.createElement('h5');
                    tierTitle.classList.add('material-tier-title');
                    tierTitle.textContent = `Tier ${tier} Materials:`;
                    materialsListContainer.appendChild(tierTitle);

                    const ul = document.createElement('ul');
                    let foundInTier = false;
                    materialTiers[tier].forEach(matName => {
                        if (playerMaterials.hasOwnProperty(matName) && playerMaterials[matName] > 0) {
                            const li = document.createElement('li');
                            li.textContent = `${matName}: ${playerMaterials[matName]}`;
                            ul.appendChild(li);
                            foundInTier = true;
                        }
                    });
                    if (!foundInTier) {
                         const li = document.createElement('li');
                         li.textContent = `No Tier ${tier} materials found.`;
                         ul.appendChild(li);
                    }
                    materialsListContainer.appendChild(ul);
                }
                const scrollsTitle = document.createElement('h5');
                scrollsTitle.classList.add('upgrade-scrolls-title');
                scrollsTitle.textContent = 'Upgrade Scrolls:';
                materialsListContainer.appendChild(scrollsTitle);
                const scrollsUl = document.createElement('ul');
                scrollsUl.appendChild(createScrollListItem("Low Class Scroll", playerScrolls.low));
                scrollsUl.appendChild(createScrollListItem("Middle Class Scroll", playerScrolls.middle));
                scrollsUl.appendChild(createScrollListItem("High Class Scroll", playerScrolls.high));
                materialsListContainer.appendChild(scrollsUl);
            }
            function createScrollListItem(name, count) {
                const li = document.createElement('li');
                li.textContent = `${name}: ${count}`;
                return li;
            }


             function getItemIconHTML(iconUrlOrColor, typeInitial = 'I', size = 'var(--item-icon-size)') {
                const isUrl = iconUrlOrColor && (iconUrlOrColor.startsWith('http') || iconUrlOrColor.startsWith('data:image') || iconUrlOrColor.startsWith('https://'));
                const iconContainer = document.createElement('div');
                iconContainer.style.width = size;
                iconContainer.style.height = size;
                iconContainer.style.display = 'flex';
                iconContainer.style.alignItems = 'center';
                iconContainer.style.justifyContent = 'center';
                iconContainer.style.marginRight = (size === 'var(--item-icon-size)') ? '10px' : '0'; 
                iconContainer.style.flexShrink = '0';
                iconContainer.style.overflow = 'hidden'; 
                iconContainer.style.borderRadius = '4px'; 


                if (isUrl) {
                    const img = document.createElement('img');
                    img.src = iconUrlOrColor;
                    img.alt = typeInitial;
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '100%';
                    img.style.objectFit = 'contain'; 
                    iconContainer.appendChild(img);
                } else {
                    iconContainer.style.backgroundColor = iconUrlOrColor || '#555'; 
                    iconContainer.style.color = 'white';
                    let fontSizeNum = 0.4; 
                    try {
                        const sizeValue = getComputedStyle(document.documentElement).getPropertyValue('--item-icon-size').trim();
                        if (sizeValue.endsWith('px')) {
                           fontSizeNum = (parseInt(sizeValue) * 0.4) / parseInt(getComputedStyle(document.body).fontSize) ; 
                        }
                    } catch (e) { /* use default */ }
                    iconContainer.style.fontSize = `${fontSizeNum}em`; 
                    iconContainer.textContent = typeInitial ? typeInitial.substring(0,1).toUpperCase() : 'I';
                }
                return iconContainer.outerHTML;
            }


            function renderCraftingItems() { 
                if(!craftingItemsContainer) return; 
                craftingItemsContainer.innerHTML = ''; 
                craftableItemsData.forEach(item => { 
                    const alreadyOwned = playerInventory.some(invItem => invItem.id === item.id) || Object.values(equippedItems).some(equippedInstanceId => { 
                        const eqItem = playerInventory.find(pi => pi.uniqueInstanceId === equippedInstanceId); 
                        return eqItem && eqItem.id === item.id; 
                    }); 
                    const card = document.createElement('div'); 
                    card.className = 'craftable-item-card'; 
                    let recipeHtml = 'Requires: '; 
                    for(const mat in item.recipe){ recipeHtml += `${item.recipe[mat]} ${mat}, `; } 
                    recipeHtml = recipeHtml.slice(0, -2); 
                    card.innerHTML = `
                        <div class="item-icon-placeholder">${getItemIconHTML(item.iconUrlOrColor, item.type)}</div> 
                        <div class="item-info"> 
                            <p><strong>${item.name}</strong> (${item.type})</p> 
                            <small>${item.description}</small> 
                            <p class="crafting-cost"><small>${recipeHtml}</small></p> 
                        </div> 
                        <button class="action-button craft-button" data-item-id="${item.id}" ${alreadyOwned ? 'disabled title="You already own an instance of this base item."' : ''}>${alreadyOwned ? 'Owned' : 'Craft'}</button>`; 
                    craftingItemsContainer.appendChild(card); 
                    card.addEventListener('mousemove', (e) => showItemTooltip(e, item, true)); 
                    card.addEventListener('mouseleave', hideItemTooltip);
                }); 
                document.querySelectorAll('.craft-button:not([disabled])').forEach(b => b.addEventListener('click', e => craftItem(e.target.dataset.itemId))); 
            }
            
            function renderInventory() { 
                if (!inventoryItemsContainer || !equipmentSlotsDisplay) return; 
                
                equipmentSlotsDisplay.innerHTML = ''; 
                const slotTypes = [ { name: "Armour", id: "Armour" }, { name: "Helmet", id: "Helmet" }, { name: "Boots", id: "Boots" }, { name: "Amulet", id: "Amulet" }, { name: "Ring 1", id: "Ring1" }, { name: "Ring 2", id: "Ring2" }, { name: "Weapon", id: "Weapon" }, { name: "Misc 1", id: "Misc1" }, { name: "Misc 2", id: "Misc2" } ]; 
                
                slotTypes.forEach(slot => { 
                    const slotDiv = document.createElement('div'); 
                    slotDiv.classList.add('equipment-slot'); 
                    
                    const equippedItemInstanceId = equippedItems[slot.id]; 
                    const equippedInvItem = playerInventory.find(invItem => invItem.uniqueInstanceId === equippedItemInstanceId);
                    const itemDataForSlot = equippedInvItem ? (craftableItemsData.find(i => i.id === equippedInvItem.id) || (equippedInvItem.id === "ring_cursedpower" ? craftableItemsData.find(i => i.id === "ring_cursedpower") : null)) : null;

                    let slotContent = `<div class="slot-name">${slot.name.toUpperCase()}</div>`; 
                    
                    if (slot.id === "Ring2" && !secondRingSlotUnlocked) {
                        slotDiv.classList.add('locked');
                        slotContent += `<div class="equipped-item-container"><div class="empty-slot-text">(Locked)</div>`; // Wrap for consistency
                        const riderScrollInInventory = playerInventory.find(item => item.id === 'rider_scroll_unlock');
                        if (riderScrollInInventory) {
                            slotContent += `<button class="action-button use-rider-scroll-btn" data-item-unique-id="${riderScrollInInventory.uniqueInstanceId}">Use Rider Scroll</button>`;
                        } else if (!playerHasPurchasedRiderScroll) { 
                             slotContent += `<div class="empty-slot-text" style="font-size:0.8em;">Purchase Rider Scroll from Shop</div>`;
                        }
                        slotContent += `</div>`;
                    } else {
                        slotContent += `<div class="equipped-item-container">`; // Container for tooltip target
                        if (itemDataForSlot && equippedInvItem) { 
                            const levelText = (equippedInvItem.level || 0) > 0 ? `(+${equippedInvItem.level || 0}) ` : '';
                            slotContent += `${getItemIconHTML(itemDataForSlot.iconUrlOrColor, itemDataForSlot.type, 'var(--item-icon-size)')} <div class="equipped-item-name">${levelText}${itemDataForSlot.name}</div> <button class="unequip-btn action-button" data-item-slot-id="${slot.id}">Unequip</button>`; 
                            if (equippedInvItem.level === 4) slotDiv.classList.add('item-level-plus4');
                            if (equippedInvItem.level === 5) slotDiv.classList.add('item-level-plus5');
                        } else { 
                            slotContent += `<div class="empty-slot-text">(Empty Slot)</div>`; 
                        }
                        slotContent += `</div>`;
                    }
                    slotDiv.innerHTML = slotContent; 
                    equipmentSlotsDisplay.appendChild(slotDiv); 

                    // Add tooltip listener to the container if item is equipped
                    const itemContainerForTooltip = slotDiv.querySelector('.equipped-item-container');
                    if (itemDataForSlot && equippedInvItem && itemContainerForTooltip) {
                        itemContainerForTooltip.addEventListener('mousemove', (e) => showItemTooltip(e, { ...itemDataForSlot, level: equippedInvItem.level || 0 }));
                        itemContainerForTooltip.addEventListener('mouseleave', hideItemTooltip);
                    }
                }); 
                equipmentSlotsDisplay.querySelectorAll('.unequip-btn').forEach(b => b.addEventListener('click', e => { const itemSlotId = e.target.dataset.itemSlotId; unequipItem(itemSlotId); })); 
                equipmentSlotsDisplay.querySelectorAll('.use-rider-scroll-btn').forEach(b => b.addEventListener('click', e => useRiderScrollUnlock(e.target.dataset.itemUniqueId)));
                
                inventoryItemsContainer.innerHTML = ''; 
                if (playerInventory.length === 0) { inventoryItemsContainer.innerHTML = '<p style="text-align:center;">Your bag is empty.</p>'; return; } 
                
                playerInventory.forEach(invItem => { 
                    let itemData = craftableItemsData.find(i => i.id === invItem.id); 
                    if (!itemData && invItem.id === "rider_scroll_unlock") { 
                        itemData = shopItemsData.find(si => si.id === "rider_scroll_unlock");
                    }
                    
                    if (itemData) { 
                        const card = document.createElement('div'); 
                        card.className = 'inventory-item-card'; 
                        if (invItem.level === 4) card.classList.add('item-level-plus4');
                        if (invItem.level === 5) card.classList.add('item-level-plus5');

                        let actionsHtml = ''; 
                        const isEquipped = Object.values(equippedItems).includes(invItem.uniqueInstanceId);
                        const levelText = (invItem.level || 0) > 0 ? `(+${invItem.level || 0}) ` : '';

                        if (itemData.type !== "Consumable" && itemData.type !== "upgrade_scroll_purchase" && itemData.type !== "unlockable_consumable" && !isEquipped ) { 
                            actionsHtml += `<button class="equip-btn action-button" data-item-unique-id="${invItem.uniqueInstanceId}">Equip</button>`; 
                        } 
                        
                        card.innerHTML = ` 
                            <div class="item-icon-placeholder">${getItemIconHTML(itemData.iconUrlOrColor, itemData.type)}</div> 
                            <div class="item-info"> 
                                <p><strong>${levelText}${itemData.name}</strong> (${itemData.type || 'Item'})</p> 
                                <small class="item-perk">${itemData.description || ''}</small> 
                            </div> 
                            <div class="item-actions">${actionsHtml} ${isEquipped ? '<span class="equipped-status">Equipped</span>' : ''}</div>`; 
                        inventoryItemsContainer.appendChild(card); 
                        card.addEventListener('mousemove', (e) => showItemTooltip(e, { ...itemData, level: invItem.level || 0 }));
                        card.addEventListener('mouseleave', hideItemTooltip);
                    } 
                }); 
                inventoryItemsContainer.querySelectorAll('.equip-btn').forEach(b => b.addEventListener('click', e => equipItem(e.target.dataset.itemUniqueId))); 
                updatePlayerCombatStatsDisplay(); 
            }


            function useRiderScrollUnlock(itemUniqueId) {
                if (!currentUser) return;
                const itemIndex = playerInventory.findIndex(item => item.uniqueInstanceId === itemUniqueId && item.id === 'rider_scroll_unlock');
                if (itemIndex === -1) {
                    showCustomPopup("Rider Scroll not found in inventory or invalid item.", "Error");
                    return;
                }
                if (secondRingSlotUnlocked) {
                    showCustomPopup("Second Ring Slot is already unlocked.", "Info");
                    playerInventory.splice(itemIndex, 1); 
                    renderInventory();
                    if (currentUser.uid) saveGameStateToFirebase(currentUser.uid, getCurrentGameState());
                    return;
                }

                secondRingSlotUnlocked = true;
                playerInventory.splice(itemIndex, 1); 

                showCustomPopup("Second Ring Slot Unlocked!", "Unlock Successful");
                renderInventory(); 
                if (currentUser.uid) saveGameStateToFirebase(currentUser.uid, getCurrentGameState());
            }


             function renderQuests() { 
                if (!questListDiv) return; 
                questListDiv.innerHTML = ''; 
                quests.forEach(quest => { 
                    const qe = document.createElement('div'); 
                    qe.classList.add('quest-item'); 
                    qe.innerHTML = `
                        <div class="quest-info">
                            <p>${quest.text} (${quest.progress || 0}/${quest.target||'N/A'})</p>
                        </div>
                        <div class="quest-actions">
                            <span class="quest-reward">Reward: ${quest.reward}</span>
                            <button class="action-button claim-quest-btn" data-quest-id="${quest.id}" ${quest.completed && !(quest.claimed) ? '' : 'disabled'}>${quest.claimed ? 'Claimed' : 'Claim'}</button>
                        </div>`; 
                    questListDiv.appendChild(qe); 
                }); 
                document.querySelectorAll('.claim-quest-btn').forEach(b => { 
                    b.addEventListener('click', (e) => { 
                        if (!currentUser) return; 
                        const qId = parseInt(e.target.dataset.questId); 
                        const q = quests.find(q => q.id === qId); 
                        if(q && q.completed && !q.claimed){ 
                            q.claimed = true; 
                            e.target.disabled = true; 
                            e.target.textContent = 'Claimed'; 
                            const rewardParts = q.reward.split(','); 
                            let pvReward = 0; 
                            let diamondReward = 0; 
                            let goldReward = 0;
                            rewardParts.forEach(part => { 
                                if (part.includes("PV")) pvReward = parseInt(part.match(/(\d+) PV/)[1]); 
                                if (part.includes("Diamond")) diamondReward = parseInt(part.match(/(\d+) Diamond/)[1]); 
                                if (part.includes("Gold")) goldReward = parseInt(part.match(/(\d+) Gold/)[1]); 
                            }); 
                            currentPvTokens += pvReward; 
                            currentDiamonds += diamondReward; 
                            currentGold += goldReward;
                            updateStatsDisplay(); 
                            showCustomPopup(`Claimed reward: ${q.reward} for completing quest: "${q.text}"`, "Quest Reward Claimed"); 
                            if (currentUser.uid) saveGameStateToFirebase(currentUser.uid, getCurrentGameState()); 
                            if ([1, 2, 3].includes(q.id)) { updateAdventureDisplayStates(); } 
                        } 
                    }); 
                }); 
            }
            
            function renderDailyRewards() {
                if (!dailyRewardsGrid) return;
                dailyRewardsGrid.innerHTML = '';
                const now = Date.now();
                let nextClaimableDay;

                if (lastDailyRewardDayClaimed === 0 || lastDailyRewardClaimTimestamp === 0) { 
                    nextClaimableDay = 1;
                } else if (now - lastDailyRewardClaimTimestamp >= TWENTY_FOUR_HOURS_MS) { 
                    if (lastDailyRewardDayClaimed >= 30) { 
                        nextClaimableDay = 1; 
                    } else {
                        nextClaimableDay = lastDailyRewardDayClaimed + 1;
                    }
                } else { 
                    nextClaimableDay = -1; 
                }

                let daysEffectivelyClaimedInThisCycle = lastDailyRewardDayClaimed;
                if (nextClaimableDay === 1 && lastDailyRewardDayClaimed >= 30 && (now - lastDailyRewardClaimTimestamp >= TWENTY_FOUR_HOURS_MS)) {
                    daysEffectivelyClaimedInThisCycle = 0;
                }


                dailyRewardsData.forEach(item => {
                    const dayDiv = document.createElement('div');
                    dayDiv.classList.add('reward-day');
                    let rewardText = item.reward;
                    if (item.day === 30) rewardText = `<strong style="color:var(--highlight-color-gold);">${item.reward}</strong>`;

                    const canClaimThisItem = (item.day === nextClaimableDay);
                    const isClaimedForDisplay = item.day <= daysEffectivelyClaimedInThisCycle && !canClaimThisItem;
                    
                    dayDiv.innerHTML = `<h5>Day ${item.day}</h5><p>${rewardText}</p>
                                        <button class="action-button claim-daily-reward-btn" data-day="${item.day}" 
                                                ${canClaimThisItem ? '' : 'disabled'}>
                                            ${isClaimedForDisplay ? 'Claimed' : (canClaimThisItem ? 'Claim' : 'Locked')}
                                        </button>`;
                    dailyRewardsGrid.appendChild(dayDiv);
                });

                document.querySelectorAll('.claim-daily-reward-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        if (!currentUser) return;
                        const dayToClaim = parseInt(e.target.dataset.day);
                        
                        const currentNow = Date.now();
                        let recheckNextClaimableDay;
                        if (lastDailyRewardDayClaimed === 0 || lastDailyRewardClaimTimestamp === 0) {
                            recheckNextClaimableDay = 1;
                        } else if (currentNow - lastDailyRewardClaimTimestamp >= TWENTY_FOUR_HOURS_MS) {
                            if (lastDailyRewardDayClaimed >= 30) recheckNextClaimableDay = 1;
                            else recheckNextClaimableDay = lastDailyRewardDayClaimed + 1;
                        } else {
                            recheckNextClaimableDay = -1;
                        }

                        if (dayToClaim !== recheckNextClaimableDay) {
                            showCustomPopup("Not eligible to claim this reward now.", "Claim Error");
                            renderDailyRewards(); 
                            return;
                        }

                        const rewardItem = dailyRewardsData.find(d => d.day === dayToClaim);
                        if (!rewardItem) return;

                        if (lastDailyRewardDayClaimed >= 30 && dayToClaim === 1) { 
                             lastDailyRewardDayClaimed = dayToClaim;
                        } else {
                             lastDailyRewardDayClaimed = dayToClaim;
                        }
                        lastDailyRewardClaimTimestamp = Date.now();

                        const rewardInfo = rewardItem.reward;
                        if (rewardInfo.includes("PV")) currentPvTokens += parseInt(rewardInfo.match(/(\d+) PV/)[1]);
                        if (rewardInfo.includes("Gold")) currentGold += parseInt(rewardInfo.match(/(\d+) Gold/)[1]);
                        if (rewardInfo.includes("Diamond")) currentDiamonds += parseInt(rewardInfo.match(/(\d+) Diamond/)[1]);
                        
                        updateStatsDisplay();
                        renderDailyRewards(); 
                        showCustomPopup(`Claimed reward for Day ${dayToClaim}: ${rewardItem.reward}`, "Daily Reward Claimed");
                        if (currentUser.uid) saveGameStateToFirebase(currentUser.uid, getCurrentGameState());
                    });
                });
            }

            function renderShopItems() { 
                if (!shopItemsDiv) return; 
                shopItemsDiv.innerHTML = ''; 
                shopItemsData.forEach(item => { 
                    const ie = document.createElement('div'); 
                    ie.classList.add('shop-item'); 
                    let buyButtonDisabled = '';
                    let buyButtonText = 'Buy';
                    if (item.id === 'rider_scroll_unlock' && (playerHasPurchasedRiderScroll || playerInventory.some(invItem => invItem.id === 'rider_scroll_unlock'))) {
                        buyButtonDisabled = 'disabled title="You have already purchased this."';
                        buyButtonText = 'Owned';
                    }

                    let quantityInputHtml = '';
                    if (item.type === "upgrade_scroll_purchase") {
                        quantityInputHtml = `<input type="number" class="quantity-selector scroll-quantity-input" data-item-id="${item.id}" min="1" max="10" value="1">`;
                    }

                    ie.innerHTML = `
                        <div class="item-icon-placeholder">${getItemIconHTML(item.iconUrlOrColor, item.name)}</div>
                        <div>
                            <p><strong>${item.name}</strong></p>
                            <p><small>${item.description}</small></p>
                        </div>
                        <div class="shop-details" style="display:flex; align-items:center;">
                            ${quantityInputHtml}
                            <span class="shop-price" style="margin-right:10px;">${item.price} PV</span>
                            <button class="action-button buy-item-btn" data-item-id="${item.id}" data-price="${item.price}" ${buyButtonDisabled}>${buyButtonText}</button>
                        </div>`; 
                    shopItemsDiv.appendChild(ie); 
                     ie.addEventListener('mousemove', (e) => showItemTooltip(e, item));
                     ie.addEventListener('mouseleave', hideItemTooltip);
                }); 
                document.querySelectorAll('.buy-item-btn:not([disabled])').forEach(b => { b.addEventListener('click', (e) => { 
                    if(!currentUser) return; 
                    const itemId = e.target.dataset.itemId; 
                    const itemPrice = parseInt(e.target.dataset.price); 
                    const itemData = shopItemsData.find(it => it.id === itemId); 
                    if (!itemData) return; 

                    let quantity = 1;
                    if (itemData.type === "upgrade_scroll_purchase") {
                        const quantityInput = e.target.closest('.shop-details').querySelector(`.scroll-quantity-input[data-item-id="${itemId}"]`);
                        if (quantityInput) quantity = parseInt(quantityInput.value) || 1;
                    }
                    const totalCost = itemPrice * quantity;

                    if (currentPvTokens >= totalCost) { 
                        currentPvTokens -= totalCost; updateStatsDisplay(); 
                        showCustomPopup(`Successfully bought ${quantity}x ${itemData.name} for ${totalCost} PV.`, "Purchase Complete"); 
                        
                        if (itemData.type === "buff" && itemData.effect) { 
                            const existingPotion = activePotions.find(p => p.id === itemData.id && (p.endTime || p.adventuresLeft)); 
                            if (existingPotion) { 
                                showCustomPopup(`${itemData.name} is already active or you have one of its kind. Finish it first.`, "Potion Active"); 
                                currentPvTokens += totalCost; updateStatsDisplay(); return; 
                            } 
                            let newPotion = { id: itemData.id, name: itemData.name, description: itemData.description, effect: itemData.effect }; 
                            if (itemData.durationSeconds) { 
                                const originalHours = itemData.durationSeconds / 3600;
                                newPotion.endTime = Date.now() + (originalHours * GAME_HOUR_IN_REAL_SECONDS * 1000);
                            } else if (itemData.durationAdventures) { newPotion.adventuresLeft = itemData.durationAdventures; } 
                            activePotions.push(newPotion); 
                            renderActivePotions(); 
                            quests.forEach(q => { if (q.metric === `potionUsed_${itemData.id}` && !q.completed && !q.claimed) {q.progress = (q.progress || 0) + 1; if (q.progress >= q.target) { q.completed = true; showCustomPopup(`Quest Completed: ${q.text}`, "Quest Complete!");}} });
                            if(document.getElementById('quests-page').classList.contains('active')) renderQuests();
                        } else if (itemData.type === "upgrade_scroll_purchase" && itemData.scrollTypeKey) { 
                            playerScrolls[itemData.scrollTypeKey] = (playerScrolls[itemData.scrollTypeKey] || 0) + quantity;
                            renderMaterials(); 
                        } else if (itemData.type === "unlockable_consumable" && itemData.id === "rider_scroll_unlock") {
                             if (!playerHasPurchasedRiderScroll && !playerInventory.some(invItem => invItem.id === 'rider_scroll_unlock')) {
                                playerInventory.push({ id: "rider_scroll_unlock", uniqueInstanceId: `unlock_${nextUniqueInstanceId++}` });
                                playerHasPurchasedRiderScroll = true; 
                                renderInventory(); 
                                e.target.disabled = true; 
                                e.target.textContent = 'Owned';
                            }
                        }
                        if (currentUser.uid) saveGameStateToFirebase(currentUser.uid, getCurrentGameState()); 
                    } else { 
                        showCustomPopup(`Not enough PV Tokens to buy ${quantity}x ${itemData.name}! You need ${totalCost} PV.`, "Transaction Failed"); 
                    } 
                }); }); 
            }
            
             function craftItem(itemId, fromPopup = false, originalSlotIdIfEquipped = null) { 
                if(!currentUser) return false; 
                const itemToCraft = craftableItemsData.find(i => i.id === itemId); 
                if (!itemToCraft) return false; 
                
                const alreadyOwned = playerInventory.some(invItem => invItem.id === itemToCraft.id) || 
                                   Object.values(equippedItems).some(equippedInstanceId => {
                                       const eqItem = playerInventory.find(pi => pi.uniqueInstanceId === equippedInstanceId);
                                       return eqItem && eqItem.id === itemToCraft.id;
                                   });

                if (alreadyOwned && !fromPopup) { 
                    showCustomPopup(`You already own an instance of ${itemToCraft.name}. You cannot craft another unless the existing one is destroyed.`, "Crafting Failed"); 
                    return false; 
                } 
                
                let canCraft = true; 
                let missingMatDetails = ""; 
                for (const mat in itemToCraft.recipe) { 
                    if ((playerMaterials[mat] || 0) < itemToCraft.recipe[mat]) { 
                        canCraft = false; 
                        missingMatDetails += `${itemToCraft.recipe[mat]} ${mat}, `;
                    } 
                } 
                if (canCraft) { 
                    for (const mat in itemToCraft.recipe) { playerMaterials[mat] -= itemToCraft.recipe[mat]; } 
                    const newItemInstanceId = `item_${nextUniqueInstanceId++}`;
                    playerInventory.push({ id: itemToCraft.id, level: 0, uniqueInstanceId: newItemInstanceId }); 
                    
                    if (fromPopup && originalSlotIdIfEquipped) {
                        equipItem(newItemInstanceId, originalSlotIdIfEquipped); 
                        showCustomPopup(`Successfully re-crafted and equipped ${itemToCraft.name}!`, "Item Crafted & Equipped"); 
                    } else {
                        showCustomPopup(`Successfully crafted ${itemToCraft.name}!`, "Item Crafted"); 
                    }
                    
                    quests.forEach(q => { if (q.metric === "itemsCrafted" && !q.completed && !q.claimed) {q.progress = (q.progress || 0) + 1; if (q.progress >= q.target) { q.completed = true; showCustomPopup(`Quest Completed: ${q.text}`, "Quest Complete!");}} });
                    if(document.getElementById('quests-page').classList.contains('active')) renderQuests();

                    renderMaterials(); renderInventory(); renderCraftingItems(); 
                    if (currentUser.uid) saveGameStateToFirebase(currentUser.uid, getCurrentGameState());
                    return true;
                } else { 
                    missingMatDetails = missingMatDetails.slice(0, -2); 
                    showCustomPopup(`Not enough materials! You need: ${missingMatDetails} to craft ${itemToCraft.name}.`, "Crafting Failed"); 
                    return false;
                } 
            }

            function promptToCraftAgain(destroyedItemMaster, originalSlotId) {
                if (!destroyedItemMaster || !destroyedItemMaster.recipe) return;

                let recipeHtml = "<ul>";
                for (const mat in destroyedItemMaster.recipe) {
                    recipeHtml += `<li>${destroyedItemMaster.recipe[mat]} ${mat} (You have: ${playerMaterials[mat] || 0})</li>`;
                }
                recipeHtml += "</ul>";

                const message = `Your ${destroyedItemMaster.name} was destroyed!<br><br>Would you like to craft it again?<br><br><strong>Requires:</strong>${recipeHtml}`;
                
                showCustomPopup(message, "Craft Item Again?", { craftCallback: () => {
                    craftItem(destroyedItemMaster.id, true, originalSlotId); 
                }});
            }

            function equipItem(itemUniqueId, specificSlotId = null) { 
                if(!currentUser) return; 
                const invItemToEquip = playerInventory.find(invItem => invItem.uniqueInstanceId === itemUniqueId);
                if (!invItemToEquip) { console.error("Item to equip not found in inventory:", itemUniqueId); return;}

                const itemData = craftableItemsData.find(i => i.id === invItemToEquip.id) || (invItemToEquip.id === "ring_cursedpower" ? craftableItemsData.find(i => i.id === "ring_cursedpower") : null) ; 
                if (!itemData || !itemData.type) { console.error("Cannot equip item without a type:", itemData); return; } 
                
                let targetSlotId = specificSlotId; 

                if (!targetSlotId) { 
                    if (itemData.type === "Ring") { 
                        if (!equippedItems.Ring1) targetSlotId = "Ring1"; 
                        else if (secondRingSlotUnlocked && !equippedItems.Ring2) targetSlotId = "Ring2"; 
                        else showCustomPopup("Both ring slots are full or second slot is locked/unavailable.", "Equip Failed"); 
                    } else if (itemData.type === "Trinket" || itemData.type === "Rucksack") { 
                        if (!equippedItems.Misc1) targetSlotId = "Misc1"; 
                        else if (!equippedItems.Misc2) targetSlotId = "Misc2"; 
                        else showCustomPopup("Both miscellaneous slots are full.", "Equip Failed"); 
                    } else if (equippedItems.hasOwnProperty(itemData.type)) { 
                        targetSlotId = itemData.type; 
                    } 
                }
                
                if (targetSlotId) { 
                    if (equippedItems[targetSlotId] && equippedItems[targetSlotId] !== invItemToEquip.uniqueInstanceId) {
                        // An item is already in the target slot, it remains in inventory.
                    }
                    equippedItems[targetSlotId] = invItemToEquip.uniqueInstanceId; 
                    renderInventory(); 
                    console.log("Equipped:", equippedItems); 
                    if (currentUser.uid) saveGameStateToFirebase(currentUser.uid, getCurrentGameState()); 
                } else if (!specificSlotId && !equippedItems.hasOwnProperty(itemData.type) && itemData.type !== "Ring" && itemData.type !== "Trinket" && itemData.type !== "Rucksack") { 
                    showCustomPopup(`No available slot for item type: ${itemData.type}`, "Equip Failed"); 
                }
            }

            function unequipItem(itemSlotId) { 
                if(!currentUser) return; 
                if (equippedItems.hasOwnProperty(itemSlotId) && equippedItems[itemSlotId]) { 
                    equippedItems[itemSlotId] = null; 
                    renderInventory(); 
                    console.log("Equipped:", equippedItems); 
                    if (currentUser.uid) saveGameStateToFirebase(currentUser.uid, getCurrentGameState());
                } 
            }
            
            function generateRandomQuests() { /* Using predefined quests */ }
            
            function completeAdventure(instanceId) { 
                if(!currentUser) return; 
                const advIdx = activeAdventures.findIndex(adv => adv.id === instanceId); 
                if (advIdx === -1) return; 
                const completedAdv = activeAdventures[advIdx]; 
                let basePvReward = completedAdv.pvReward; 
                let pvMultiplierFromPotions = 1; 
                let pvBonusAdditiveEffect = 0; 
                
                activePotions.forEach(p => { 
                    if(p.effect && p.effect.type === "pvMultiplier" && p.adventuresLeft > 0) { 
                        pvMultiplierFromPotions *= p.effect.value; 
                    }
                });
                
                Object.values(equippedItems).forEach(equippedInstanceId => {
                    if (!equippedInstanceId) return;
                    const invItem = playerInventory.find(i => i.uniqueInstanceId === equippedInstanceId);
                    if (invItem) {
                        const itemMaster = craftableItemsData.find(im => im.id === invItem.id);
                        if (itemMaster && itemMaster.perk) {
                            const scaledPerk = getScaledItemPerk(itemMaster, invItem.level || 0);
                            if (scaledPerk && scaledPerk.type === "pvBonus") {
                                pvBonusAdditiveEffect += scaledPerk.value; 
                            }
                        }
                    }
                });

                let earnedPvThisTrip = Math.floor(basePvReward * completedAdv.adventurers * (1 + pvBonusAdditiveEffect) * pvMultiplierFromPotions); 
                currentPvTokens += earnedPvThisTrip; 
                
                let totalGoldChanceIncreaseBonus = 0;
                let flatGoldBonusFromPotions = 0; 
                let flatGoldBonusFromItems = 0;
                let flatDiamondBonusFromItems = 0;
                let materialChanceEffectiveMultiplier = 1; 

                activePotions.forEach(p => { 
                    if(p.effect && p.effect.type === "goldChanceBonus" && p.adventuresLeft > 0) { 
                        flatGoldBonusFromPotions += p.effect.flatValue || 0; 
                    }
                });

                Object.values(equippedItems).forEach(equippedInstanceId => {
                     if (!equippedInstanceId) return;
                    const invItem = playerInventory.find(i => i.uniqueInstanceId === equippedInstanceId);
                    if(invItem) {
                        const itemMaster = craftableItemsData.find(im => im.id === invItem.id);
                        if (itemMaster && itemMaster.perk) {
                             const scaledPerk = getScaledItemPerk(itemMaster, invItem.level || 0);
                             if (scaledPerk) {
                                if (scaledPerk.type === "goldChanceIncrease") totalGoldChanceIncreaseBonus += scaledPerk.value;
                                if (scaledPerk.type === "flatCurrencyChanceBoost") {
                                    flatGoldBonusFromItems += (scaledPerk.goldBonus || 0);
                                    flatDiamondBonusFromItems += (scaledPerk.diamondBonus || 0);
                                }
                                if (scaledPerk.type === "materialChanceMultiplier") {
                                    materialChanceEffectiveMultiplier *= scaledPerk.value;
                                }
                             }
                        }
                    }
                });
                
                let totalGoldFoundThisTrip = 0; 
                let totalDiamondsFoundThisTrip = 0; 
                
                let allFoundDrops = {}; 
                for (let i = 0; i < completedAdv.adventurers; i++) { 
                    const finalGoldChance = (completedAdv.goldChance * (1 + totalGoldChanceIncreaseBonus)) + flatGoldBonusFromPotions + flatGoldBonusFromItems; 
                    if (completedAdv.goldChance > 0 && Math.random() < finalGoldChance) { currentGold += 1; totalGoldFoundThisTrip++; } 
                    
                    const finalDiamondChance = completedAdv.diamondChance + flatDiamondBonusFromItems;
                    if (completedAdv.diamondChance > 0 && Math.random() < finalDiamondChance) { currentDiamonds += 1; totalDiamondsFoundThisTrip++; } 
                    
                    const adventureBaseData = adventuresData[completedAdv.originalAdventureId]; 
                    if (adventureBaseData && adventureBaseData.drops) { 
                        adventureBaseData.drops.forEach(drop => { 
                            if (Math.random() < (drop.chance * materialChanceEffectiveMultiplier)) { 
                                if (drop.name === "ring_cursedpower") { 
                                    const cursedRingExists = playerInventory.some(invItem => invItem.id === "ring_cursedpower") || 
                                                        Object.values(equippedItems).some(eqId => {
                                                            const eqInvItem = playerInventory.find(pi => pi.uniqueInstanceId === eqId);
                                                            return eqInvItem && eqInvItem.id === "ring_cursedpower";
                                                        });
                                    if (!cursedRingExists) {
                                        playerInventory.push({id: "ring_cursedpower", level: 0, uniqueInstanceId: `item_${nextUniqueInstanceId++}`}); 
                                        allFoundDrops[drop.name] = (allFoundDrops[drop.name] || 0) + (drop.qty || 1); 
                                    }
                                } else if (materialTiers[1].includes(drop.name) || materialTiers[2].includes(drop.name) || materialTiers[3].includes(drop.name) || materialTiers[4].includes(drop.name)) {
                                    playerMaterials[drop.name] = (playerMaterials[drop.name] || 0) + (drop.qty || 1); 
                                    allFoundDrops[drop.name] = (allFoundDrops[drop.name] || 0) + (drop.qty || 1); 
                                    quests.forEach(q => { if (q.metric === `materialCollected_${drop.name}` && !q.completed && !q.claimed) {q.progress = (q.progress || 0) + (drop.qty || 1); if (q.progress >= q.target) { q.completed = true; if (!q.claimed) showCustomPopup(`Quest Completed: ${q.text}`, "Quest Complete!");}} });
                                }
                            } 
                        }); 
                    } 
                } 
                totalAdventuresCompleted++;
                
                activePotions.forEach(p => { 
                    if(p.adventuresLeft !== undefined && p.adventuresLeft > 0) { 
                        if ( (p.effect.type === "pvMultiplier" && pvMultiplierFromPotions > 1) || 
                             (p.effect.type === "goldChanceBonus" && flatGoldBonusFromPotions > 0) ) {
                            p.adventuresLeft--; 
                        }
                    }
                }); 
                activePotions = activePotions.filter(p => (p.endTime && Date.now() < p.endTime) || (p.adventuresLeft !== undefined && p.adventuresLeft > 0) ); 
                renderActivePotions(); 
                
                let popupMessage = `${completedAdv.adventurers} adventurer(s) returned from ${completedAdv.name}!\n\nRewards:\n- ${earnedPvThisTrip} PV Tokens`; 
                if(totalGoldFoundThisTrip > 0) { popupMessage += `\n- ${totalGoldFoundThisTrip} Gold`; } 
                if(totalDiamondsFoundThisTrip > 0) { popupMessage += `\n- ${totalDiamondsFoundThisTrip} Diamond(s)`;} 
                const foundDropNames = Object.keys(allFoundDrops); 
                if (foundDropNames.length > 0) { popupMessage += `\n\nMaterials Found:`; foundDropNames.forEach(dropName => { const dItem = craftableItemsData.find(cd => cd.id === dropName); popupMessage += `\n  - ${allFoundDrops[dropName]}x ${dItem ? dItem.name : dropName}`; }); renderMaterials(); if (foundDropNames.includes("ring_cursedpower")) renderInventory(); } 
                
                if (totalAdventuresCompleted > 0 && totalAdventuresCompleted % 100 === 0) {
                    currentGold += 50;
                    currentDiamonds += 1;
                    popupMessage += `\n\n**Milestone!** 100 Adventures Completed! +50 Gold, +1 Diamond!`;
                }

                totalAvailableAdventurers += completedAdv.adventurers; 
                showCustomPopup(popupMessage, "Adventure Complete!"); 
                activeAdventures.splice(advIdx, 1); 
                updateAdventureDisplayStates(); 
                
                quests.forEach(quest => { 
                    if (!quest.completed && !quest.claimed) { 
                        let progressChanged = false;
                        if (quest.adventureName === completedAdv.name) { quest.progress = (quest.progress || 0) + completedAdv.adventurers; progressChanged = true; }
                        if (quest.metric === "pvCollected") { quest.progress = Math.min(quest.target, (quest.progress || 0) + earnedPvThisTrip); progressChanged = true; }
                        if (quest.metric === "goldCollected") { quest.progress = Math.min(quest.target, (quest.progress || 0) + totalGoldFoundThisTrip); progressChanged = true; }
                        if (quest.metric === "adventurersSentOnQuests") { quest.progress = (quest.progress || 0) + completedAdv.adventurers; progressChanged = true; }
                        if (quest.metric === "pvBalance") { quest.progress = currentPvTokens; progressChanged = true; }
                        if (quest.metric === "totalAdventuresCompletedOverall") { quest.progress = totalAdventuresCompleted; progressChanged = true; }
                        if (quest.metric === "goldFoundAdventures") { quest.progress = (quest.progress || 0) + totalGoldFoundThisTrip; progressChanged = true; }
                        if (quest.metric === "equippedTier1Set") {
                            const bootsEquipped = Object.values(equippedItems).some(id => playerInventory.find(i => i.uniqueInstanceId === id && i.id === "boots1"));
                            const rucksackEquipped = Object.values(equippedItems).some(id => playerInventory.find(i => i.uniqueInstanceId === id && i.id === "rucksack1"));
                            quest.progress = (bootsEquipped ? 1 : 0) + (rucksackEquipped ? 1 : 0);
                            progressChanged = true;
                        }
                        if (quest.metric === "attackPower"){
                            let currentAttack = 0; 
                            Object.values(equippedItems).forEach(eqId => { if(!eqId) return; const invI = playerInventory.find(i=>i.uniqueInstanceId === eqId); if(invI) { const mI = craftableItemsData.find(mi => mi.id === invI.id); if (mI && mI.perk) { const scaledPerk = getScaledItemPerk(mI, invI.level || 0); if(scaledPerk.type === "attackBoost") currentAttack += scaledPerk.value; if(scaledPerk.type === "statBoost" && scaledPerk.attack) currentAttack += scaledPerk.attack; } }});
                            quest.progress = currentAttack;
                            progressChanged = true;
                        }


                        if (progressChanged && quest.progress >= quest.target && !quest.completed) { 
                            quest.completed = true; 
                            if(!quest.claimed) showCustomPopup(`Quest Completed: ${quest.text}`, "Quest Complete!"); 
                            if ([1,2,3].includes(quest.id)) { updateAdventureDisplayStates(); } 
                        } 
                    } 
                }); 

                if(document.getElementById('quests-page').classList.contains('active')) { renderQuests(); } 
                updateStatsDisplay(); 
                renderActiveAdventuresInSidebar(); 
                if (currentUser.uid) saveGameStateToFirebase(currentUser.uid, getCurrentGameState());
            }
            
            function updateAdventureDisplayStates() {
                adventureProgressionConfig.forEach(advConfig => {
                    const adventureBlock = document.getElementById(advConfig.blockId);
                    if (!adventureBlock) return;

                    const sendBtnElement = adventureBlock.querySelector('.adventure-send-btn');
                    const numSelect = adventureBlock.querySelector('.adventure-num-select');
                    const lockOverlay = adventureBlock.querySelector('.adventure-lock-overlay');

                    let isLockedByProgression = false;
                    if (advConfig.unlockQuestId) {
                        const unlockingQuest = quests.find(q => q.id === advConfig.unlockQuestId);
                        if (!unlockingQuest || !unlockingQuest.completed) {
                            isLockedByProgression = true;
                        }
                    }
                    const existingActiveAdventure = activeAdventures.find(adv => adv.originalAdventureId === advConfig.id);
                    
                    if (sendBtnElement) {
                        if (existingActiveAdventure) {
                            sendBtnElement.textContent = "ADD MORE (+)";
                            sendBtnElement.disabled = totalAvailableAdventurers <= 0; // Can add if player has adventurers
                        } else {
                            sendBtnElement.textContent = "SEND";
                            sendBtnElement.disabled = isLockedByProgression;
                        }
                    }
                    if (numSelect) {
                        numSelect.disabled = isLockedByProgression && !existingActiveAdventure; // Keep enabled if adding more
                    }
                    
                    adventureBlock.classList.toggle('locked-by-progression', isLockedByProgression && !existingActiveAdventure);

                    if (lockOverlay) {
                        if (isLockedByProgression && !existingActiveAdventure) {
                            lockOverlay.textContent = advConfig.unlockMessage;
                            lockOverlay.classList.remove('hidden');
                        } else {
                            lockOverlay.classList.add('hidden');
                        }
                    }
                });
            }
            
            function handleCancelAdventure(adventureInstanceId) {
                if (!currentUser) return;
                const adventureToCancel = activeAdventures.find(adv => adv.id === adventureInstanceId);
                if (!adventureToCancel) return;

                showCustomPopup(
                    `Are you sure you want to cancel the adventure "${adventureToCancel.name}"? Your ${adventureToCancel.adventurers} adventurer(s) will return immediately, but you will receive no rewards.`,
                    "Confirm Cancel Adventure",
                    { 
                        confirmCallback: (confirmed) => {
                            if (confirmed) {
                                totalAvailableAdventurers += adventureToCancel.adventurers;
                                activeAdventures = activeAdventures.filter(adv => adv.id !== adventureInstanceId);
                                
                                showCustomPopup(`Adventure "${adventureToCancel.name}" has been cancelled. Adventurers have returned.`, "Adventure Cancelled");
                                updateStatsDisplay();
                                renderActiveAdventuresInSidebar();
                                updateAdventureDisplayStates();
                                if (currentUser.uid) saveGameStateToFirebase(currentUser.uid, getCurrentGameState());
                            }
                        }
                    }
                );
            }


            function updateTimers() { 
                let adventureCompletedThisTick = false; 
                activeAdventures.forEach(adv => { 
                    const timeLeftMs = adv.returnTime - Date.now(); 
                    document.querySelectorAll(`.active-adventure-item[data-instance-id="${adv.id}"] .timer`).forEach(timerSpan => { 
                        if(timerSpan) timerSpan.textContent = formatTimeLeft(timeLeftMs); 
                    }); 
                    if (timeLeftMs <= 0) { 
                        completeAdventure(adv.id); 
                        adventureCompletedThisTick = true; 
                    } 
                }); 
                if (adventureCompletedThisTick && activeAdventures.length === 0 && sidebarActiveAdventuresList) { 
                    renderActiveAdventuresInSidebar(); 
                } 
                
                let potionsChanged = false; 
                const now = Date.now(); 
                activePotions.forEach(potion => { 
                    if (potion.endTime) { 
                        if (now >= potion.endTime) potionsChanged = true; 
                        const potionItemDiv = Array.from(activePotionsList.children).find(child => child.innerHTML.includes(`<strong>${potion.name}</strong>`)); 
                        if (potionItemDiv) { 
                            const timerSpan = potionItemDiv.querySelector('.timer'); 
                            if (timerSpan) timerSpan.textContent = formatTimeLeft(potion.endTime - now); 
                        } 
                    } 
                }); 
                if (potionsChanged) { 
                    activePotions = activePotions.filter(p => p.endTime ? p.endTime > now : true); 
                    renderActivePotions(); 
                }
                
                let rafflesUpdatedByTimer = false;
                allRaffles.forEach(raffle => {
                    if (raffle.status === 'active') {
                        const timeLeftMs = raffle.endTime - Date.now();
                        const timerSpan = document.querySelector(`.raffle-card[data-raffle-id="${raffle.id}"] .raffle-timer`);
                        if (timerSpan) {
                            timerSpan.textContent = formatTimeLeft(timeLeftMs);
                        }
                        if (timeLeftMs <= 0) {
                            raffle.status = 'ended'; 
                            rafflesUpdatedByTimer = true; 
                        }
                    }
                });
                if (rafflesUpdatedByTimer && document.getElementById('whitelist-page').classList.contains('active')) {
                    renderWhitelistRaffles();
                }
            }
            
            adventureSendButtons.forEach(button => { 
                button.addEventListener('click', () => { 
                    if(!currentUser) return;
                    const adventureIdBase = button.dataset.adventureId; 
                    const adventureName = button.dataset.adventureName; 
                    const originalDurationHours = parseInt(button.dataset.durationHours); 
                    const pvReward = parseInt(button.dataset.pvReward); 
                    const goldChance = parseFloat(button.dataset.goldChance); 
                    const diamondChance = parseFloat(button.dataset.diamondChance) || 0; 
                    const selectElement = document.getElementById(`num-adventurers-${adventureIdBase}`); 
                    const numAdventurersToSend = parseInt(selectElement.value); 

                    if (numAdventurersToSend <= 0) { showCustomPopup("Please select at least one adventurer.", "Action Needed"); return; } 
                    if (numAdventurersToSend > totalAvailableAdventurers) { showCustomPopup(`Not enough adventurers available! You only have ${totalAvailableAdventurers}.`, "Adventurers Needed"); return; } 
                    
                    const existingActiveAdventureIndex = activeAdventures.findIndex(adv => adv.originalAdventureId === adventureIdBase);

                    if (existingActiveAdventureIndex !== -1) { // Adding to existing adventure
                        showCustomPopup(
                            `Adding ${numAdventurersToSend} adventurer(s) to "${adventureName}" will reset its timer to the full ${originalDurationHours} hours. Continue?`,
                            "Confirm Add Adventurers",
                            {
                                confirmCallback: (confirmed) => {
                                    if (confirmed) {
                                        totalAvailableAdventurers -= numAdventurersToSend;
                                        const advInstance = activeAdventures[existingActiveAdventureIndex];
                                        advInstance.adventurers += numAdventurersToSend;
                                        
                                        let calculatedDurationMs = originalDurationHours * GAME_HOUR_IN_REAL_SECONDS * 1000;
                                        Object.values(equippedItems).forEach(equippedInstanceId => {
                                            if (!equippedInstanceId) return;
                                            const invItem = playerInventory.find(i => i.uniqueInstanceId === equippedInstanceId);
                                            if(invItem) {
                                                const itemMaster = craftableItemsData.find(im => im.id === invItem.id);
                                                if (itemMaster && itemMaster.perk) {
                                                    const scaledPerk = getScaledItemPerk(itemMaster, invItem.level || 0);
                                                    if (scaledPerk.type === "timeReduction") {
                                                        const reductionInAcceleratedSeconds = scaledPerk.value / 3600 * GAME_HOUR_IN_REAL_SECONDS;
                                                        calculatedDurationMs = Math.max(1000, calculatedDurationMs - (reductionInAcceleratedSeconds * 1000));
                                                    }
                                                }
                                            }
                                        });
                                        advInstance.returnTime = Date.now() + calculatedDurationMs;

                                        updateStatsDisplay(); 
                                        renderActiveAdventuresInSidebar(); 
                                        updateAdventureDisplayStates(); 
                                        if (currentUser.uid) saveGameStateToFirebase(currentUser.uid, getCurrentGameState());
                                        showCustomPopup(`${numAdventurersToSend} adventurer(s) added to "${adventureName}". Timer reset.`, "Adventurers Added");
                                    }
                                }
                            }
                        );
                    } else { // Starting a new adventure
                        const advConfig = adventureProgressionConfig.find(ac => ac.id === adventureIdBase);
                        if (advConfig && advConfig.unlockQuestId) {
                            const unlockingQuest = quests.find(q => q.id === advConfig.unlockQuestId);
                            if (!unlockingQuest || !unlockingQuest.completed) {
                                showCustomPopup(advConfig.unlockMessage, "Adventure Locked");
                                return;
                            }
                        }
                        totalAvailableAdventurers -= numAdventurersToSend; 
                        let calculatedDurationMs = originalDurationHours * GAME_HOUR_IN_REAL_SECONDS * 1000; 
                        Object.values(equippedItems).forEach(equippedInstanceId => { 
                            if (!equippedInstanceId) return;
                            const invItem = playerInventory.find(i => i.uniqueInstanceId === equippedInstanceId);
                            if(invItem) {
                                const itemMaster = craftableItemsData.find(im => im.id === invItem.id);
                                 if (itemMaster && itemMaster.perk) {
                                    const scaledPerk = getScaledItemPerk(itemMaster, invItem.level || 0);
                                    if (scaledPerk.type === "timeReduction") {
                                        const reductionInAcceleratedSeconds = scaledPerk.value / 3600 * GAME_HOUR_IN_REAL_SECONDS;
                                        calculatedDurationMs = Math.max(1000, calculatedDurationMs - (reductionInAcceleratedSeconds * 1000));
                                    }
                                }
                            }
                        });
                        
                        const returnTime = Date.now() + calculatedDurationMs; 
                        const newActiveAdventure = { id: nextActiveAdventureId++, originalAdventureId: adventureIdBase, name: adventureName, adventurers: numAdventurersToSend, returnTime: returnTime, pvReward: pvReward, goldChance: goldChance, diamondChance: diamondChance }; 
                        activeAdventures.push(newActiveAdventure); 
                        updateStatsDisplay(); 
                        renderActiveAdventuresInSidebar(); 
                        updateAdventureDisplayStates(); 
                        if (currentUser.uid) saveGameStateToFirebase(currentUser.uid, getCurrentGameState());
                    }
                }); 
            });
            adventureDropButtons.forEach(button => { button.addEventListener('mouseenter', (event) => { const adventureId = event.target.dataset.adventureId; const popover = document.getElementById(`drops-popover-${adventureId}`); const adventureInfo = adventuresData[adventureId]; if (popover && adventureInfo && adventureInfo.drops) { let dropsHtml = '<h5>Possible Drops:</h5><ul>'; adventureInfo.drops.forEach(drop => { const dItem = craftableItemsData.find(cd => cd.id === drop.name); dropsHtml += `<li>${drop.qty}x ${dItem ? dItem.name : drop.name} (${(drop.chance * 100).toFixed(3)}%)</li>`; }); dropsHtml += '</ul>'; popover.innerHTML = dropsHtml; popover.style.display = 'block'; } }); button.addEventListener('mouseleave', (event) => { const adventureId = event.target.dataset.adventureId; const popover = document.getElementById(`drops-popover-${adventureId}`); if (popover) { popover.style.display = 'none'; } }); });
            
            // --- Currency Swap Logic ---
            function updateSwapDisplay() {
                if (!swapInfoDisplay || !swapBtn || !reverseSwapDirectionBtn) return;
                if (isGoldToDiamondSwap) {
                    swapInfoDisplay.innerHTML = `100 <span class="gold">GOLD</span> = 1 <span class="diamond">DIAMOND</span>`;
                    swapBtn.textContent = "Swap Gold for Diamond";
                } else {
                    swapInfoDisplay.innerHTML = `1 <span class="diamond">DIAMOND</span> = 100 <span class="gold">GOLD</span>`;
                    swapBtn.textContent = "Swap Diamond for Gold";
                }
            }

            if (reverseSwapDirectionBtn) {
                reverseSwapDirectionBtn.addEventListener('click', () => {
                    isGoldToDiamondSwap = !isGoldToDiamondSwap;
                    updateSwapDisplay();
                });
            }

            if (swapBtn) {
                swapBtn.addEventListener('click', () => {
                    if (!currentUser) return;
                    let costGold = 0, rewardDiamond = 0, costDiamond = 0, rewardGold = 0;
                    let message = "";

                    if (isGoldToDiamondSwap) {
                        costGold = 100;
                        rewardDiamond = 1;
                        if (currentGold >= costGold) {
                            currentGold -= costGold;
                            currentDiamonds += rewardDiamond;
                            message = `Swapped ${costGold} Gold for ${rewardDiamond} Diamond!`;
                        } else {
                            showCustomPopup(`Not enough Gold! You need ${costGold} Gold.`, "Swap Failed");
                            return;
                        }
                    } else { // Diamond to Gold
                        costDiamond = 1;
                        rewardGold = 100;
                        if (currentDiamonds >= costDiamond) {
                            currentDiamonds -= costDiamond;
                            currentGold += rewardGold;
                            message = `Swapped ${costDiamond} Diamond for ${rewardGold} Gold!`;
                        } else {
                            showCustomPopup(`Not enough Diamonds! You need ${costDiamond} Diamond.`, "Swap Failed");
                            return;
                        }
                    }
                    updateStatsDisplay();
                    showCustomPopup(message, "Swap Successful");
                    if (currentUser.uid) saveGameStateToFirebase(currentUser.uid, getCurrentGameState());
                });
            }
            updateSwapDisplay(); // Initialize display on load


            // --- Whitelist Raffle Logic ---
            async function fetchAndDisplayRaffles() {
                if (!db) { console.error("Firestore not initialized for fetching raffles."); allRaffles = []; renderWhitelistRaffles(); return; }
                const rafflesCol = collection(db, "raffles");
                const q_raffles = query(rafflesCol, where("status", "in", ["active", "ended", "drawing_winners", "winners_announced"]), orderBy("endTime", "desc"));
                try {
                    const querySnapshot = await getDocs(q_raffles); const fetchedRaffles = [];
                    for (const docSnap of querySnapshot.docs) { 
                        const raffleData = docSnap.data();
                        fetchedRaffles.push({ id: docSnap.id, ...raffleData, startTime: raffleData.startTime.toDate().getTime(), endTime: raffleData.endTime.toDate().getTime() });
                    }
                    allRaffles = fetchedRaffles; renderWhitelistRaffles(); console.log("Fetched raffles from Firestore:", allRaffles);
                } catch (error) { console.error("Error fetching raffles: ", error); showCustomPopup("Could not load raffles. Check console (missing index or rules?).", "Raffle Error"); allRaffles = []; renderWhitelistRaffles(); }
            }
            if (createRaffleForm) { createRaffleForm.addEventListener('submit', async (e) => {  e.preventDefault(); if (!db || !currentUser || (currentUser.email && currentUser.email.toLowerCase() !== 'nvoiysol@gmail.com')) { showCustomPopup("Admin action failed.", "Admin Error"); return; } const name = document.getElementById('raffleName').value; const description = document.getElementById('raffleDescription').value; const imageUrl = document.getElementById('raffleImageUrl').value || ''; const socialX = document.getElementById('raffleSocialX').value; const socialDiscord = document.getElementById('raffleSocialDiscord').value; const costPV = parseInt(document.getElementById('raffleCostPV').value) || 0; const costGold = parseInt(document.getElementById('raffleCostGold').value) || 0; const costDiamonds = parseInt(document.getElementById('raffleCostDiamonds').value) || 0; const durationHours = parseInt(document.getElementById('raffleDurationHours').value) || 24; const maxWinners = parseInt(document.getElementById('raffleMaxWinners').value) || 1; const nowMs = Date.now(); const startTime = Timestamp.fromDate(new Date(nowMs)); const endTime = Timestamp.fromDate(new Date(nowMs + durationHours * GAME_HOUR_IN_REAL_SECONDS * 1000)); const newRaffleData = { name, description, imageUrl, socials: { x: socialX, discord: socialDiscord }, entryCost: { pv: costPV, gold: costGold, diamonds: costDiamonds }, durationHours, maxWinners, startTime, endTime, status: 'active', createdByEmail: currentUser.email, createdAt: Timestamp.now(), winners: [], entryCount: 0 }; try { const newRaffleRef = await addDoc(collection(db, "raffles"), newRaffleData); showCustomPopup(`Raffle "${name}" created!`, "Admin Action"); createRaffleForm.reset(); await fetchAndDisplayRaffles(); } catch (error) { console.error("Error creating raffle: ", error); showCustomPopup("Failed to create raffle.", "Admin Error"); } }); }
            async function renderWhitelistRaffles() {  if (!whitelistRafflesContainer) return; whitelistRafflesContainer.innerHTML = ''; if (allRaffles.length === 0) { whitelistRafflesContainer.innerHTML = '<p style="text-align:center;">No active raffles.</p>'; return; } allRaffles.sort((a, b) => b.startTime - a.startTime);  for (const raffle of allRaffles) {  const card = document.createElement('div'); card.className = 'raffle-card'; card.dataset.raffleId = raffle.id; const timeLeftMs = raffle.endTime - Date.now(); let costHtml = ''; if (raffle.entryCost.pv > 0) costHtml += `${raffle.entryCost.pv} <span class="pv">PV</span> `; if (raffle.entryCost.gold > 0) costHtml += `${raffle.entryCost.gold} <span class="gold">GOLD</span> `; if (raffle.entryCost.diamonds > 0) costHtml += `${raffle.entryCost.diamonds} <span class="diamond">DIAMONDS</span>`; if (costHtml === '') costHtml = 'Free Entry'; else costHtml = 'Cost: ' + costHtml; const alreadyEntered = currentUser && playerRaffleEntries && playerRaffleEntries[raffle.id];  let adminActionsHtml = ''; if (currentUser && currentUser.email && currentUser.email.toLowerCase() === 'nvoiysol@gmail.com') { adminActionsHtml += `<button class="action-button raffle-action-btn delete-raffle-btn" data-raffle-id="${raffle.id}">Delete</button>`; if (raffle.status === 'active' && timeLeftMs > 0) { adminActionsHtml += `<button class="action-button raffle-action-btn draw-now-btn" data-raffle-id="${raffle.id}">Draw Now</button>`; } else if ((raffle.status === 'ended' || (raffle.status === 'active' && timeLeftMs <=0) ) && (!raffle.winners || raffle.winners.length === 0)) { adminActionsHtml += `<button class="action-button raffle-action-btn draw-winners-btn" data-raffle-id="${raffle.id}">Draw Winners</button>`; } } card.innerHTML = ` <div class="raffle-card-image ${raffle.imageUrl ? '' : 'placeholder'}" style="${raffle.imageUrl ? 'background-image: url('+raffle.imageUrl+');' : ''}"> ${!raffle.imageUrl ? 'No Image' : ''} </div> <div class="raffle-card-content"> <h4>${raffle.name}</h4> <p class="raffle-card-description">${raffle.description}</p> <div class="raffle-card-socials"> ${raffle.socials.x ? `<a href="${raffle.socials.x}" target="_blank">Project X</a>` : ''} ${raffle.socials.discord ? `<a href="${raffle.socials.discord}" target="_blank">Project Discord</a>` : ''} </div> <p class="raffle-card-cost">${costHtml}</p> <p class="raffle-card-status">Status: ${raffle.status.replace('_', ' ')}</p> <p>Time Left: <span class="raffle-timer">${timeLeftMs > 0 ? formatTimeLeft(timeLeftMs) : 'Ended'}</span></p> <p>Entries: ${raffle.entryCount || 0}</p> ${currentUser && raffle.status === 'active' && timeLeftMs > 0 && !alreadyEntered ? `<button class="action-button enter-raffle-btn raffle-action-btn" data-raffle-id="${raffle.id}">Enter Raffle</button>` : ''} ${alreadyEntered ? '<p><strong>You have entered this raffle!</strong></p>' : ''} <div class="raffle-admin-actions">${adminActionsHtml}</div> ${raffle.winners && raffle.winners.length > 0 ? `<div><strong>Winners (${raffle.winners.length}/${raffle.maxWinners}):</strong><ul>${raffle.winners.map(w => `<li>${w}</li>`).join('')}</ul></div>` : ''} </div> `; whitelistRafflesContainer.appendChild(card); } whitelistRafflesContainer.querySelectorAll('.enter-raffle-btn').forEach(btn => btn.addEventListener('click', handleEnterRaffle)); whitelistRafflesContainer.querySelectorAll('.draw-winners-btn').forEach(btn => btn.addEventListener('click', handleDrawWinners)); whitelistRafflesContainer.querySelectorAll('.draw-now-btn').forEach(btn => btn.addEventListener('click', handleDrawNow)); whitelistRafflesContainer.querySelectorAll('.delete-raffle-btn').forEach(btn => btn.addEventListener('click', handleDeleteRaffle)); }
            async function handleEnterRaffle(event) {  if (!currentUser) { showCustomPopup("You must be logged in to enter a raffle.", "Login Required"); return; } const raffleId = event.target.dataset.raffleId; const raffle = allRaffles.find(r => r.id === raffleId); if (!raffle || raffle.status !== 'active' || (raffle.endTime - Date.now() <= 0) ) { showCustomPopup("Raffle is not active or has ended.", "Entry Failed"); await fetchAndDisplayRaffles(); return; } if (playerRaffleEntries[raffle.id]) {  showCustomPopup("You have already entered this raffle.", "Entry Failed"); return; } if (currentPvTokens < raffle.entryCost.pv || currentGold < raffle.entryCost.gold || currentDiamonds < raffle.entryCost.diamonds) { showCustomPopup("Not enough currency to enter this raffle.", "Entry Failed"); return; } const playerProgressRef = doc(db, "playerProgress", currentUser.uid); const raffleEntryRef = doc(db, "raffles", raffleId, "entries", currentUser.uid); const mainRaffleDocRef = doc(db, "raffles", raffleId); try { await runTransaction(db, async (transaction) => { const playerDoc = await transaction.get(playerProgressRef); if (!playerDoc.exists()) throw "Player document does not exist!"; const mainRaffleSnap = await transaction.get(mainRaffleDocRef); if (!mainRaffleSnap.exists()) throw "Raffle document does not exist!"; const currentPlayerData = playerDoc.data(); const currentRaffleData = mainRaffleSnap.data(); if (currentRaffleData.status !== 'active' || (currentRaffleData.endTime.toDate().getTime() - Date.now() <= 0)) throw "Raffle is no longer active."; const newPv = (currentPlayerData.pvTokens || 0) - raffle.entryCost.pv; const newGold = (currentPlayerData.gold || 0) - raffle.entryCost.gold; const newDiamonds = (currentPlayerData.diamonds || 0) - raffle.entryCost.diamonds; if (newPv < 0 || newGold < 0 || newDiamonds < 0) throw "Insufficient funds."; const entryDoc = await transaction.get(raffleEntryRef); if (entryDoc.exists()) throw "Player already entered."; let updatedPlayerRaffleEntries = { ... (currentPlayerData.playerRaffleEntries || {}), [raffleId]: true }; transaction.update(playerProgressRef, { pvTokens: newPv, gold: newGold, diamonds: newDiamonds, playerRaffleEntries: updatedPlayerRaffleEntries }); transaction.set(raffleEntryRef, { timestamp: Timestamp.now(), nickname: userNickname }); transaction.update(mainRaffleDocRef, { entryCount: (currentRaffleData.entryCount || 0) + 1 }); }); currentPvTokens -= raffle.entryCost.pv; currentGold -= raffle.entryCost.gold; currentDiamonds -= raffle.entryCost.diamonds; playerRaffleEntries[raffle.id] = true;  const raffleInClientArray = allRaffles.find(r => r.id === raffleId); if (raffleInClientArray) raffleInClientArray.entryCount = (raffleInClientArray.entryCount || 0) + 1; updateStatsDisplay(); renderWhitelistRaffles(); showCustomPopup(`Successfully entered raffle: ${raffle.name}!`, "Raffle Entry"); if (currentUser.uid) saveGameStateToFirebase(currentUser.uid, getCurrentGameState()); } catch (error) { console.error("Raffle entry transaction failed: ", error); showCustomPopup(`Raffle entry failed: ${error.toString()}`, "Entry Error"); await fetchAndDisplayRaffles(); } }
            async function drawRaffleWinners(raffleId, isDrawingNow = false) { if (!currentUser || !currentUser.email || currentUser.email.toLowerCase() !== 'nvoiysol@gmail.com' || !db) return; const raffleDocRef = doc(db, "raffles", raffleId); try { const raffleDocSnap = await getDoc(raffleDocRef); if (!raffleDocSnap.exists()) { showCustomPopup("Raffle document not found.", "Admin Error"); return false; } const raffleData = raffleDocSnap.data(); if (!isDrawingNow && raffleData.status === 'active' && raffleData.endTime.toDate().getTime() > Date.now()) { showCustomPopup("Raffle not ended yet.", "Admin Action Failed"); return false; } if (raffleData.winners && raffleData.winners.length > 0) { showCustomPopup("Winners already drawn.", "Admin Info"); return false; } await updateDoc(raffleDocRef, { status: 'drawing_winners', endTime: Timestamp.now() }); const localRaffle = allRaffles.find(r => r.id === raffleId); if(localRaffle) { localRaffle.status = 'drawing_winners'; localRaffle.endTime = Date.now(); } renderWhitelistRaffles(); const entriesColRef = collection(db, "raffles", raffleId, "entries"); const entriesSnapshot = await getDocs(entriesColRef); const allEntryNicknames = []; entriesSnapshot.forEach(entryDoc => allEntryNicknames.push(entryDoc.data().nickname || entryDoc.id)); if (allEntryNicknames.length === 0) { await updateDoc(raffleDocRef, { status: 'winners_announced', winners: [] }); if(localRaffle) { localRaffle.status = 'winners_announced'; localRaffle.winners = [];} showCustomPopup(`No entries for ${raffleData.name}.`, "Raffle Result"); renderWhitelistRaffles(); return true; } let potentialWinners = [...new Set(allEntryNicknames)]; const drawnWinners = []; for (let i = 0; i < raffleData.maxWinners && potentialWinners.length > 0; i++) { const winnerIndex = Math.floor(Math.random() * potentialWinners.length); drawnWinners.push(potentialWinners.splice(winnerIndex, 1)[0]); } await updateDoc(raffleDocRef, { winners: drawnWinners, status: 'winners_announced' }); if(localRaffle) { localRaffle.winners = drawnWinners; localRaffle.status = 'winners_announced'; } showCustomPopup(`Winners drawn for ${raffleData.name}!`, "Raffle Result"); renderWhitelistRaffles(); return true; } catch (error) { console.error("Error drawing winners: ", error); showCustomPopup("Failed to draw winners.", "Admin Error"); const localRaffle = allRaffles.find(r => r.id === raffleId); if(localRaffle && localRaffle.status === 'drawing_winners') localRaffle.status = (localRaffle.endTime > Date.now() ? 'active' : 'ended');  renderWhitelistRaffles(); return false; } }
            async function handleDrawWinners(event) { await drawRaffleWinners(event.target.dataset.raffleId, false); }
            async function handleDrawNow(event) { await drawRaffleWinners(event.target.dataset.raffleId, true); }
            async function handleDeleteRaffle(event) { if (!currentUser || !currentUser.email || currentUser.email.toLowerCase() !== 'nvoiysol@gmail.com' || !db) return; const raffleId = event.target.dataset.raffleId; const raffleName = allRaffles.find(r => r.id === raffleId)?.name || "this raffle"; if (confirm(`Are you sure you want to delete "${raffleName}"? This cannot be undone.`)) { const raffleDocRef = doc(db, "raffles", raffleId); try { await deleteDoc(raffleDocRef); showCustomPopup(`Raffle "${raffleName}" deleted.`, "Admin Action"); await fetchAndDisplayRaffles(); } catch (error) { console.error("Error deleting raffle:", error); showCustomPopup("Failed to delete raffle.", "Admin Error"); } } }


            // --- Leaderboard Logic ---
            async function fetchAndDisplayLeaderboards(resourceType = 'pvTokens') {
                if (!db) { console.error("Firestore not initialized for fetching leaderboards."); return; }
                if (!leaderboardDisplayList || !leaderboardCurrentTypeTitle) return;

                leaderboardDisplayList.innerHTML = '<li>Loading...</li>';
                let titleText = 'Leaderboard';
                let scoreClass = '';
                if (resourceType === 'pvTokens') { titleText = 'PV Token Leaders'; scoreClass = 'pv'; }
                else if (resourceType === 'gold') { titleText = 'Gold Leaders'; scoreClass = 'gold'; }
                else if (resourceType === 'diamonds') { titleText = 'Diamond Leaders'; scoreClass = 'diamond'; }
                leaderboardCurrentTypeTitle.textContent = titleText;

                leaderboardFilterButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.resource === resourceType);
                });

                try {
                    const q_leaderboard = query(collection(db, "playerProgress"), orderBy(resourceType, "desc"), limit(50));
                    const querySnapshot = await getDocs(q_leaderboard);
                    
                    leaderboardDisplayList.innerHTML = ''; 
                    let rank = 1;
                    if (querySnapshot.empty) {
                        leaderboardDisplayList.innerHTML = '<li>No players on this leaderboard yet.</li>';
                    }
                    querySnapshot.forEach((docSnap) => {
                        const playerData = docSnap.data();
                        const li = document.createElement('li');
                        li.innerHTML = `<span class="rank">${rank}.</span> <span class="nickname">${playerData.nickname || 'Anonymous'}</span> <span class="score ${scoreClass}">${playerData[resourceType] || 0}</span>`;
                        leaderboardDisplayList.appendChild(li);
                        rank++;
                    });
                } catch (error) {
                    console.error(`Error fetching ${resourceType} leaderboard: `, error);
                    leaderboardDisplayList.innerHTML = `<li>Error loading ${resourceType} leaderboard.</li>`;
                     if (error.message.toLowerCase().includes("index")) { 
                        showCustomPopup(`Leaderboard Error: Firestore index likely missing for '${resourceType}'. Please go to your Firebase console > Firestore Database > Indexes, and create a single-field, descending index for '${resourceType}' on the 'playerProgress' collection.`, "DB Index Error");
                    }
                }
            }
            if (leaderboardFilterButtons) {
                leaderboardFilterButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        fetchAndDisplayLeaderboards(e.target.dataset.resource);
                    });
                });
            }


            // --- Item Upgrade Logic ---
            function updateUpgradeSuccessRateDisplay() {
                if (!upgradeSuccessRateDisplay) return;
                if (!selectedItemForUpgrade || !selectedScrollForUpgrade) {
                    upgradeSuccessRateDisplay.textContent = ""; return;
                }
                
                const itemBaseTier = selectedItemForUpgrade.tier === undefined ? 0 : selectedItemForUpgrade.tier; // Item's intrinsic tier (0-4)
                const scrollTier = selectedScrollForUpgrade.scrollTier; // Scroll's tier (1=Low, 2=Mid, 3=High)
                const itemCurrentLevel = selectedItemForUpgrade.currentLevel || 0; // Item's +X level
                
                let compatibleForLevel = false;
                if (scrollTier === 1 && itemCurrentLevel === 0) compatibleForLevel = true; // Low scroll only for +0 items
                else if (scrollTier === 2 && (itemCurrentLevel >= 0 && itemCurrentLevel <= 2)) compatibleForLevel = true; // Mid scroll for +0, +1, +2 items
                else if (scrollTier === 3 && (itemCurrentLevel >= 0 && itemCurrentLevel <= 4)) compatibleForLevel = true; // High scroll for +0 to +4 items

                if (!compatibleForLevel) { 
                    if (scrollTier === 1 && itemCurrentLevel > 0) {
                        upgradeSuccessRateDisplay.textContent = `Low Class Scrolls can only be used on +0 items. This item is +${itemCurrentLevel}.`;
                    } else {
                        upgradeSuccessRateDisplay.textContent = `This scroll (Tier ${scrollTier}) is not for upgrading an item at +${itemCurrentLevel}.`; 
                    }
                    return; 
                }
                
                if (itemCurrentLevel >= 5) { upgradeSuccessRateDisplay.textContent = "Item is at max level (+5)."; return; }
                
                let successChance = upgradeChances[itemCurrentLevel]; // Base chance for the item's current level
                let bonusText = "";
                if (scrollTier > itemBaseTier) { // Check if scroll tier is higher than item's base tier
                     // Specific tier conditions for bonus:
                    if ((scrollTier === 2 && itemBaseTier <= 1) || // Mid scroll on Tier 0 or 1 item
                        (scrollTier === 3 && itemBaseTier <= 2)) { // High scroll on Tier 0, 1, or 2 item
                        successChance += 0.10;
                        successChance = Math.min(successChance, 1); 
                        bonusText = " (+10% bonus)";
                    }
                }
                upgradeSuccessRateDisplay.textContent = `Upgrade Success Chance: ${(successChance * 100).toFixed(0)}%${bonusText}`;
            }

            function openItemSelectionModal(purpose) { 
                itemSelectionModalList.innerHTML = '';
                itemSelectionModalOverlay.classList.remove('hidden');
                itemSelectionModal.classList.remove('hidden');

                if (purpose === 'item') {
                    itemSelectionModalTitle.textContent = "Select Item to Upgrade";
                    const equippableItemsInInventory = playerInventory.filter(invItem => {
                        const itemMaster = craftableItemsData.find(ci => ci.id === invItem.id);
                        return itemMaster && itemMaster.type !== "Consumable" && itemMaster.type !== "upgrade_scroll_purchase" && itemMaster.type !== "unlockable_consumable" && (invItem.level || 0) < 5; 
                    });
                    if (equippableItemsInInventory.length === 0) { itemSelectionModalList.innerHTML = "<p>No upgradable items (non-max level) in inventory.</p>"; return; }
                    equippableItemsInInventory.forEach(invItem => {
                        const itemMaster = craftableItemsData.find(ci => ci.id === invItem.id);
                        const btn = document.createElement('button'); btn.classList.add('action-button'); btn.style.width = '100%'; btn.style.marginBottom = '5px'; btn.style.display = 'flex'; btn.style.alignItems = 'center';
                        const levelText = (invItem.level || 0) > 0 ? `(+${invItem.level || 0}) ` : '';
                        const itemTierDisplay = itemMaster.tier === undefined ? 0 : itemMaster.tier;
                        btn.innerHTML = `${getItemIconHTML(itemMaster.iconUrlOrColor, itemMaster.type, '20px')} <span style="margin-left: 5px;">${levelText}${itemMaster.name} (Tier ${itemTierDisplay})</span>`;
                        btn.onclick = () => {
                            selectedItemForUpgrade = { ...itemMaster, ...invItem, uniqueInstanceId: invItem.uniqueInstanceId, currentLevel: invItem.level || 0, tier: itemMaster.tier }; // Ensure tier is passed
                            selectedItemForUpgradeDisplay.innerHTML = `Item: ${getItemIconHTML(selectedItemForUpgrade.iconUrlOrColor, selectedItemForUpgrade.type, '30px')} ${levelText}${selectedItemForUpgrade.name}`;
                            closeItemSelectionModal(); updateUpgradeSuccessRateDisplay();
                        };
                        itemSelectionModalList.appendChild(btn);
                    });
                } else if (purpose === 'scroll') {
                    itemSelectionModalTitle.textContent = "Select Upgrade Scroll Type";
                    let hasScrolls = false;
                    Object.keys(scrollData).forEach(scrollTypeKey => { // Iterate using keys from scrollData
                        const count = playerScrolls[scrollTypeKey] || 0;
                        if (count > 0) hasScrolls = true;
                        const scrollMaster = scrollData[scrollTypeKey];
                        const btn = document.createElement('button'); btn.classList.add('action-button'); btn.style.width = '100%'; btn.style.marginBottom = '5px'; btn.style.display = 'flex'; btn.style.alignItems = 'center';
                        btn.innerHTML = `${getItemIconHTML(scrollMaster.icon, 'S', '20px')} <span style="margin-left: 5px;">${scrollMaster.name} (Count: ${count})</span>`;
                        if (count === 0) btn.disabled = true;
                        btn.onclick = () => {
                            if (count > 0) {
                                selectedScrollForUpgrade = { type: scrollTypeKey, name: scrollMaster.name, scrollTier: scrollMaster.tier, iconUrlOrColor: scrollMaster.icon }; 
                                selectedScrollForUpgradeDisplay.innerHTML = `Scroll: ${getItemIconHTML(selectedScrollForUpgrade.iconUrlOrColor, 'S', '30px')} ${selectedScrollForUpgrade.name}`;
                                closeItemSelectionModal(); updateUpgradeSuccessRateDisplay();
                            }
                        };
                        itemSelectionModalList.appendChild(btn);
                    });
                     if (!hasScrolls) { itemSelectionModalList.innerHTML = "<p>No upgrade scrolls available.</p>";}
                }
            }
            function closeItemSelectionModal() { itemSelectionModalOverlay.classList.add('hidden'); itemSelectionModal.classList.add('hidden'); }
            if (upgradeItemSlot) upgradeItemSlot.addEventListener('click', () => openItemSelectionModal('item'));
            if (upgradeScrollSlot) upgradeScrollSlot.addEventListener('click', () => openItemSelectionModal('scroll'));
            if (itemSelectionModalCloseBtn) itemSelectionModalCloseBtn.addEventListener('click', closeItemSelectionModal);
            if (itemSelectionModalOverlay) itemSelectionModalOverlay.addEventListener('click', (event) => { if(event.target === itemSelectionModalOverlay) closeItemSelectionModal(); });

            if (upgradeItemButton) {
                upgradeItemButton.addEventListener('click', () => {
                    if (!currentUser) return;
                    if (!selectedItemForUpgrade || !selectedScrollForUpgrade) { upgradeResultDisplay.textContent = "Please select an item and a scroll."; return; }
                    
                    const itemBaseTier = selectedItemForUpgrade.tier === undefined ? 0 : selectedItemForUpgrade.tier;
                    const scrollTier = selectedScrollForUpgrade.scrollTier;
                    const itemCurrentLevel = selectedItemForUpgrade.currentLevel || 0;

                    let compatibleForLevel = false;
                    if (scrollTier === 1 && itemCurrentLevel === 0) compatibleForLevel = true;
                    else if (scrollTier === 2 && (itemCurrentLevel >= 0 && itemCurrentLevel <= 2)) compatibleForLevel = true;
                    else if (scrollTier === 3 && (itemCurrentLevel >= 0 && itemCurrentLevel <= 4)) compatibleForLevel = true;

                    if (!compatibleForLevel) { 
                        if (scrollTier === 1 && itemCurrentLevel > 0) {
                            upgradeResultDisplay.textContent = `Low Class Scrolls can only be used on +0 items. This item is +${itemCurrentLevel}.`;
                        } else {
                             upgradeResultDisplay.textContent = `This scroll (Tier ${scrollTier}) is not suitable for upgrading an item at +${itemCurrentLevel}.`; 
                        }
                        return; 
                    }
                    
                    if (playerScrolls[selectedScrollForUpgrade.type] <= 0) {
                         upgradeResultDisplay.textContent = `You don't have any ${selectedScrollForUpgrade.name}.`; return;
                    }
                    if (itemCurrentLevel >= 5) { upgradeResultDisplay.textContent = "Item is at max level (+5)."; return; }
                    
                    let successChance = upgradeChances[itemCurrentLevel];
                    if (scrollTier > itemBaseTier) {
                         if ((scrollTier === 2 && itemBaseTier <= 1) || (scrollTier === 3 && itemBaseTier <= 2)) {
                            successChance += 0.10;
                            successChance = Math.min(successChance, 1);
                        }
                    }

                    upgradeResultDisplay.textContent = `Attempting to upgrade ${selectedItemForUpgrade.name} from +${itemCurrentLevel} to +${itemCurrentLevel + 1}. Chance: ${(successChance * 100).toFixed(0)}%...`;
                    upgradeItemButton.disabled = true; 
                    
                    playerScrolls[selectedScrollForUpgrade.type]--; 

                    const originalSlotId = Object.keys(equippedItems).find(slot => equippedItems[slot] === selectedItemForUpgrade.uniqueInstanceId);

                    setTimeout(async () => { 
                        const destroyedItemMasterData = { ...selectedItemForUpgrade }; // Capture for potential re-craft
                        if (Math.random() < successChance) {
                            const itemInvIndex = playerInventory.findIndex(invItem => invItem.uniqueInstanceId === selectedItemForUpgrade.uniqueInstanceId);
                            if (itemInvIndex > -1) {
                                playerInventory[itemInvIndex].level = (playerInventory[itemInvIndex].level || 0) + 1;
                                const updatedItem = playerInventory[itemInvIndex];
                                upgradeResultDisplay.textContent = `SUCCESS! ${selectedItemForUpgrade.name} upgraded to +${updatedItem.level}!`;
                                
                                // Keep item in slot after successful upgrade
                                selectedItemForUpgrade = { ...selectedItemForUpgrade, ...updatedItem, currentLevel: updatedItem.level }; // Update selectedItemForUpgrade with new level
                                const levelText = (updatedItem.level || 0) > 0 ? `(+${updatedItem.level || 0}) ` : '';
                                selectedItemForUpgradeDisplay.innerHTML = `Item: ${getItemIconHTML(selectedItemForUpgrade.iconUrlOrColor, selectedItemForUpgrade.type, '30px')} ${levelText}${selectedItemForUpgrade.name}`;
                                
                                quests.forEach(q => { 
                                    if (q.metric === "itemUpgradedToPlus2" && updatedItem.level >= 2 && !q.completed && !q.claimed) { q.progress = 1; q.completed = true; if(!q.claimed) showCustomPopup(`Quest Completed: ${q.text}`, "Quest Complete!");} 
                                    if (q.metric === "itemUpgradedToPlus3" && updatedItem.level >= 3 && !q.completed && !q.claimed) { q.progress = 1; q.completed = true; if(!q.claimed) showCustomPopup(`Quest Completed: ${q.text}`, "Quest Complete!");} 
                                });
                                if(document.getElementById('quests-page').classList.contains('active')) renderQuests();
                            } else { upgradeResultDisplay.textContent = "Error: Item vanished post-scroll consumption."; }
                        } else {
                            const itemInvIndex = playerInventory.findIndex(invItem => invItem.uniqueInstanceId === selectedItemForUpgrade.uniqueInstanceId);
                            if (itemInvIndex > -1) {
                                if (originalSlotId) { equippedItems[originalSlotId] = null; } 
                                playerInventory.splice(itemInvIndex, 1); 
                                upgradeResultDisplay.textContent = `FAILURE! ${destroyedItemMasterData.name} +${itemCurrentLevel} was destroyed.`;
                                promptToCraftAgain(destroyedItemMasterData, originalSlotId);
                            } else { upgradeResultDisplay.textContent = "Error: Failed item not found for destruction."; }
                            selectedItemForUpgrade = null; // Clear item slot on failure
                            selectedItemForUpgradeDisplay.innerHTML = `Item: None`;
                        }
                        
                        selectedScrollForUpgrade = null; // Always clear scroll slot
                        selectedScrollForUpgradeDisplay.innerHTML = `Scroll: None`;
                        updateUpgradeSuccessRateDisplay(); renderInventory(); renderCraftingItems(); renderMaterials();
                        upgradeItemButton.disabled = false;
                        if (currentUser.uid) saveGameStateToFirebase(currentUser.uid, getCurrentGameState());
                    }, 1000);
                });
            }


            // --- Final Initializations ---
            initializeTheme(); 
            setInterval(updateTimers, 1000);
            document.querySelectorAll('.adventure-num-select').forEach(select => { select.value = "5"; });
            
            const connectWalletBtn = document.getElementById('connectWalletBtn'); const walletDropdown = document.getElementById('walletDropdown'); const walletOptions = walletDropdown.querySelectorAll('li'); const walletAddressDisplay = document.getElementById('walletAddressDisplay');
            let connectedAccount = null; let connectedWalletName = null;
            function updateWalletDisplay(account, walletName = '') { if (account) { const shortAddress = `${account.substring(0, 6)}...${account.substring(account.length - 4)}`; if(connectWalletBtn) { connectWalletBtn.textContent = `${walletName}: ${shortAddress}`; connectWalletBtn.classList.add('connected'); } if(walletAddressDisplay) walletAddressDisplay.textContent = `Wallet: ${account}`; } else { if(connectWalletBtn) { connectWalletBtn.textContent = 'CONNECT WALLET'; connectWalletBtn.classList.remove('connected'); } if(walletAddressDisplay) walletAddressDisplay.textContent = ''; } }
            if(connectWalletBtn && walletDropdown) { connectWalletBtn.addEventListener('click', (event) => { event.stopPropagation(); walletDropdown.style.display = walletDropdown.style.display === 'block' ? 'none' : 'block'; }); document.addEventListener('click', (event) => { if (walletDropdown && connectWalletBtn && !connectWalletBtn.contains(event.target) && !walletDropdown.contains(event.target)) { walletDropdown.style.display = 'none'; } }); }
            async function connectWithSatsConnect(walletTypeHint = null) { if (typeof SatsConnect === 'undefined' || typeof SatsConnect.getAddresses === 'undefined') { showCustomPopup('Sats Connect library not loaded or not ready.', "Wallet Error"); return; } try { SatsConnect.getAddresses({ payload: { purposes: ['ordinals', 'payment'], message: 'Connect to Punk Voyage Adventures', network: { type: 'Mainnet' }, }, onFinish: (response) => { const ordAddress = response.addresses.find(a => a.purpose === 'ordinals'); const payAddress = response.addresses.find(a => a.purpose === 'payment'); let addr = ordAddress ? ordAddress.address : (payAddress ? payAddress.address : null); if (addr) { connectedAccount = addr; let name = walletTypeHint ? walletTypeHint.replace('satsconnect_', '').toUpperCase() : "BTC"; if (name === "GENERAL") name = "BTC"; connectedWalletName = name; updateWalletDisplay(connectedAccount, connectedWalletName); } }, onCancel: () => console.log('SatsConnect canceled.'), }); } catch (e) { console.error('SatsConnect error:', e); showCustomPopup('An error occurred with SatsConnect.', 'Wallet Error');} }
            async function connectUnisat() { try { if (typeof window.unisat !== 'undefined') { const accounts = await window.unisat.requestAccounts(); if (accounts && accounts.length > 0) { connectedAccount = accounts[0]; connectedWalletName = 'UniSat'; updateWalletDisplay(connectedAccount, 'UniSat'); window.unisat.on('accountsChanged', (newAccs) => { if (connectedWalletName === 'UniSat') { connectedAccount = (newAccs && newAccs.length > 0) ? newAccs[0] : null; if (!connectedAccount) connectedWalletName = null; updateWalletDisplay(connectedAccount, connectedAccount ? 'UniSat' : ''); } }); } } else { window.open('https://unisat.io/', '_blank'); } } catch (e) { console.error('UniSat error:', e); showCustomPopup('An error occurred with UniSat Wallet.', 'Wallet Error'); } }
            if (walletOptions) { walletOptions.forEach(option => { option.addEventListener('click', async (event) => { const walletType = event.target.dataset.wallet; if(walletDropdown) walletDropdown.style.display = 'none'; connectedAccount = null; connectedWalletName = null; updateWalletDisplay(null); if (walletType === 'unisat') await connectUnisat(); else if (walletType && walletType.startsWith('satsconnect_')) { await connectWithSatsConnect(walletType.split('_')[1]); } }); }); }

        }); // End of 'firebaseReady' event listener
    </script>
</body>
</html>
```
arrow_split
See original conversation
iph